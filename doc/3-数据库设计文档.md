# æ•°æ®åº“è®¾è®¡æ–‡æ¡£

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

- **é¡¹ç›®åç§°**ï¼šä¼ä¸šçº§AIç»¼åˆç®¡ç†å¹³å°
- **æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
- **åˆ›å»ºæ—¥æœŸ**ï¼š2026-01-13
- **æ–‡æ¡£ç±»å‹**ï¼šæ•°æ®åº“è®¾è®¡æ–‡æ¡£

---

## 1. æ•°æ®åº“é€‰å‹è¯´æ˜

### 1.1 ä¸»æ•°æ®åº“ï¼šMySQL

**é€‰å‹ç†ç”±**ï¼š
- âœ… æˆç†Ÿç¨³å®šï¼Œå¹¿æ³›ä½¿ç”¨
- âœ… æ€§èƒ½ä¼˜ç§€ï¼Œæ”¯æŒé«˜å¹¶å‘
- âœ… ç”Ÿæ€å®Œå–„ï¼Œå·¥å…·ä¸°å¯Œ
- âœ… æ”¯æŒäº‹åŠ¡ã€ç´¢å¼•ã€å­˜å‚¨è¿‡ç¨‹
- âœ… å¼€æºå…è´¹ï¼Œæˆæœ¬ä½

**ç‰ˆæœ¬è¦æ±‚**ï¼šMySQL 8.0+

### 1.2 å¯é€‰æ•°æ®åº“

| æ•°æ®åº“ | ç‰ˆæœ¬ | ç”¨é€” | é€‰å‹ç†ç”± |
|-------|------|------|---------|
| **PostgreSQL** | 15+ | å¤šæ•°æ®æºæ”¯æŒ | åŠŸèƒ½å¼ºå¤§ã€æ”¯æŒå¤æ‚æŸ¥è¯¢ã€å¼€æº |
| **Oracle** | 19c+ | å¤šæ•°æ®æºæ”¯æŒ | ä¼ä¸šçº§ã€åŠŸèƒ½å¼ºå¤§ã€é€‚åˆå¤§å‹ä¼ä¸š |

---

## 2. ERå›¾è®¾è®¡

```mermaid
erDiagram
    TENANT ||--o{ USER : contains
    TENANT ||--o{ DEPARTMENT : contains
    TENANT ||--o{ ROLE : contains
    TENANT ||--o{ MENU : contains
    TENANT ||--o{ MCP_TOOL : contains
    
    DEPARTMENT ||--o{ USER : belongs_to
    DEPARTMENT ||--o{ DEPARTMENT : parent_of
    
    USER ||--o{ USER_ROLE : has
    ROLE ||--o{ USER_ROLE : assigned_to
    
    ROLE ||--o{ ROLE_PERMISSION : has
    PERMISSION ||--o{ ROLE_PERMISSION : assigned_to
    
    ROLE ||--o{ ROLE_MENU : has
    MENU ||--o{ ROLE_MENU : assigned_to
    
    MCP_TOOL ||--o{ MCP_TOOL_CALL_LOG : generates
    
    USER ||--o{ LOGIN_LOG : generates
    USER ||--o{ OPERATION_LOG : generates
    
    TENANT ||--o{ TENANT_PACKAGE : has
    TENANT_PACKAGE ||--o{ PACKAGE_MENU : contains
    TENANT_PACKAGE ||--o{ PACKAGE_OPERATION : contains
    
    DICT ||--o{ DICT_ITEM : contains
    
    API_ENDPOINT ||--o| MCP_TOOL : registered_as
    
    NOTIFICATION ||--o{ NOTIFICATION_READ : read_by
    
    TENANT {
        string id PK
        string name
        string code
        string status
        datetime created_at
        datetime updated_at
    }
    
    USER {
        string id PK
        string tenant_id FK
        string username
        string password
        string email
        string phone
        string dept_id FK
        string position_id FK
        string status
        datetime created_at
        datetime updated_at
    }
    
    DEPARTMENT {
        string id PK
        string tenant_id FK
        string name
        string code
        string parent_id FK
        int level
        string status
        datetime created_at
        datetime updated_at
    }
    
    ROLE {
        string id PK
        string tenant_id FK
        string name
        string code
        string description
        string status
        datetime created_at
        datetime updated_at
    }
    
    PERMISSION {
        string id PK
        string name
        string code
        string type
        string description
        datetime created_at
        datetime updated_at
    }
    
    MENU {
        string id PK
        string tenant_id FK
        string name
        string path
        string icon
        string parent_id FK
        int sort_order
        string status
        datetime created_at
        datetime updated_at
    }
    
    MCP_TOOL {
        string id PK
        string tenant_id FK
        string name
        string description
        string api_path
        string api_method
        string tool_type
        string auth_type
        int timeout
        int max_retries
        string status
        int call_count
        int success_count
        int failure_count
        int avg_response_time
        datetime created_at
        datetime updated_at
    }
    
    MCP_TOOL_CALL_LOG {
        string id PK
        string tool_id FK
        string caller_id
        string caller_type
        string tenant_id FK
        json request_params
        int response_status
        json response_data
        int response_time
        string error_message
        datetime created_at
    }
    
    LOGIN_LOG {
        string id PK
        string user_id FK
        string tenant_id FK
        string ip_address
        string user_agent
        string login_status
        string error_message
        datetime created_at
    }
    
    OPERATION_LOG {
        string id PK
        string user_id FK
        string tenant_id FK
        string module
        string operation
        string method
        string path
        json request_params
        json response_data
        int response_status
        int response_time
        datetime created_at
    }
    
    TENANT_PACKAGE {
        string id PK
        string tenant_id FK
        string name
        string description
        json features
        string status
        datetime created_at
        datetime updated_at
    }
    
    DICT {
        string id PK
        string tenant_id FK
        string type
        string name
        string description
        string status
        datetime created_at
        datetime updated_at
    }
    
    DICT_ITEM {
        string id PK
        string dict_id FK
        string label
        string value
        int sort_order
        string status
        datetime created_at
        datetime updated_at
    }
    
    API_ENDPOINT {
        string id PK
        string path
        string method
        string module
        string description
        boolean is_mcp_tool
        int mcp_tool_id FK
        json required_scopes
        boolean is_enabled
        datetime created_at
        datetime updated_at
    }
    
    NOTIFICATION {
        string id PK
        string tenant_id FK
        string type
        string title
        string content
        string sender_id
        json receiver_ids
        string status
        datetime created_at
        datetime updated_at
    }
```

---

## 3. è¡¨ç»“æ„è®¾è®¡

### 3.1 ç§Ÿæˆ·è¡¨ï¼ˆtenantsï¼‰

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å…è®¸ç©º | é»˜è®¤å€¼ | è¯´æ˜ |
|-------|------|------|--------|--------|------|
| id | VARCHAR | 50 | NO | - | ç§Ÿæˆ·IDï¼ˆä¸»é”®ï¼‰ |
| name | VARCHAR | 100 | NO | - | ç§Ÿæˆ·åç§° |
| code | VARCHAR | 50 | NO | - | ç§Ÿæˆ·ç¼–ç ï¼ˆå”¯ä¸€ï¼‰ |
| status | VARCHAR | 20 | NO | active | çŠ¶æ€ï¼ˆactive/inactiveï¼‰ |
| description | TEXT | - | YES | NULL | æè¿° |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY (id)
- UNIQUE KEY uk_code (code)
- INDEX idx_status (status)

### 3.2 ç”¨æˆ·è¡¨ï¼ˆusersï¼‰

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å…è®¸ç©º | é»˜è®¤å€¼ | è¯´æ˜ |
|-------|------|------|--------|--------|------|
| id | VARCHAR | 50 | NO | - | ç”¨æˆ·IDï¼ˆä¸»é”®ï¼‰ |
| tenant_id | VARCHAR | 50 | NO | - | ç§Ÿæˆ·IDï¼ˆå¤–é”®ï¼‰ |
| username | VARCHAR | 50 | NO | - | ç”¨æˆ·åï¼ˆå”¯ä¸€ï¼‰ |
| password | VARCHAR | 255 | NO | - | å¯†ç ï¼ˆåŠ å¯†ï¼‰ |
| email | VARCHAR | 100 | YES | NULL | é‚®ç®± |
| phone | VARCHAR | 20 | YES | NULL | æ‰‹æœºå· |
| dept_id | VARCHAR | 50 | YES | NULL | éƒ¨é—¨IDï¼ˆå¤–é”®ï¼‰ |
| position_id | VARCHAR | 50 | YES | NULL | å²—ä½IDï¼ˆå¤–é”®ï¼‰ |
| status | VARCHAR | 20 | NO | active | çŠ¶æ€ï¼ˆactive/inactive/lockedï¼‰ |
| last_login_at | DATETIME | - | YES | NULL | æœ€åç™»å½•æ—¶é—´ |
| last_login_ip | VARCHAR | 50 | YES | NULL | æœ€åç™»å½•IP |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY (id)
- UNIQUE KEY uk_tenant_username (tenant_id, username)
- INDEX idx_tenant_id (tenant_id)
- INDEX idx_dept_id (dept_id)
- INDEX idx_status (status)

**å¤–é”®**ï¼š
- FOREIGN KEY (tenant_id) REFERENCES tenants(id)
- FOREIGN KEY (dept_id) REFERENCES departments(id)

### 3.3 éƒ¨é—¨è¡¨ï¼ˆdepartmentsï¼‰

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å…è®¸ç©º | é»˜è®¤å€¼ | è¯´æ˜ |
|-------|------|------|--------|--------|------|
| id | VARCHAR | 50 | NO | - | éƒ¨é—¨IDï¼ˆä¸»é”®ï¼‰ |
| tenant_id | VARCHAR | 50 | NO | - | ç§Ÿæˆ·IDï¼ˆå¤–é”®ï¼‰ |
| name | VARCHAR | 100 | NO | - | éƒ¨é—¨åç§° |
| code | VARCHAR | 100 | NO | - | éƒ¨é—¨ç¼–ç ï¼ˆå¦‚dept001/child002ï¼‰ |
| parent_id | VARCHAR | 50 | YES | NULL | çˆ¶éƒ¨é—¨IDï¼ˆå¤–é”®ï¼‰ |
| level | INT | - | NO | 1 | å±‚çº§ï¼ˆ1-5ï¼‰ |
| sort_order | INT | - | NO | 0 | æ’åº |
| status | VARCHAR | 20 | NO | active | çŠ¶æ€ï¼ˆactive/inactiveï¼‰ |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY (id)
- UNIQUE KEY uk_tenant_code (tenant_id, code)
- INDEX idx_tenant_id (tenant_id)
- INDEX idx_parent_id (parent_id)
- INDEX idx_level (level)

**å¤–é”®**ï¼š
- FOREIGN KEY (tenant_id) REFERENCES tenants(id)
- FOREIGN KEY (parent_id) REFERENCES departments(id)

### 3.4 è§’è‰²è¡¨ï¼ˆrolesï¼‰

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å…è®¸ç©º | é»˜è®¤å€¼ | è¯´æ˜ |
|-------|------|------|--------|--------|------|
| id | VARCHAR | 50 | NO | - | è§’è‰²IDï¼ˆä¸»é”®ï¼‰ |
| tenant_id | VARCHAR | 50 | NO | - | ç§Ÿæˆ·IDï¼ˆå¤–é”®ï¼‰ |
| name | VARCHAR | 100 | NO | - | è§’è‰²åç§° |
| code | VARCHAR | 50 | NO | - | è§’è‰²ç¼–ç ï¼ˆå”¯ä¸€ï¼‰ |
| description | TEXT | - | YES | NULL | æè¿° |
| is_system | BOOLEAN | - | NO | FALSE | æ˜¯å¦ç³»ç»Ÿè§’è‰² |
| status | VARCHAR | 20 | NO | active | çŠ¶æ€ï¼ˆactive/inactiveï¼‰ |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY (id)
- UNIQUE KEY uk_tenant_code (tenant_id, code)
- INDEX idx_tenant_id (tenant_id)
- INDEX idx_is_system (is_system)

**å¤–é”®**ï¼š
- FOREIGN KEY (tenant_id) REFERENCES tenants(id)

### 3.5 æƒé™è¡¨ï¼ˆpermissionsï¼‰

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å…è®¸ç©º | é»˜è®¤å€¼ | è¯´æ˜ |
|-------|------|------|--------|--------|------|
| id | VARCHAR | 50 | NO | - | æƒé™IDï¼ˆä¸»é”®ï¼‰ |
| name | VARCHAR | 100 | NO | - | æƒé™åç§° |
| code | VARCHAR | 100 | NO | - | æƒé™ç¼–ç ï¼ˆå¦‚user:createï¼‰ |
| type | VARCHAR | 20 | NO | - | ç±»å‹ï¼ˆmenu/operation/buttonï¼‰ |
| description | TEXT | - | YES | NULL | æè¿° |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY (id)
- UNIQUE KEY uk_code (code)
- INDEX idx_type (type)

### 3.6 èœå•è¡¨ï¼ˆmenusï¼‰

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å…è®¸ç©º | é»˜è®¤å€¼ | è¯´æ˜ |
|-------|------|------|--------|--------|------|
| id | VARCHAR | 50 | NO | - | èœå•IDï¼ˆä¸»é”®ï¼‰ |
| tenant_id | VARCHAR | 50 | NO | - | ç§Ÿæˆ·IDï¼ˆå¤–é”®ï¼‰ |
| name | VARCHAR | 100 | NO | - | èœå•åç§° |
| path | VARCHAR | 255 | YES | NULL | èœå•è·¯å¾„ |
| icon | VARCHAR | 100 | YES | NULL | èœå•å›¾æ ‡ |
| parent_id | VARCHAR | 50 | YES | NULL | çˆ¶èœå•IDï¼ˆå¤–é”®ï¼‰ |
| sort_order | INT | - | NO | 0 | æ’åº |
| is_visible | BOOLEAN | - | NO | TRUE | æ˜¯å¦å¯è§ |
| status | VARCHAR | 20 | NO | active | çŠ¶æ€ï¼ˆactive/inactiveï¼‰ |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY (id)
- INDEX idx_tenant_id (tenant_id)
- INDEX idx_parent_id (parent_id)
- INDEX idx_sort_order (sort_order)

**å¤–é”®**ï¼š
- FOREIGN KEY (tenant_id) REFERENCES tenants(id)
- FOREIGN KEY (parent_id) REFERENCES menus(id)

### 3.7 MCPå·¥å…·è¡¨ï¼ˆmcp_toolsï¼‰

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å…è®¸ç©º | é»˜è®¤å€¼ | è¯´æ˜ |
|-------|------|------|--------|--------|------|
| id | INT | - | NO | AUTO_INCREMENT | å·¥å…·IDï¼ˆä¸»é”®ï¼‰ |
| tenant_id | VARCHAR | 50 | NO | - | ç§Ÿæˆ·IDï¼ˆå¤–é”®ï¼‰ |
| name | VARCHAR | 100 | NO | - | å·¥å…·åç§° |
| description | TEXT | - | YES | NULL | å·¥å…·æè¿° |
| api_path | VARCHAR | 255 | NO | - | APIè·¯å¾„ |
| api_method | VARCHAR | 10 | NO | - | APIæ–¹æ³•ï¼ˆGET/POST/PUT/DELETEï¼‰ |
| api_module | VARCHAR | 100 | YES | NULL | APIæ‰€å±æ¨¡å— |
| tool_type | VARCHAR | 50 | YES | NULL | å·¥å…·ç±»å‹ï¼ˆapi/external/scriptï¼‰ |
| external_url | VARCHAR | 500 | YES | NULL | å¤–éƒ¨URL |
| auth_type | VARCHAR | 50 | YES | NULL | é‰´æƒæ–¹å¼ï¼ˆnone/bearer/api_key/oauthï¼‰ |
| auth_config | JSON | - | YES | NULL | é‰´æƒé…ç½® |
| timeout | INT | - | NO | 30 | è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ |
| max_retries | INT | - | NO | 3 | æœ€å¤§é‡è¯•æ¬¡æ•° |
| is_enabled | BOOLEAN | - | NO | TRUE | æ˜¯å¦å¯ç”¨ |
| is_public | BOOLEAN | - | NO | FALSE | æ˜¯å¦å…¬å¼€ |
| call_count | INT | - | NO | 0 | è°ƒç”¨æ¬¡æ•° |
| success_count | INT | - | NO | 0 | æˆåŠŸæ¬¡æ•° |
| failure_count | INT | - | NO | 0 | å¤±è´¥æ¬¡æ•° |
| avg_response_time | INT | - | NO | 0 | å¹³å‡å“åº”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY (id)
- INDEX idx_tenant_id (tenant_id)
- INDEX idx_api_path (api_path, api_method)
- INDEX idx_is_enabled (is_enabled)

**å¤–é”®**ï¼š
- FOREIGN KEY (tenant_id) REFERENCES tenants(id)

### 3.8 MCPå·¥å…·è°ƒç”¨æ—¥å¿—è¡¨ï¼ˆmcp_tool_call_logsï¼‰

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å…è®¸ç©º | é»˜è®¤å€¼ | è¯´æ˜ |
|-------|------|------|--------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | æ—¥å¿—IDï¼ˆä¸»é”®ï¼‰ |
| tool_id | INT | - | NO | - | å·¥å…·IDï¼ˆå¤–é”®ï¼‰ |
| caller_id | VARCHAR | 50 | NO | - | è°ƒç”¨è€…ID |
| caller_type | VARCHAR | 20 | NO | - | è°ƒç”¨è€…ç±»å‹ï¼ˆuser/api_keyï¼‰ |
| tenant_id | VARCHAR | 50 | NO | - | ç§Ÿæˆ·IDï¼ˆå¤–é”®ï¼‰ |
| request_params | JSON | - | YES | NULL | è¯·æ±‚å‚æ•° |
| request_headers | JSON | - | YES | NULL | è¯·æ±‚å¤´ |
| response_status | INT | - | YES | NULL | å“åº”çŠ¶æ€ç  |
| response_data | JSON | - | YES | NULL | å“åº”æ•°æ® |
| response_time | INT | - | YES | NULL | å“åº”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ |
| error_message | TEXT | - | YES | NULL | é”™è¯¯ä¿¡æ¯ |
| error_stack | TEXT | - | YES | NULL | é”™è¯¯å †æ ˆ |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | è°ƒç”¨æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY (id)
- INDEX idx_tool_id (tool_id)
- INDEX idx_caller_id (caller_id)
- INDEX idx_tenant_id (tenant_id)
- INDEX idx_created_at (created_at)

**å¤–é”®**ï¼š
- FOREIGN KEY (tool_id) REFERENCES mcp_tools(id)

### 3.9 ç™»å½•æ—¥å¿—è¡¨ï¼ˆlogin_logsï¼‰

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å…è®¸ç©º | é»˜è®¤å€¼ | è¯´æ˜ |
|-------|------|------|--------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | æ—¥å¿—IDï¼ˆä¸»é”®ï¼‰ |
| user_id | VARCHAR | 50 | NO | - | ç”¨æˆ·IDï¼ˆå¤–é”®ï¼‰ |
| tenant_id | VARCHAR | 50 | NO | - | ç§Ÿæˆ·IDï¼ˆå¤–é”®ï¼‰ |
| ip_address | VARCHAR | 50 | NO | - | IPåœ°å€ |
| user_agent | VARCHAR | 500 | YES | NULL | ç”¨æˆ·ä»£ç† |
| login_status | VARCHAR | 20 | NO | - | ç™»å½•çŠ¶æ€ï¼ˆsuccess/failedï¼‰ |
| error_message | TEXT | - | YES | NULL | é”™è¯¯ä¿¡æ¯ |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | ç™»å½•æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY (id)
- INDEX idx_user_id (user_id)
- INDEX idx_tenant_id (tenant_id)
- INDEX idx_ip_address (ip_address)
- INDEX idx_created_at (created_at)

**å¤–é”®**ï¼š
- FOREIGN KEY (user_id) REFERENCES users(id)
- FOREIGN KEY (tenant_id) REFERENCES tenants(id)

### 3.10 æ“ä½œæ—¥å¿—è¡¨ï¼ˆoperation_logsï¼‰

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å…è®¸ç©º | é»˜è®¤å€¼ | è¯´æ˜ |
|-------|------|------|--------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | æ—¥å¿—IDï¼ˆä¸»é”®ï¼‰ |
| user_id | VARCHAR | 50 | NO | - | ç”¨æˆ·IDï¼ˆå¤–é”®ï¼‰ |
| tenant_id | VARCHAR | 50 | NO | - | ç§Ÿæˆ·IDï¼ˆå¤–é”®ï¼‰ |
| module | VARCHAR | 50 | NO | - | æ¨¡å— |
| operation | VARCHAR | 50 | NO | - | æ“ä½œ |
| method | VARCHAR | 10 | NO | - | è¯·æ±‚æ–¹æ³• |
| path | VARCHAR | 255 | NO | - | è¯·æ±‚è·¯å¾„ |
| request_params | JSON | - | YES | NULL | è¯·æ±‚å‚æ•° |
| response_data | JSON | - | YES | NULL | å“åº”æ•°æ® |
| response_status | INT | - | NO | - | å“åº”çŠ¶æ€ç  |
| response_time | INT | - | YES | NULL | å“åº”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | æ“ä½œæ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY (id)
- INDEX idx_user_id (user_id)
- INDEX idx_tenant_id (tenant_id)
- INDEX idx_module (module)
- INDEX idx_created_at (created_at)

**å¤–é”®**ï¼š
- FOREIGN KEY (user_id) REFERENCES users(id)
- FOREIGN KEY (tenant_id) REFERENCES tenants(id)

### 3.11 å­—å…¸è¡¨ï¼ˆdictsï¼‰

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å…è®¸ç©º | é»˜è®¤å€¼ | è¯´æ˜ |
|-------|------|------|--------|--------|------|
| id | VARCHAR | 50 | NO | - | å­—å…¸IDï¼ˆä¸»é”®ï¼‰ |
| tenant_id | VARCHAR | 50 | NO | - | ç§Ÿæˆ·IDï¼ˆå¤–é”®ï¼‰ |
| type | VARCHAR | 50 | NO | - | å­—å…¸ç±»å‹ |
| name | VARCHAR | 100 | NO | - | å­—å…¸åç§° |
| description | TEXT | - | YES | NULL | æè¿° |
| status | VARCHAR | 20 | NO | active | çŠ¶æ€ï¼ˆactive/inactiveï¼‰ |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY (id)
- UNIQUE KEY uk_tenant_type (tenant_id, type)
- INDEX idx_tenant_id (tenant_id)

**å¤–é”®**ï¼š
- FOREIGN KEY (tenant_id) REFERENCES tenants(id)

### 3.12 å­—å…¸é¡¹è¡¨ï¼ˆdict_itemsï¼‰

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å…è®¸ç©º | é»˜è®¤å€¼ | è¯´æ˜ |
|-------|------|------|--------|--------|------|
| id | VARCHAR | 50 | NO | - | å­—å…¸é¡¹IDï¼ˆä¸»é”®ï¼‰ |
| dict_id | VARCHAR | 50 | NO | - | å­—å…¸IDï¼ˆå¤–é”®ï¼‰ |
| label | VARCHAR | 100 | NO | - | æ ‡ç­¾ |
| value | VARCHAR | 100 | NO | - | å€¼ |
| sort_order | INT | - | NO | 0 | æ’åº |
| status | VARCHAR | 20 | NO | active | çŠ¶æ€ï¼ˆactive/inactiveï¼‰ |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY (id)
- INDEX idx_dict_id (dict_id)
- INDEX idx_sort_order (sort_order)

**å¤–é”®**ï¼š
- FOREIGN KEY (dict_id) REFERENCES dicts(id)

### 3.13 APIç«¯ç‚¹è¡¨ï¼ˆapi_endpointsï¼‰

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å…è®¸ç©º | é»˜è®¤å€¼ | è¯´æ˜ |
|-------|------|------|--------|--------|------|
| id | INT | - | NO | AUTO_INCREMENT | ç«¯ç‚¹IDï¼ˆä¸»é”®ï¼‰ |
| path | VARCHAR | 255 | NO | - | APIè·¯å¾„ |
| method | VARCHAR | 10 | NO | - | APIæ–¹æ³• |
| module | VARCHAR | 100 | YES | NULL | æ‰€å±æ¨¡å— |
| description | TEXT | - | YES | NULL | æ¥å£æè¿° |
| is_mcp_tool | BOOLEAN | - | NO | FALSE | æ˜¯å¦æ³¨å†Œä¸ºMCPå·¥å…· |
| mcp_tool_id | INT | - | YES | NULL | å…³è”çš„MCPå·¥å…·ID |
| required_scopes | JSON | - | YES | NULL | æ‰€éœ€æƒé™scopes |
| is_enabled | BOOLEAN | - | NO | TRUE | æ˜¯å¦å¯ç”¨ |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY (id)
- UNIQUE KEY uk_path_method (path, method)
- INDEX idx_module (module)

**å¤–é”®**ï¼š
- FOREIGN KEY (mcp_tool_id) REFERENCES mcp_tools(id)

### 3.14 é€šçŸ¥è¡¨ï¼ˆnotificationsï¼‰

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å…è®¸ç©º | é»˜è®¤å€¼ | è¯´æ˜ |
|-------|------|------|--------|--------|------|
| id | VARCHAR | 50 | NO | - | é€šçŸ¥IDï¼ˆä¸»é”®ï¼‰ |
| tenant_id | VARCHAR | 50 | NO | - | ç§Ÿæˆ·IDï¼ˆå¤–é”®ï¼‰ |
| type | VARCHAR | 50 | NO | - | é€šçŸ¥ç±»å‹ |
| title | VARCHAR | 200 | NO | - | é€šçŸ¥æ ‡é¢˜ |
| content | TEXT | - | NO | - | é€šçŸ¥å†…å®¹ |
| sender_id | VARCHAR | 50 | YES | NULL | å‘é€è€…ID |
| receiver_ids | JSON | - | NO | - | æ¥æ”¶è€…IDåˆ—è¡¨ |
| status | VARCHAR | 20 | NO | active | çŠ¶æ€ï¼ˆactive/archivedï¼‰ |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY (id)
- INDEX idx_tenant_id (tenant_id)
- INDEX idx_type (type)
- INDEX idx_created_at (created_at)

**å¤–é”®**ï¼š
- FOREIGN KEY (tenant_id) REFERENCES tenants(id)

### 3.15 å¾…åŠä»»åŠ¡è¡¨ï¼ˆtodo_tasksï¼‰

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å…è®¸ç©º | é»˜è®¤å€¼ | è¯´æ˜ |
|-------|------|------|--------|--------|------|
| id | VARCHAR | 50 | NO | - | ä»»åŠ¡IDï¼ˆä¸»é”®ï¼‰ |
| tenant_id | VARCHAR | 50 | NO | - | ç§Ÿæˆ·IDï¼ˆå¤–é”®ï¼‰ |
| user_id | VARCHAR | 50 | NO | - | ç”¨æˆ·IDï¼ˆå¤–é”®ï¼‰ |
| task_type | VARCHAR | 20 | NO | - | ä»»åŠ¡ç±»å‹ï¼ˆpersonal/daily/workflowï¼‰ |
| title | VARCHAR | 200 | NO | - | ä»»åŠ¡æ ‡é¢˜ |
| description | TEXT | - | YES | NULL | ä»»åŠ¡æè¿° |
| priority | VARCHAR | 20 | NO | medium | ä¼˜å…ˆçº§ï¼ˆhigh/medium/lowï¼‰ |
| status | VARCHAR | 20 | NO | pending | çŠ¶æ€ï¼ˆpending/in_progress/completed/cancelledï¼‰ |
| due_date | DATETIME | - | YES | NULL | æˆªæ­¢æ—¶é—´ |
| completed_at | DATETIME | - | YES | NULL | å®Œæˆæ—¶é—´ |
| tags | JSON | - | YES | NULL | æ ‡ç­¾åˆ—è¡¨ |
| attachments | JSON | - | YES | NULL | é™„ä»¶åˆ—è¡¨ |
| workflow_instance_id | VARCHAR | 50 | YES | NULL | å·¥ä½œæµå®ä¾‹IDï¼ˆå¤–é”®ï¼Œå·¥ä½œæµä»»åŠ¡æ—¶ä½¿ç”¨ï¼‰ |
| workflow_task_id | VARCHAR | 50 | YES | NULL | å·¥ä½œæµä»»åŠ¡IDï¼ˆå¤–é”®ï¼Œå·¥ä½œæµä»»åŠ¡æ—¶ä½¿ç”¨ï¼‰ |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY (id)
- INDEX idx_tenant_id (tenant_id)
- INDEX idx_user_id (user_id)
- INDEX idx_task_type (task_type)
- INDEX idx_status (status)
- INDEX idx_due_date (due_date)
- INDEX idx_workflow_instance_id (workflow_instance_id)

**å¤–é”®**ï¼š
- FOREIGN KEY (tenant_id) REFERENCES tenants(id)
- FOREIGN KEY (user_id) REFERENCES users(id)
- FOREIGN KEY (workflow_instance_id) REFERENCES workflow_instances(id)
- FOREIGN KEY (workflow_task_id) REFERENCES workflow_tasks(id)

### 3.16 æ¯æ—¥è®¡åˆ’è¡¨ï¼ˆdaily_plansï¼‰

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å…è®¸ç©º | é»˜è®¤å€¼ | è¯´æ˜ |
|-------|------|------|--------|--------|------|
| id | VARCHAR | 50 | NO | - | è®¡åˆ’IDï¼ˆä¸»é”®ï¼‰ |
| tenant_id | VARCHAR | 50 | NO | - | ç§Ÿæˆ·IDï¼ˆå¤–é”®ï¼‰ |
| user_id | VARCHAR | 50 | NO | - | ç”¨æˆ·IDï¼ˆå¤–é”®ï¼‰ |
| plan_date | DATE | - | NO | - | è®¡åˆ’æ—¥æœŸ |
| total_tasks | INT | - | NO | 0 | æ€»ä»»åŠ¡æ•° |
| completed_tasks | INT | - | NO | 0 | å·²å®Œæˆä»»åŠ¡æ•° |
| completion_rate | DECIMAL | 5,2 | NO | 0.00 | å®Œæˆç‡ |
| notes | TEXT | - | YES | NULL | å¤‡æ³¨ |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY (id)
- UNIQUE KEY uk_user_date (user_id, plan_date)
- INDEX idx_tenant_id (tenant_id)
- INDEX idx_user_id (user_id)
- INDEX idx_plan_date (plan_date)

**å¤–é”®**ï¼š
- FOREIGN KEY (tenant_id) REFERENCES tenants(id)
- FOREIGN KEY (user_id) REFERENCES users(id)

### 3.17 æ¯æ—¥è®¡åˆ’æ˜ç»†è¡¨ï¼ˆdaily_plan_itemsï¼‰

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å…è®¸ç©º | é»˜è®¤å€¼ | è¯´æ˜ |
|-------|------|------|--------|--------|------|
| id | VARCHAR | 50 | NO | - | æ˜ç»†IDï¼ˆä¸»é”®ï¼‰ |
| plan_id | VARCHAR | 50 | NO | - | è®¡åˆ’IDï¼ˆå¤–é”®ï¼‰ |
| todo_task_id | VARCHAR | 50 | NO | - | å¾…åŠä»»åŠ¡IDï¼ˆå¤–é”®ï¼‰ |
| sort_order | INT | - | NO | 0 | æ’åº |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY (id)
- INDEX idx_plan_id (plan_id)
- INDEX idx_todo_task_id (todo_task_id)

**å¤–é”®**ï¼š
- FOREIGN KEY (plan_id) REFERENCES daily_plans(id)
- FOREIGN KEY (todo_task_id) REFERENCES todo_tasks(id)

### 3.18 ä»»åŠ¡æé†’è¡¨ï¼ˆtodo_remindersï¼‰

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å…è®¸ç©º | é»˜è®¤å€¼ | è¯´æ˜ |
|-------|------|------|--------|--------|------|
| id | VARCHAR | 50 | NO | - | æé†’IDï¼ˆä¸»é”®ï¼‰ |
| tenant_id | VARCHAR | 50 | NO | - | ç§Ÿæˆ·IDï¼ˆå¤–é”®ï¼‰ |
| user_id | VARCHAR | 50 | NO | - | ç”¨æˆ·IDï¼ˆå¤–é”®ï¼‰ |
| todo_task_id | VARCHAR | 50 | NO | - | å¾…åŠä»»åŠ¡IDï¼ˆå¤–é”®ï¼‰ |
| reminder_type | VARCHAR | 20 | NO | - | æé†’ç±»å‹ï¼ˆdue/overdue/dailyï¼‰ |
| reminder_time | DATETIME | - | NO | - | æé†’æ—¶é—´ |
| status | VARCHAR | 20 | NO | pending | çŠ¶æ€ï¼ˆpending/sent/failedï¼‰ |
| sent_at | DATETIME | - | YES | NULL | å‘é€æ—¶é—´ |
| notification_id | VARCHAR | 50 | YES | NULL | é€šçŸ¥IDï¼ˆå¤–é”®ï¼‰ |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY (id)
- INDEX idx_tenant_id (tenant_id)
- INDEX idx_user_id (user_id)
- INDEX idx_todo_task_id (todo_task_id)
- INDEX idx_reminder_time (reminder_time)
- INDEX idx_status (status)

**å¤–é”®**ï¼š
- FOREIGN KEY (tenant_id) REFERENCES tenants(id)
- FOREIGN KEY (user_id) REFERENCES users(id)
- FOREIGN KEY (todo_task_id) REFERENCES todo_tasks(id)
- FOREIGN KEY (notification_id) REFERENCES notifications(id)

### 3.19 å·¥ä½œæµå®šä¹‰è¡¨ï¼ˆworkflow_definitionsï¼‰

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å…è®¸ç©º | é»˜è®¤å€¼ | è¯´æ˜ |
|-------|------|------|--------|--------|------|
| id | VARCHAR | 50 | NO | - | å®šä¹‰IDï¼ˆä¸»é”®ï¼‰ |
| tenant_id | VARCHAR | 50 | NO | - | ç§Ÿæˆ·IDï¼ˆå¤–é”®ï¼‰ |
| name | VARCHAR | 100 | NO | - | å·¥ä½œæµåç§° |
| code | VARCHAR | 50 | NO | - | å·¥ä½œæµç¼–ç ï¼ˆå”¯ä¸€ï¼‰ |
| description | TEXT | - | YES | NULL | æè¿° |
| workflow_type | VARCHAR | 50 | NO | - | å·¥ä½œæµç±»å‹ï¼ˆhr/permission/finance/it/customï¼‰ |
| definition_json | JSON | - | NO | - | å·¥ä½œæµå®šä¹‰JSON |
| version | VARCHAR | 20 | NO | v1.0 | ç‰ˆæœ¬å· |
| status | VARCHAR | 20 | NO | draft | çŠ¶æ€ï¼ˆdraft/published/archivedï¼‰ |
| created_by | VARCHAR | 50 | NO | - | åˆ›å»ºäººIDï¼ˆå¤–é”®ï¼‰ |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY (id)
- UNIQUE KEY uk_tenant_code (tenant_id, code)
- INDEX idx_tenant_id (tenant_id)
- INDEX idx_workflow_type (workflow_type)
- INDEX idx_status (status)
- INDEX idx_created_by (created_by)

**å¤–é”®**ï¼š
- FOREIGN KEY (tenant_id) REFERENCES tenants(id)
- FOREIGN KEY (created_by) REFERENCES users(id)

### 3.20 å·¥ä½œæµå®ä¾‹è¡¨ï¼ˆworkflow_instancesï¼‰

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å…è®¸ç©º | é»˜è®¤å€¼ | è¯´æ˜ |
|-------|------|------|--------|--------|------|
| id | VARCHAR | 50 | NO | - | å®ä¾‹IDï¼ˆä¸»é”®ï¼‰ |
| tenant_id | VARCHAR | 50 | NO | - | ç§Ÿæˆ·IDï¼ˆå¤–é”®ï¼‰ |
| definition_id | VARCHAR | 50 | NO | - | å®šä¹‰IDï¼ˆå¤–é”®ï¼‰ |
| instance_no | VARCHAR | 50 | NO | - | å®ä¾‹ç¼–å· |
| status | VARCHAR | 20 | NO | running | çŠ¶æ€ï¼ˆrunning/completed/failed/cancelledï¼‰ |
| current_node_id | VARCHAR | 50 | YES | NULL | å½“å‰èŠ‚ç‚¹ID |
| context_variables | JSON | - | YES | NULL | ä¸Šä¸‹æ–‡å˜é‡ |
| started_at | DATETIME | - | NO | - | å¼€å§‹æ—¶é—´ |
| ended_at | DATETIME | - | YES | NULL | ç»“æŸæ—¶é—´ |
| created_by | VARCHAR | 50 | NO | - | åˆ›å»ºäººIDï¼ˆå¤–é”®ï¼‰ |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY (id)
- UNIQUE KEY uk_instance_no (instance_no)
- INDEX idx_tenant_id (tenant_id)
- INDEX idx_definition_id (definition_id)
- INDEX idx_status (status)
- INDEX idx_started_at (started_at)
- INDEX idx_created_by (created_by)

**å¤–é”®**ï¼š
- FOREIGN KEY (tenant_id) REFERENCES tenants(id)
- FOREIGN KEY (definition_id) REFERENCES workflow_definitions(id)
- FOREIGN KEY (created_by) REFERENCES users(id)

### 3.21 å·¥ä½œæµèŠ‚ç‚¹è¡¨ï¼ˆworkflow_nodesï¼‰

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å…è®¸ç©º | é»˜è®¤å€¼ | è¯´æ˜ |
|-------|------|------|--------|--------|------|
| id | VARCHAR | 50 | NO | - | èŠ‚ç‚¹IDï¼ˆä¸»é”®ï¼‰ |
| definition_id | VARCHAR | 50 | NO | - | å®šä¹‰IDï¼ˆå¤–é”®ï¼‰ |
| node_id | VARCHAR | 50 | NO | - | èŠ‚ç‚¹ID |
| node_type | VARCHAR | 50 | NO | - | èŠ‚ç‚¹ç±»å‹ï¼ˆstart/end/form/approval/condition/parallel/action/wait/loop/mcp/subflowï¼‰ |
| node_name | VARCHAR | 100 | NO | - | èŠ‚ç‚¹åç§° |
| node_config_json | JSON | - | YES | NULL | èŠ‚ç‚¹é…ç½®JSON |
| sort_order | INT | - | NO | 0 | æ’åº |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY (id)
- INDEX idx_definition_id (definition_id)
- INDEX idx_node_id (node_id)
- INDEX idx_node_type (node_type)

**å¤–é”®**ï¼š
- FOREIGN KEY (definition_id) REFERENCES workflow_definitions(id)

### 3.22 å·¥ä½œæµä»»åŠ¡è¡¨ï¼ˆworkflow_tasksï¼‰

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å…è®¸ç©º | é»˜è®¤å€¼ | è¯´æ˜ |
|-------|------|------|--------|--------|------|
| id | VARCHAR | 50 | NO | - | ä»»åŠ¡IDï¼ˆä¸»é”®ï¼‰ |
| tenant_id | VARCHAR | 50 | NO | - | ç§Ÿæˆ·IDï¼ˆå¤–é”®ï¼‰ |
| instance_id | VARCHAR | 50 | NO | - | å®ä¾‹IDï¼ˆå¤–é”®ï¼‰ |
| node_id | VARCHAR | 50 | NO | - | èŠ‚ç‚¹IDï¼ˆå¤–é”®ï¼‰ |
| task_name | VARCHAR | 100 | NO | - | ä»»åŠ¡åç§° |
| task_type | VARCHAR | 20 | NO | - | ä»»åŠ¡ç±»å‹ï¼ˆapproval/notification/actionï¼‰ |
| status | VARCHAR | 20 | NO | pending | çŠ¶æ€ï¼ˆpending/in_progress/completed/rejected/transferred/cancelledï¼‰ |
| assigned_to | VARCHAR | 50 | YES | NULL | åˆ†é…ç»™ç”¨æˆ·IDï¼ˆå¤–é”®ï¼‰ |
| task_data | JSON | - | YES | NULL | ä»»åŠ¡æ•°æ® |
| approval_action | VARCHAR | 20 | YES | NULL | å®¡æ‰¹æ“ä½œï¼ˆagree/reject/transferï¼‰ |
| approval_comment | TEXT | - | YES | NULL | å®¡æ‰¹æ„è§ |
| completed_at | DATETIME | - | YES | NULL | å®Œæˆæ—¶é—´ |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY (id)
- INDEX idx_tenant_id (tenant_id)
- INDEX idx_instance_id (instance_id)
- INDEX idx_node_id (node_id)
- INDEX idx_assigned_to (assigned_to)
- INDEX idx_status (status)
- INDEX idx_created_at (created_at)

**å¤–é”®**ï¼š
- FOREIGN KEY (tenant_id) REFERENCES tenants(id)
- FOREIGN KEY (instance_id) REFERENCES workflow_instances(id)
- FOREIGN KEY (node_id) REFERENCES workflow_nodes(id)
- FOREIGN KEY (assigned_to) REFERENCES users(id)

### 3.23 å·¥ä½œæµæ—¥å¿—è¡¨ï¼ˆworkflow_logsï¼‰

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å…è®¸ç©º | é»˜è®¤å€¼ | è¯´æ˜ |
|-------|------|------|--------|--------|------|
| id | VARCHAR | 50 | NO | - | æ—¥å¿—IDï¼ˆä¸»é”®ï¼‰ |
| tenant_id | VARCHAR | 50 | NO | - | ç§Ÿæˆ·IDï¼ˆå¤–é”®ï¼‰ |
| instance_id | VARCHAR | 50 | NO | - | å®ä¾‹IDï¼ˆå¤–é”®ï¼‰ |
| log_type | VARCHAR | 20 | NO | - | æ—¥å¿—ç±»å‹ï¼ˆinfo/warning/errorï¼‰ |
| log_message | TEXT | - | NO | - | æ—¥å¿—æ¶ˆæ¯ |
| log_data | JSON | - | YES | NULL | æ—¥å¿—æ•°æ® |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY (id)
- INDEX idx_tenant_id (tenant_id)
- INDEX idx_instance_id (instance_id)
- INDEX idx_log_type (log_type)
- INDEX idx_created_at (created_at)

**å¤–é”®**ï¼š
- FOREIGN KEY (tenant_id) REFERENCES tenants(id)
- FOREIGN KEY (instance_id) REFERENCES workflow_instances(id)

### 3.24 å·¥ä½œæµæ¨¡æ¿è¡¨ï¼ˆworkflow_templatesï¼‰

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å…è®¸ç©º | é»˜è®¤å€¼ | è¯´æ˜ |
|-------|------|------|--------|--------|------|
| id | VARCHAR | 50 | NO | - | æ¨¡æ¿IDï¼ˆä¸»é”®ï¼‰ |
| tenant_id | VARCHAR | 50 | NO | - | ç§Ÿæˆ·IDï¼ˆå¤–é”®ï¼ŒNULLè¡¨ç¤ºç³»ç»Ÿæ¨¡æ¿ï¼‰ |
| template_type | VARCHAR | 50 | NO | - | æ¨¡æ¿ç±»å‹ï¼ˆhr/permission/finance/itï¼‰ |
| template_name | VARCHAR | 100 | NO | - | æ¨¡æ¿åç§° |
| template_code | VARCHAR | 50 | NO | - | æ¨¡æ¿ç¼–ç  |
| description | TEXT | - | YES | NULL | æè¿° |
| definition_json | JSON | - | NO | - | å·¥ä½œæµå®šä¹‰JSON |
| is_system | BOOLEAN | - | NO | FALSE | æ˜¯å¦ç³»ç»Ÿæ¨¡æ¿ |
| status | VARCHAR | 20 | NO | active | çŠ¶æ€ï¼ˆactive/inactiveï¼‰ |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY (id)
- UNIQUE KEY uk_template_code (template_code)
- INDEX idx_tenant_id (tenant_id)
- INDEX idx_template_type (template_type)
- INDEX idx_is_system (is_system)
- INDEX idx_status (status)

**å¤–é”®**ï¼š
- FOREIGN KEY (tenant_id) REFERENCES tenants(id)

### 3.25 Sagaæ—¥å¿—è¡¨ï¼ˆsaga_logsï¼‰

**è¯´æ˜**ï¼šç”¨äºè®°å½•Sagaåˆ†å¸ƒå¼äº‹åŠ¡çš„æ‰§è¡ŒçŠ¶æ€ï¼Œæ”¯æŒäº‹åŠ¡è¿½è¸ªå’Œæ•…éšœæ¢å¤ã€‚

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å…è®¸ç©º | é»˜è®¤å€¼ | è¯´æ˜ |
|-------|------|------|--------|--------|------|
| id | VARCHAR | 50 | NO | - | Sagaäº‹åŠ¡IDï¼ˆä¸»é”®ï¼‰ |
| status | VARCHAR | 20 | NO | running | çŠ¶æ€ï¼ˆrunning/completed/failedï¼‰ |
| steps_total | INT | - | NO | 0 | æ€»æ­¥éª¤æ•° |
| steps_completed | INT | - | NO | 0 | å·²å®Œæˆæ­¥éª¤æ•° |
| error | TEXT | - | YES | NULL | é”™è¯¯ä¿¡æ¯ |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| completed_at | DATETIME | - | YES | NULL | å®Œæˆæ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY (id)
- INDEX idx_status (status)
- INDEX idx_created_at (created_at)
- INDEX idx_completed_at (completed_at)

**ä½¿ç”¨åœºæ™¯**ï¼š
- è®°å½•Sagaäº‹åŠ¡çš„æ‰§è¡ŒçŠ¶æ€
- æ”¯æŒäº‹åŠ¡è¿½è¸ªå’Œæ•…éšœè¯Šæ–­
- æ”¯æŒè¶…æ—¶äº‹åŠ¡çš„è‡ªåŠ¨æ¸…ç†

---

## 4. å¤šæ•°æ®æºè®¾è®¡

### 4.1 æ•°æ®æºé…ç½®

```python
DATA_SOURCES = {
    "primary": {
        "type": "mysql",
        "host": "localhost",
        "port": 3306,
        "database": "mcp_platform",
        "username": "root",
        "password": "12345678",
        "is_primary": True
    },
    "oracle_db": {
        "type": "oracle",
        "host": "192.168.1.100",
        "port": 1521,
        "database": "ORCL",
        "username": "oracle_user",
        "password": "oracle_password"
    },
    "postgres_db": {
        "type": "postgresql",
        "host": "192.168.1.101",
        "port": 5432,
        "database": "mcp_platform",
        "username": "postgres_user",
        "password": "postgres_password"
    }
}
```

### 4.2 æ•°æ®æºè·¯ç”±

```python
TABLE_ROUTING = {
    # ä¸»æ•°æ®æºè¡¨
    "users": "primary",
    "roles": "primary",
    "permissions": "primary",
    "tenants": "primary",
    "departments": "primary",
    "menus": "primary",
    "mcp_tools": "primary",
    
    # Oracleæ•°æ®æºè¡¨
    "legacy_orders": "oracle_db",
    "legacy_products": "oracle_db",
    
    # PostgreSQLæ•°æ®æºè¡¨
    "analytics_data": "postgres_db",
    "report_data": "postgres_db",
}
```

---

## 5. ç´¢å¼•ä¼˜åŒ–ç­–ç•¥

### 5.1 ç´¢å¼•è®¾è®¡åŸåˆ™

#### 5.1.1 ç´¢å¼•é€‰æ‹©åŸåˆ™

**é«˜é€‰æ‹©æ€§å­—æ®µä¼˜å…ˆ**ï¼š
- âœ… é€‰æ‹©æ€§ > 10% çš„å­—æ®µé€‚åˆåˆ›å»ºç´¢å¼•
- âœ… é€‰æ‹©æ€§ = å”¯ä¸€å€¼æ•°é‡ / æ€»è¡Œæ•°
- âœ… é«˜é€‰æ‹©æ€§å­—æ®µï¼ˆå¦‚ç”¨æˆ·åã€é‚®ç®±ï¼‰ä¼˜å…ˆç´¢å¼•
- âŒ ä½é€‰æ‹©æ€§å­—æ®µï¼ˆå¦‚æ€§åˆ«ã€çŠ¶æ€ï¼‰ä¸é€‚åˆå•ç‹¬ç´¢å¼•

**ä½¿ç”¨é¢‘ç‡é«˜çš„å­—æ®µ**ï¼š
- âœ… é¢‘ç¹å‡ºç°åœ¨WHEREæ¡ä»¶ä¸­çš„å­—æ®µ
- âœ… é¢‘ç¹å‡ºç°åœ¨JOINæ¡ä»¶ä¸­çš„å­—æ®µ
- âœ… é¢‘ç¹å‡ºç°åœ¨ORDER BYä¸­çš„å­—æ®µ
- âœ… é¢‘ç¹å‡ºç°åœ¨GROUP BYä¸­çš„å­—æ®µ

**å¤åˆç´¢å¼•å­—æ®µé¡ºåº**ï¼š
```sql
-- âœ… æ­£ç¡®ï¼šé«˜é€‰æ‹©æ€§å­—æ®µåœ¨å‰
CREATE INDEX idx_tenant_status ON users(tenant_id, status);

-- âŒ é”™è¯¯ï¼šä½é€‰æ‹©æ€§å­—æ®µåœ¨å‰
CREATE INDEX idx_status_tenant ON users(status, tenant_id);
```

**é¿å…è¿‡åº¦ç´¢å¼•**ï¼š
- âŒ ä¸è¦ä¸ºæ¯ä¸ªå­—æ®µéƒ½åˆ›å»ºç´¢å¼•
- âŒ ä¸è¦åˆ›å»ºé‡å¤çš„ç´¢å¼•
- âŒ ä¸è¦åˆ›å»ºå¾ˆå°‘ä½¿ç”¨çš„ç´¢å¼•
- âœ… å®šæœŸæ¸…ç†æ— ç”¨ç´¢å¼•

#### 5.1.2 ç´¢å¼•ç±»å‹é€‰æ‹©

| ç´¢å¼•ç±»å‹ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|---------|---------|------|------|
| **B-Treeç´¢å¼•** | ç­‰å€¼æŸ¥è¯¢ã€èŒƒå›´æŸ¥è¯¢ã€æ’åº | é€šç”¨æ€§å¼ºã€æ”¯æŒèŒƒå›´æŸ¥è¯¢ | å ç”¨ç©ºé—´å¤§ |
| **å“ˆå¸Œç´¢å¼•** | ç­‰å€¼æŸ¥è¯¢ | æŸ¥è¯¢é€Ÿåº¦å¿« | ä¸æ”¯æŒèŒƒå›´æŸ¥è¯¢ã€ä¸æ’åº |
| **å…¨æ–‡ç´¢å¼•** | æ–‡æœ¬æœç´¢ | æ”¯æŒå…¨æ–‡æ£€ç´¢ | å ç”¨ç©ºé—´å¤§ã€ç»´æŠ¤æˆæœ¬é«˜ |
| **ç©ºé—´ç´¢å¼•** | åœ°ç†ä½ç½®æ•°æ® | æ”¯æŒç©ºé—´æŸ¥è¯¢ | åº”ç”¨åœºæ™¯æœ‰é™ |

**B-Treeç´¢å¼•ï¼ˆé»˜è®¤ï¼‰**ï¼š
```sql
-- å•åˆ—ç´¢å¼•
CREATE INDEX idx_username ON users(username);

-- å¤åˆç´¢å¼•
CREATE INDEX idx_tenant_status ON users(tenant_id, status);

-- å”¯ä¸€ç´¢å¼•
CREATE UNIQUE INDEX idx_email ON users(email);
```

**å“ˆå¸Œç´¢å¼•**ï¼š
```sql
-- é€‚ç”¨äºç­‰å€¼æŸ¥è¯¢
CREATE INDEX idx_hash_username ON users USING HASH(username);
```

**å…¨æ–‡ç´¢å¼•**ï¼š
```sql
-- é€‚ç”¨äºæ–‡æœ¬æœç´¢
CREATE FULLTEXT INDEX idx_content ON articles(content);

-- ä½¿ç”¨å…¨æ–‡ç´¢å¼•
SELECT * FROM articles 
WHERE MATCH(content) AGAINST('å…³é”®è¯' IN NATURAL LANGUAGE MODE);
```

**ç©ºé—´ç´¢å¼•**ï¼š
```sql
-- é€‚ç”¨äºåœ°ç†ä½ç½®æ•°æ®
CREATE SPATIAL INDEX idx_location ON locations(location);

-- ä½¿ç”¨ç©ºé—´ç´¢å¼•
SELECT * FROM locations 
WHERE ST_Distance_Sphere(location, POINT(116.404, 39.915)) < 1000;
```

### 5.2 ç´¢å¼•ä¼˜åŒ–å»ºè®®

#### 5.2.1 æ ¸å¿ƒè¡¨ç´¢å¼•è®¾è®¡

**ç”¨æˆ·è¡¨ï¼ˆusersï¼‰**ï¼š
```sql
-- ä¸»é”®ç´¢å¼•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
PRIMARY KEY (id)

-- å”¯ä¸€ç´¢å¼•
CREATE UNIQUE INDEX idx_username ON users(username);
CREATE UNIQUE INDEX idx_email ON users(email);

-- å¤åˆç´¢å¼•ï¼ˆç§Ÿæˆ·éš”ç¦»ï¼‰
CREATE INDEX idx_tenant_id ON users(tenant_id);
CREATE INDEX idx_tenant_status ON users(tenant_id, status);
CREATE INDEX idx_tenant_dept ON users(tenant_id, dept_id);

-- éƒ¨é—¨ç´¢å¼•
CREATE INDEX idx_dept_id ON users(dept_id);

-- çŠ¶æ€ç´¢å¼•
CREATE INDEX idx_status ON users(status);

-- åˆ›å»ºæ—¶é—´ç´¢å¼•ï¼ˆç”¨äºæ’åºï¼‰
CREATE INDEX idx_created_at ON users(created_at);
```

**è§’è‰²è¡¨ï¼ˆrolesï¼‰**ï¼š
```sql
-- ä¸»é”®ç´¢å¼•
PRIMARY KEY (id)

-- å”¯ä¸€ç´¢å¼•
CREATE UNIQUE INDEX idx_role_name ON roles(name, tenant_id);

-- å¤åˆç´¢å¼•
CREATE INDEX idx_tenant_id ON roles(tenant_id);
CREATE INDEX idx_tenant_status ON roles(tenant_id, status);
```

**æƒé™è¡¨ï¼ˆpermissionsï¼‰**ï¼š
```sql
-- ä¸»é”®ç´¢å¼•
PRIMARY KEY (id)

-- å”¯ä¸€ç´¢å¼•
CREATE UNIQUE INDEX idx_permission_code ON permissions(code, tenant_id);

-- å¤åˆç´¢å¼•
CREATE INDEX idx_tenant_id ON permissions(tenant_id);
CREATE INDEX idx_tenant_type ON permissions(tenant_id, type);
```

**MCPå·¥å…·è¡¨ï¼ˆmcp_toolsï¼‰**ï¼š
```sql
-- ä¸»é”®ç´¢å¼•
PRIMARY KEY (id)

-- å”¯ä¸€ç´¢å¼•
CREATE UNIQUE INDEX idx_tool_name ON mcp_tools(name, tenant_id);

-- å¤åˆç´¢å¼•
CREATE INDEX idx_tenant_id ON mcp_tools(tenant_id);
CREATE INDEX idx_tenant_status ON mcp_tools(tenant_id, status);
CREATE INDEX idx_tenant_type ON mcp_tools(tenant_id, type);

-- APIç«¯ç‚¹ç´¢å¼•
CREATE INDEX idx_api_endpoint ON mcp_tools(api_endpoint);
```

**å·¥ä½œæµå®ä¾‹è¡¨ï¼ˆworkflow_instancesï¼‰**ï¼š
```sql
-- ä¸»é”®ç´¢å¼•
PRIMARY KEY (id)

-- å”¯ä¸€ç´¢å¼•
CREATE UNIQUE INDEX uk_instance_no ON workflow_instances(instance_no);

-- å¤åˆç´¢å¼•
CREATE INDEX idx_tenant_id ON workflow_instances(tenant_id);
CREATE INDEX idx_tenant_definition ON workflow_instances(tenant_id, definition_id);
CREATE INDEX idx_tenant_status ON workflow_instances(tenant_id, status);
CREATE INDEX idx_tenant_created_by ON workflow_instances(tenant_id, created_by);

-- çŠ¶æ€ç´¢å¼•
CREATE INDEX idx_status ON workflow_instances(status);

-- å¼€å§‹æ—¶é—´ç´¢å¼•ï¼ˆç”¨äºæ’åºå’ŒæŸ¥è¯¢ï¼‰
CREATE INDEX idx_started_at ON workflow_instances(started_at);
```

**å¾…åŠä»»åŠ¡è¡¨ï¼ˆtodo_tasksï¼‰**ï¼š
```sql
-- ä¸»é”®ç´¢å¼•
PRIMARY KEY (id)

-- å¤åˆç´¢å¼•
CREATE INDEX idx_tenant_id ON todo_tasks(tenant_id);
CREATE INDEX idx_tenant_user ON todo_tasks(tenant_id, user_id);
CREATE INDEX idx_tenant_status ON todo_tasks(tenant_id, status);
CREATE INDEX idx_tenant_priority ON todo_tasks(tenant_id, priority);
CREATE INDEX idx_tenant_type ON todo_tasks(tenant_id, task_type);

-- ç”¨æˆ·ç´¢å¼•
CREATE INDEX idx_user_id ON todo_tasks(user_id);

-- çŠ¶æ€ç´¢å¼•
CREATE INDEX idx_status ON todo_tasks(status);

-- æˆªæ­¢æ—¶é—´ç´¢å¼•
CREATE INDEX idx_due_date ON todo_tasks(due_date);

-- åˆ›å»ºæ—¶é—´ç´¢å¼•
CREATE INDEX idx_created_at ON todo_tasks(created_at);
```

#### 5.2.2 å¤åˆç´¢å¼•è®¾è®¡åŸåˆ™

**æœ€å·¦å‰ç¼€åŸåˆ™**ï¼š
```sql
-- åˆ›å»ºå¤åˆç´¢å¼•
CREATE INDEX idx_tenant_status_created ON users(tenant_id, status, created_at);

-- âœ… å¯ä»¥ä½¿ç”¨ç´¢å¼•
SELECT * FROM users WHERE tenant_id = '1';
SELECT * FROM users WHERE tenant_id = '1' AND status = 'active';
SELECT * FROM users WHERE tenant_id = '1' AND status = 'active' AND created_at > '2024-01-01';

-- âŒ ä¸èƒ½ä½¿ç”¨ç´¢å¼•ï¼ˆè·³è¿‡äº†tenant_idï¼‰
SELECT * FROM users WHERE status = 'active';
SELECT * FROM users WHERE status = 'active' AND created_at > '2024-01-01';
```

**è¦†ç›–ç´¢å¼•**ï¼š
```sql
-- åˆ›å»ºè¦†ç›–ç´¢å¼•
CREATE INDEX idx_covering ON users(tenant_id, username, email);

-- âœ… å¯ä»¥ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼Œä¸éœ€è¦å›è¡¨
SELECT username, email FROM users WHERE tenant_id = '1';

-- âŒ éœ€è¦å›è¡¨æŸ¥è¯¢
SELECT * FROM users WHERE tenant_id = '1';
```

**ç´¢å¼•é€‰æ‹©æ€§**ï¼š
```sql
-- æŸ¥çœ‹ç´¢å¼•é€‰æ‹©æ€§
SELECT 
    COUNT(DISTINCT tenant_id) / COUNT(*) AS tenant_selectivity,
    COUNT(DISTINCT status) / COUNT(*) AS status_selectivity,
    COUNT(DISTINCT dept_id) / COUNT(*) AS dept_selectivity
FROM users;

-- ç»“æœç¤ºä¾‹ï¼š
-- tenant_selectivity: 0.1 (10%ï¼Œé€‰æ‹©æ€§ä½)
-- status_selectivity: 0.01 (1%ï¼Œé€‰æ‹©æ€§æä½)
-- dept_selectivity: 0.5 (50%ï¼Œé€‰æ‹©æ€§é«˜)

-- æ ¹æ®é€‰æ‹©æ€§è®¾è®¡å¤åˆç´¢å¼•
CREATE INDEX idx_dept_tenant ON users(dept_id, tenant_id);  -- é«˜é€‰æ‹©æ€§åœ¨å‰
```

#### 5.2.3 ç´¢å¼•ç»´æŠ¤ç­–ç•¥

**å®šæœŸåˆ†æç´¢å¼•ä½¿ç”¨æƒ…å†µ**ï¼š
```sql
-- æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT 
    table_name,
    index_name,
    cardinality,
    index_type
FROM information_schema.statistics
WHERE table_schema = 'mcp_platform'
ORDER BY table_name, index_name;

-- æŸ¥çœ‹ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯
SELECT 
    object_name AS table_name,
    index_name,
    rows_read,
    rows_indexed
FROM performance_schema.table_io_waits_summary_by_index_usage
WHERE object_schema = 'mcp_platform'
ORDER BY rows_indexed DESC;
```

**åˆ é™¤æ— ç”¨ç´¢å¼•**ï¼š
```sql
-- æŸ¥æ‰¾æœªä½¿ç”¨çš„ç´¢å¼•
SELECT 
    object_schema AS database_name,
    object_name AS table_name,
    index_name
FROM performance_schema.table_io_waits_summary_by_index_usage
WHERE index_name IS NOT NULL
    AND count_star = 0
    AND object_schema = 'mcp_platform'
ORDER BY object_schema, object_name;

-- åˆ é™¤æœªä½¿ç”¨çš„ç´¢å¼•ï¼ˆè°¨æ…æ“ä½œï¼‰
DROP INDEX idx_unused_index ON users;
```

**é‡å»ºç´¢å¼•**ï¼š
```sql
-- é‡å»ºç´¢å¼•ï¼ˆé€‚ç”¨äºç´¢å¼•ç¢ç‰‡åŒ–ä¸¥é‡çš„æƒ…å†µï¼‰
ALTER TABLE users ENGINE=InnoDB;

-- æˆ–ä½¿ç”¨OPTIMIZE TABLE
OPTIMIZE TABLE users;

-- é‡å»ºå•ä¸ªç´¢å¼•
ALTER TABLE users DROP INDEX idx_username;
ALTER TABLE users ADD INDEX idx_username(username);
```

#### 5.2.4 ç´¢å¼•ç›‘æ§å’Œè°ƒä¼˜

**æ…¢æŸ¥è¯¢åˆ†æ**ï¼š
```sql
-- å¯ç”¨æ…¢æŸ¥è¯¢æ—¥å¿—
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 1;
SET GLOBAL slow_query_log_file = '/var/log/mysql/slow-query.log';

-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT * FROM mysql.slow_log 
ORDER BY query_time DESC 
LIMIT 10;

-- åˆ†ææ…¢æŸ¥è¯¢
EXPLAIN SELECT * FROM users WHERE username = 'admin';
```

**EXPLAINåˆ†æ**ï¼š
```sql
-- åˆ†ææŸ¥è¯¢æ‰§è¡Œè®¡åˆ’
EXPLAIN SELECT * FROM users WHERE tenant_id = '1' AND status = 'active';

-- å…³é”®æŒ‡æ ‡ï¼š
-- type: è®¿é—®ç±»å‹ï¼ˆALL=å…¨è¡¨æ‰«æï¼Œindex=ç´¢å¼•æ‰«æï¼Œrange=èŒƒå›´æ‰«æï¼Œref=ç´¢å¼•æŸ¥æ‰¾ï¼Œconst=å¸¸é‡æŸ¥æ‰¾ï¼‰
-- key: å®é™…ä½¿ç”¨çš„ç´¢å¼•
-- rows: é¢„ä¼°æ‰«æçš„è¡Œæ•°
-- Extra: é¢å¤–ä¿¡æ¯ï¼ˆUsing index=è¦†ç›–ç´¢å¼•ï¼ŒUsing filesort=æ–‡ä»¶æ’åºï¼ŒUsing temporary=ä¸´æ—¶è¡¨ï¼‰
```

**ç´¢å¼•ä¼˜åŒ–å»ºè®®**ï¼š
```sql
-- æŸ¥çœ‹ç´¢å¼•å»ºè®®
SELECT * FROM sys.schema_redundant_indexes;

-- æŸ¥çœ‹æœªä½¿ç”¨çš„ç´¢å¼•
SELECT * FROM sys.schema_unused_indexes;

-- æŸ¥çœ‹é‡å¤çš„ç´¢å¼•
SELECT * FROM sys.schema_redundant_indexes;
```

### 5.3 ç´¢å¼•æœ€ä½³å®è·µ

**åˆ›å»ºç´¢å¼•çš„æœ€ä½³å®è·µ**ï¼š
- âœ… åœ¨å¼€å‘é˜¶æ®µå°±è®¾è®¡å¥½ç´¢å¼•
- âœ… ä¸ºé«˜é¢‘æŸ¥è¯¢åˆ›å»ºç´¢å¼•
- âœ… ä¸ºå¤–é”®åˆ›å»ºç´¢å¼•
- âœ… ä¸ºJOINæ¡ä»¶åˆ›å»ºç´¢å¼•
- âœ… ä¸ºORDER BYå’ŒGROUP BYåˆ›å»ºç´¢å¼•
- âœ… ä½¿ç”¨å¤åˆç´¢å¼•ä¼˜åŒ–å¤šæ¡ä»¶æŸ¥è¯¢
- âœ… å®šæœŸåˆ†æç´¢å¼•ä½¿ç”¨æƒ…å†µ

**é¿å…ç´¢å¼•è¯¯åŒºçš„æœ€ä½³å®è·µ**ï¼š
- âŒ ä¸è¦ä¸ºå°è¡¨åˆ›å»ºç´¢å¼•ï¼ˆ<1000è¡Œï¼‰
- âŒ ä¸è¦ä¸ºä½é€‰æ‹©æ€§å­—æ®µåˆ›å»ºå•ç‹¬ç´¢å¼•
- âŒ ä¸è¦åˆ›å»ºè¿‡å¤šçš„ç´¢å¼•ï¼ˆå½±å“å†™å…¥æ€§èƒ½ï¼‰
- âŒ ä¸è¦åœ¨ç»å¸¸æ›´æ–°çš„å­—æ®µä¸Šåˆ›å»ºå¤ªå¤šç´¢å¼•
- âŒ ä¸è¦å¿½ç•¥ç´¢å¼•ç»´æŠ¤æˆæœ¬
- âŒ ä¸è¦ç›²ç›®åˆ›å»ºç´¢å¼•ï¼Œè¦å…ˆåˆ†ææŸ¥è¯¢æ¨¡å¼

**ç´¢å¼•ç»´æŠ¤çš„æœ€ä½³å®è·µ**ï¼š
- âœ… å®šæœŸæ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ
- âœ… å®šæœŸåˆ é™¤æ— ç”¨ç´¢å¼•
- âœ… å®šæœŸé‡å»ºç¢ç‰‡åŒ–çš„ç´¢å¼•
- âœ… ç›‘æ§æ…¢æŸ¥è¯¢æ—¥å¿—
- âœ… ä½¿ç”¨EXPLAINåˆ†ææŸ¥è¯¢è®¡åˆ’
- âœ… å®šæœŸè¿›è¡Œç´¢å¼•ä¼˜åŒ–

---

## 6. æ•°æ®åº“è¿ç§»ç­–ç•¥

### 5.1 è¿ç§»å·¥å…·

ä½¿ç”¨ **Alembic** è¿›è¡Œæ•°æ®åº“ç‰ˆæœ¬ç®¡ç†å’Œè¿ç§»ã€‚

### 5.2 è¿ç§»æµç¨‹

```mermaid
graph LR
    A[å¼€å‘äººå‘˜] --> B[ç¼–å†™è¿ç§»è„šæœ¬]
    B --> C[æäº¤åˆ°Git]
    C --> D[CI/CDè‡ªåŠ¨æ‰§è¡Œ]
    D --> E[æµ‹è¯•ç¯å¢ƒéªŒè¯]
    E --> F[ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²]
```

### 5.3 è¿ç§»å‘½ä»¤

```bash
# åˆå§‹åŒ–Alembic
alembic init alembic

# ç”Ÿæˆè¿ç§»è„šæœ¬
alembic revision --autogenerate -m "æè¿°"

# æ‰§è¡Œè¿ç§»
alembic upgrade head

# å›æ»šè¿ç§»
alembic downgrade -1
```

---

## 7. åˆ†åº“åˆ†è¡¨æ–¹æ¡ˆ

### 7.1 åˆ†åº“åˆ†è¡¨æ¦‚è¿°

**é€‚ç”¨åœºæ™¯**ï¼š
- å•è¡¨æ•°æ®é‡è¶…è¿‡1000ä¸‡
- å•åº“æ•°æ®é‡è¶…è¿‡100GB
- å•åº“QPSè¶…è¿‡5000
- å¤šç§Ÿæˆ·åœºæ™¯ï¼Œéœ€è¦æ•°æ®éš”ç¦»

**åˆ†åº“åˆ†è¡¨ä¼˜åŠ¿**ï¼š
- âœ… æé«˜æŸ¥è¯¢æ€§èƒ½
- âœ… æé«˜å¹¶å‘èƒ½åŠ›
- âœ… æé«˜æ•°æ®å®‰å…¨æ€§
- âœ… æé«˜æ‰©å±•æ€§

**åˆ†åº“åˆ†è¡¨æŒ‘æˆ˜**ï¼š
- âŒ äº‹åŠ¡ä¸€è‡´æ€§
- âŒ è·¨åº“JOIN
- âŒ åˆ†é¡µæŸ¥è¯¢
- âŒ æ•°æ®è¿ç§»

### 7.2 åˆ†åº“ç­–ç•¥

#### 7.2.1 æŒ‰ç§Ÿæˆ·åˆ†åº“ï¼ˆæ¨èï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šå¤šç§Ÿæˆ·SaaSå¹³å°

**åˆ†åº“è§„åˆ™**ï¼š
```python
# æŒ‰ç§Ÿæˆ·IDåˆ†åº“
def get_database_by_tenant(tenant_id: str) -> str:
    """æ ¹æ®ç§Ÿæˆ·IDè·å–æ•°æ®åº“"""
    # è®¡ç®—åˆ†åº“ç´¢å¼•
    db_index = hash(tenant_id) % 10  # åˆ†æˆ10ä¸ªåº“
    
    # è¿”å›æ•°æ®åº“å
    return f"mcp_platform_{db_index}"

# ç¤ºä¾‹
# tenant_001 -> mcp_platform_1
# tenant_002 -> mcp_platform_2
# tenant_003 -> mcp_platform_3
```

**æ•°æ®åº“é…ç½®**ï¼š
```python
DATABASE_CONFIG = {
    "mcp_platform_0": {
        "host": "db0.example.com",
        "port": 3306,
        "database": "mcp_platform_0",
        "user": "root",
        "password": "password"
    },
    "mcp_platform_1": {
        "host": "db1.example.com",
        "port": 3306,
        "database": "mcp_platform_1",
        "user": "root",
        "password": "password"
    },
    # ... æ›´å¤šæ•°æ®åº“é…ç½®
}
```

**è·¯ç”±å®ç°**ï¼š
```python
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

class DatabaseRouter:
    """æ•°æ®åº“è·¯ç”±å™¨"""
    
    def __init__(self):
        self.engines = {}
        self.sessions = {}
        
        # åˆå§‹åŒ–æ‰€æœ‰æ•°æ®åº“è¿æ¥
        for db_name, config in DATABASE_CONFIG.items():
            engine = create_engine(
                f"mysql://{config['user']}:{config['password']}@{config['host']}:{config['port']}/{config['database']}",
                pool_size=10,
                max_overflow=20
            )
            self.engines[db_name] = engine
            self.sessions[db_name] = sessionmaker(bind=engine)
    
    def get_session(self, tenant_id: str):
        """æ ¹æ®ç§Ÿæˆ·IDè·å–æ•°æ®åº“ä¼šè¯"""
        db_name = get_database_by_tenant(tenant_id)
        return self.sessions[db_name]()
    
    def get_engine(self, tenant_id: str):
        """æ ¹æ®ç§Ÿæˆ·IDè·å–æ•°æ®åº“å¼•æ“"""
        db_name = get_database_by_tenant(tenant_id)
        return self.engines[db_name]

# å…¨å±€è·¯ç”±å™¨
db_router = DatabaseRouter()
```

#### 7.2.2 æŒ‰ä¸šåŠ¡æ¨¡å—åˆ†åº“

**é€‚ç”¨åœºæ™¯**ï¼šä¸šåŠ¡æ¨¡å—ç‹¬ç«‹æ€§å¼º

**åˆ†åº“è§„åˆ™**ï¼š
```python
# æŒ‰ä¸šåŠ¡æ¨¡å—åˆ†åº“
MODULE_DATABASES = {
    "user": "mcp_user",          # ç”¨æˆ·åŸŸ
    "permission": "mcp_permission",  # æƒé™åŸŸ
    "system": "mcp_system",      # ç³»ç»ŸåŸŸ
    "support": "mcp_support",    # æ”¯æ’‘åŸŸ
    "business": "mcp_business",  # ä¸šåŠ¡åŸŸ
}

def get_database_by_module(module: str) -> str:
    """æ ¹æ®ä¸šåŠ¡æ¨¡å—è·å–æ•°æ®åº“"""
    return MODULE_DATABASES.get(module, "mcp_platform")

# ç¤ºä¾‹
# user -> mcp_user
# permission -> mcp_permission
```

**è·¯ç”±å®ç°**ï¼š
```python
class ModuleDatabaseRouter:
    """æ¨¡å—è·¯ç”±å™¨"""
    
    def get_session(self, module: str):
        """æ ¹æ®æ¨¡å—è·å–æ•°æ®åº“ä¼šè¯"""
        db_name = get_database_by_module(module)
        return self.sessions[db_name]()
```

### 7.3 åˆ†è¡¨ç­–ç•¥

#### 7.3.1 æŒ‰æ—¶é—´åˆ†è¡¨ï¼ˆæ¨èï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šæ—¥å¿—è¡¨ã€è®°å½•è¡¨ç­‰å¤§è¡¨

**åˆ†è¡¨è§„åˆ™**ï¼š
```python
# æŒ‰æœˆåˆ†è¡¨
def get_table_by_time(table_name: str, date: datetime) -> str:
    """æ ¹æ®æ—¶é—´è·å–è¡¨å"""
    return f"{table_name}_{date.strftime('%Y%m')}"

# ç¤ºä¾‹
# operation_logs + 2024-01-15 -> operation_logs_202401
# mcp_tool_call_logs + 2024-02-20 -> mcp_tool_call_logs_202402
```

**åˆ›å»ºåˆ†è¡¨**ï¼š
```sql
-- åˆ›å»ºæ“ä½œæ—¥å¿—è¡¨ï¼ˆæŒ‰æœˆåˆ†è¡¨ï¼‰
CREATE TABLE operation_logs_202401 (
    id VARCHAR(50) PRIMARY KEY,
    tenant_id VARCHAR(50) NOT NULL,
    user_id VARCHAR(50) NOT NULL,
    operation VARCHAR(100) NOT NULL,
    ip VARCHAR(50),
    user_agent TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_tenant_id (tenant_id),
    INDEX idx_user_id (user_id),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- åˆ›å»º2æœˆä»½è¡¨
CREATE TABLE operation_logs_202402 LIKE operation_logs_202401;

-- åˆ›å»º3æœˆä»½è¡¨
CREATE TABLE operation_logs_202403 LIKE operation_logs_202401;
```

**è‡ªåŠ¨åˆ›å»ºåˆ†è¡¨**ï¼š
```python
import schedule
import time

def create_next_month_table():
    """åˆ›å»ºä¸‹ä¸ªæœˆçš„åˆ†è¡¨"""
    from datetime import datetime, timedelta
    from app.utils.database import execute_sql
    
    next_month = datetime.now() + timedelta(days=32)
    next_month = next_month.replace(day=1)
    
    table_name = f"operation_logs_{next_month.strftime('%Y%m')}"
    create_sql = f"CREATE TABLE {table_name} LIKE operation_logs_202401"
    
    execute_sql(create_sql)
    print(f"åˆ›å»ºè¡¨: {table_name}")

# æ¯æœˆ1å·æ‰§è¡Œ
schedule.every().month.do(create_next_month_table)

while True:
    schedule.run_pending()
    time.sleep(60)
```

#### 7.3.2 æŒ‰ç§Ÿæˆ·åˆ†è¡¨

**é€‚ç”¨åœºæ™¯**ï¼šå•ç§Ÿæˆ·æ•°æ®é‡å¤§

**åˆ†è¡¨è§„åˆ™**ï¼š
```python
# æŒ‰ç§Ÿæˆ·IDåˆ†è¡¨
def get_table_by_tenant(table_name: str, tenant_id: str) -> str:
    """æ ¹æ®ç§Ÿæˆ·IDè·å–è¡¨å"""
    # è®¡ç®—åˆ†è¡¨ç´¢å¼•
    table_index = hash(tenant_id) % 10  # åˆ†æˆ10å¼ è¡¨
    
    # è¿”å›è¡¨å
    return f"{table_name}_{table_index}"

# ç¤ºä¾‹
# users + tenant_001 -> users_1
# users + tenant_002 -> users_2
```

**åˆ›å»ºåˆ†è¡¨**ï¼š
```sql
-- åˆ›å»ºç”¨æˆ·è¡¨ï¼ˆæŒ‰ç§Ÿæˆ·åˆ†è¡¨ï¼‰
CREATE TABLE users_0 (
    id VARCHAR(50) PRIMARY KEY,
    tenant_id VARCHAR(50) NOT NULL,
    username VARCHAR(50) NOT NULL,
    email VARCHAR(100) NOT NULL,
    UNIQUE KEY uk_username (username),
    UNIQUE KEY uk_email (email),
    INDEX idx_tenant_id (tenant_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- åˆ›å»ºå…¶ä»–åˆ†è¡¨
CREATE TABLE users_1 LIKE users_0;
CREATE TABLE users_2 LIKE users_0;
-- ... æ›´å¤šåˆ†è¡¨
```

#### 7.3.3 æŒ‰æ•°æ®é‡åˆ†è¡¨

**é€‚ç”¨åœºæ™¯**ï¼šæ•°æ®é‡æŒç»­å¢é•¿

**åˆ†è¡¨è§„åˆ™**ï¼š
```python
# æŒ‰IDèŒƒå›´åˆ†è¡¨
def get_table_by_id(table_name: str, id: str) -> str:
    """æ ¹æ®IDè·å–è¡¨å"""
    # è®¡ç®—åˆ†è¡¨ç´¢å¼•
    id_int = int(id, 16)  # å‡è®¾IDæ˜¯16è¿›åˆ¶
    table_index = id_int % 10  # åˆ†æˆ10å¼ è¡¨
    
    # è¿”å›è¡¨å
    return f"{table_name}_{table_index}"

# ç¤ºä¾‹
# operation_logs + 1a2b3c4d -> operation_logs_4
# operation_logs + 5e6f7a8b -> operation_logs_9
```

### 7.4 åˆ†åº“åˆ†è¡¨å®ç°

#### 7.4.1 ShardingSphereé…ç½®

**é…ç½®æ–‡ä»¶ï¼ˆsharding.ymlï¼‰**ï¼š
```yaml
dataSources:
  ds0:
    dataSourceClassName: com.zaxxer.hikari.HikariDataSource
    driverClassName: com.mysql.cj.jdbc.Driver
    jdbcUrl: jdbc:mysql://localhost:3306/mcp_platform_0
    username: root
    password: password
  
  ds1:
    dataSourceClassName: com.zaxxer.hikari.HikariDataSource
    driverClassName: com.mysql.cj.jdbc.Driver
    jdbcUrl: jdbc:mysql://localhost:3306/mcp_platform_1
    username: root
    password: password

rules:
  - !SHARDING
    tables:
      users:
        actualDataNodes: ds${0..1}.users_${0..9}
        tableStrategy:
          standard:
            shardingColumn: tenant_id
            shardingAlgorithmName: tenant_mod
        databaseStrategy:
          standard:
            shardingColumn: tenant_id
            shardingAlgorithmName: tenant_mod
    
    shardingAlgorithms:
      tenant_mod:
        type: MOD
        props:
          sharding-count: 10
```

**Pythoné›†æˆ**ï¼š
```python
from shardingjdbc import ShardingSphereDataSource

# åˆ›å»ºShardingSphereæ•°æ®æº
sharding_datasource = ShardingSphereDataSource(
    config_file="sharding.yml"
)

# ä½¿ç”¨ShardingSphereæ•°æ®æº
engine = create_engine(
    "mysql+pymysql://",
    creator=lambda: sharding_datasource.getConnection()
)
```

#### 7.4.2 è‡ªå®šä¹‰è·¯ç”±å®ç°

**è·¯ç”±å™¨å®ç°**ï¼š
```python
from typing import Dict, Any
from sqlalchemy.engine import Engine
from sqlalchemy.orm import Session

class ShardingRouter:
    """åˆ†åº“åˆ†è¡¨è·¯ç”±å™¨"""
    
    def __init__(self):
        self.engines: Dict[str, Engine] = {}
        self.sessions: Dict[str, Session] = {}
        
        # åˆå§‹åŒ–æ•°æ®åº“è¿æ¥
        self._init_databases()
    
    def _init_databases(self):
        """åˆå§‹åŒ–æ•°æ®åº“è¿æ¥"""
        for db_name, config in DATABASE_CONFIG.items():
            engine = create_engine(
                f"mysql://{config['user']}:{config['password']}@{config['host']}:{config['port']}/{config['database']}",
                pool_size=10,
                max_overflow=20
            )
            self.engines[db_name] = engine
            self.sessions[db_name] = sessionmaker(bind=engine)
    
    def route(self, table_name: str, **kwargs) -> tuple:
        """è·¯ç”±åˆ°å…·ä½“çš„åº“å’Œè¡¨"""
        # è·å–ç§Ÿæˆ·ID
        tenant_id = kwargs.get('tenant_id')
        
        # è®¡ç®—åˆ†åº“å’Œåˆ†è¡¨
        db_name = get_database_by_tenant(tenant_id)
        table_name = get_table_by_tenant(table_name, tenant_id)
        
        return db_name, table_name
    
    def get_session(self, table_name: str, **kwargs) -> Session:
        """è·å–æ•°æ®åº“ä¼šè¯"""
        db_name, _ = self.route(table_name, **kwargs)
        return self.sessions[db_name]()
    
    def execute(self, sql: str, table_name: str, **kwargs):
        """æ‰§è¡ŒSQL"""
        db_name, actual_table = self.route(table_name, **kwargs)
        
        # æ›¿æ¢è¡¨å
        actual_sql = sql.replace(table_name, actual_table)
        
        # æ‰§è¡ŒSQL
        session = self.sessions[db_name]()
        session.execute(actual_sql)
        session.commit()
        session.close()

# å…¨å±€è·¯ç”±å™¨
sharding_router = ShardingRouter()
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```python
# æŸ¥è¯¢ç”¨æˆ·
def get_user(tenant_id: str, user_id: str):
    session = sharding_router.get_session("users", tenant_id=tenant_id)
    
    # è‡ªåŠ¨è·¯ç”±åˆ°æ­£ç¡®çš„åº“å’Œè¡¨
    user = session.query(User).filter(
        User.tenant_id == tenant_id,
        User.id == user_id
    ).first()
    
    session.close()
    return user

# åˆ›å»ºç”¨æˆ·
def create_user(user_data: dict):
    session = sharding_router.get_session("users", tenant_id=user_data['tenant_id'])
    
    user = User(**user_data)
    session.add(user)
    session.commit()
    session.close()
    
    return user
```

### 7.5 æ•°æ®è¿ç§»

#### 7.5.1 å†å²æ•°æ®è¿ç§»

**è¿ç§»è„šæœ¬**ï¼š
```python
from datetime import datetime

def migrate_historical_data():
    """è¿ç§»å†å²æ•°æ®"""
    from app.utils.database import execute_sql
    
    # æŸ¥è¯¢æ‰€æœ‰ç§Ÿæˆ·
    tenants = execute_sql("SELECT id FROM tenants")
    
    for tenant in tenants:
        tenant_id = tenant['id']
        
        # æŸ¥è¯¢è¯¥ç§Ÿæˆ·çš„æ‰€æœ‰ç”¨æˆ·
        users = execute_sql(
            f"SELECT * FROM users WHERE tenant_id = '{tenant_id}'"
        )
        
        # è·å–ç›®æ ‡è¡¨
        target_table = get_table_by_tenant("users", tenant_id)
        
        # æ’å…¥æ•°æ®
        for user in users:
            insert_sql = f"""
                INSERT INTO {target_table} 
                (id, tenant_id, username, email, created_at)
                VALUES ('{user['id']}', '{user['tenant_id']}', 
                        '{user['username']}', '{user['email']}', 
                        '{user['created_at']}')
            """
            execute_sql(insert_sql)
        
        print(f"è¿ç§»ç§Ÿæˆ· {tenant_id} çš„ç”¨æˆ·æ•°æ®å®Œæˆ")

if __name__ == "__main__":
    migrate_historical_data()
```

#### 7.5.2 æ•°æ®åŒæ­¥

**åŒå†™æ–¹æ¡ˆ**ï¼š
```python
def create_user_with_sync(user_data: dict):
    """åˆ›å»ºç”¨æˆ·ï¼ˆåŒå†™ï¼‰"""
    # å†™å…¥æ—§è¡¨
    session_old = get_old_session()
    user_old = User(**user_data)
    session_old.add(user_old)
    session_old.commit()
    session_old.close()
    
    # å†™å…¥æ–°è¡¨ï¼ˆåˆ†åº“åˆ†è¡¨ï¼‰
    session_new = sharding_router.get_session("users", tenant_id=user_data['tenant_id'])
    user_new = User(**user_data)
    session_new.add(user_new)
    session_new.commit()
    session_new.close()
    
    return user_new
```

**æ•°æ®æ ¡éªŒ**ï¼š
```python
def validate_data_migration():
    """éªŒè¯æ•°æ®è¿ç§»"""
    # æŸ¥è¯¢æ—§è¡¨æ•°æ®é‡
    old_count = execute_sql("SELECT COUNT(*) as count FROM users")
    
    # æŸ¥è¯¢æ–°è¡¨æ•°æ®é‡
    new_count = 0
    for i in range(10):
        table_name = f"users_{i}"
        count = execute_sql(f"SELECT COUNT(*) as count FROM {table_name}")
        new_count += count[0]['count']
    
    # å¯¹æ¯”æ•°æ®é‡
    if old_count[0]['count'] == new_count:
        print("æ•°æ®è¿ç§»éªŒè¯é€šè¿‡")
    else:
        print(f"æ•°æ®è¿ç§»éªŒè¯å¤±è´¥ï¼šæ—§è¡¨{old_count[0]['count']}æ¡ï¼Œæ–°è¡¨{new_count}æ¡")

if __name__ == "__main__":
    validate_data_migration()
```

### 7.6 åˆ†åº“åˆ†è¡¨æœ€ä½³å®è·µ

**åˆ†åº“åˆ†è¡¨è®¾è®¡åŸåˆ™**ï¼š
- âœ… æ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©åˆé€‚çš„åˆ†åº“åˆ†è¡¨ç­–ç•¥
- âœ… åˆ†åº“åˆ†è¡¨é”®è¦é€‰æ‹©é«˜é€‰æ‹©æ€§å­—æ®µ
- âœ… é¢„ç•™è¶³å¤Ÿçš„åˆ†åº“åˆ†è¡¨æ•°é‡
- âœ… è€ƒè™‘æ•°æ®è¿ç§»å’Œæ‰©å®¹æ–¹æ¡ˆ

**åˆ†åº“åˆ†è¡¨æ³¨æ„äº‹é¡¹**ï¼š
- âŒ é¿å…è·¨åº“äº‹åŠ¡ï¼ˆä½¿ç”¨åˆ†å¸ƒå¼äº‹åŠ¡ï¼‰
- âŒ é¿å…è·¨åº“JOINï¼ˆåœ¨åº”ç”¨å±‚å¤„ç†ï¼‰
- âŒ é¿å…å…¨å±€å”¯ä¸€IDï¼ˆä½¿ç”¨åˆ†å¸ƒå¼IDç”Ÿæˆå™¨ï¼‰
- âŒ é¿å…å¤æ‚çš„åˆ†é¡µæŸ¥è¯¢ï¼ˆä½¿ç”¨æ¸¸æ ‡åˆ†é¡µï¼‰

**åˆ†åº“åˆ†è¡¨ç›‘æ§**ï¼š
- âœ… ç›‘æ§å„åº“å„è¡¨çš„æ•°æ®é‡
- âœ… ç›‘æ§å„åº“å„è¡¨çš„QPS
- âœ… ç›‘æ§æ•°æ®è¿ç§»è¿›åº¦
- âœ… ç›‘æ§æ•°æ®ä¸€è‡´æ€§

---

## 8. æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 8.1 æŸ¥è¯¢ä¼˜åŒ–

- âœ… ä½¿ç”¨EXPLAINåˆ†ææŸ¥è¯¢è®¡åˆ’
- âœ… é¿å…SELECT *ï¼ŒåªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ
- âœ… ä½¿ç”¨JOINä»£æ›¿å­æŸ¥è¯¢
- âœ… ä½¿ç”¨LIMITé™åˆ¶è¿”å›ç»“æœæ•°é‡
- âœ… è¯¦è§ç¬¬5ç« ç´¢å¼•ä¼˜åŒ–ç­–ç•¥

### 8.2 è¿æ¥æ± ä¼˜åŒ–

### 8.3 åˆ†åŒºç­–ç•¥

```python
# è¿æ¥æ± é…ç½®
pool_size = 10          # è¿æ¥æ± å¤§å°
max_overflow = 20       # æœ€å¤§æº¢å‡ºè¿æ¥æ•°
pool_timeout = 30       # è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
pool_recycle = 3600     # è¿æ¥å›æ”¶æ—¶é—´ï¼ˆç§’ï¼‰
```

### 8.4 è¯»å†™åˆ†ç¦»

å¯¹äºå¤§è¡¨ï¼ˆå¦‚mcp_tool_call_logsã€operation_logsï¼‰ï¼Œå»ºè®®æŒ‰æ—¶é—´åˆ†åŒºï¼š

```sql
-- æŒ‰æœˆåˆ†åŒº
CREATE TABLE mcp_tool_call_logs (
    id BIGINT,
    created_at DATETIME,
    ...
) PARTITION BY RANGE (YEAR(created_at) * 100 + MONTH(created_at)) (
    PARTITION p202401 VALUES LESS THAN (202402),
    PARTITION p202402 VALUES LESS THAN (202403),
    ...
);
```

å¯¹äºè¯»å¤šå†™å°‘çš„åœºæ™¯ï¼Œå»ºè®®ä½¿ç”¨è¯»å†™åˆ†ç¦»ï¼š

```python
# è¯»å†™åˆ†ç¦»é…ç½®
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

# ä¸»åº“ï¼ˆå†™ï¼‰
master_engine = create_engine('mysql://user:pass@master:3306/db')

# ä»åº“ï¼ˆè¯»ï¼‰
slave_engine = create_engine('mysql://user:pass@slave1:3306/db')

# è·¯ç”±å™¨
class MasterSlaveRouter:
    def routing_session(self, session):
        if session.is_modified:
            return master_engine
        else:
            return slave_engine
```

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [æŠ€æœ¯æ¶æ„è®¾è®¡æ–‡æ¡£](./2-æŠ€æœ¯æ¶æ„è®¾è®¡æ–‡æ¡£.md)
- [APIæ¥å£è®¾è®¡æ–‡æ¡£](./4-APIæ¥å£è®¾è®¡æ–‡æ¡£.md)
- [ç¯å¢ƒé…ç½®æ–‡æ¡£](./7-ç¯å¢ƒé…ç½®æ–‡æ¡£.md)

---

## ğŸ’¡ æ³¨æ„äº‹é¡¹

1. **ç´¢å¼•ç­–ç•¥**ï¼šåˆç†åˆ›å»ºç´¢å¼•ï¼Œé¿å…è¿‡å¤šç´¢å¼•å½±å“æ€§èƒ½
2. **æ•°æ®ç±»å‹**ï¼šé€‰æ‹©åˆé€‚çš„æ•°æ®ç±»å‹ï¼Œé¿å…æµªè´¹ç©ºé—´
3. **å¤–é”®çº¦æŸ**ï¼šåˆç†ä½¿ç”¨å¤–é”®ï¼Œä¿è¯æ•°æ®å®Œæ•´æ€§
4. **å­—ç¬¦é›†**ï¼šç»Ÿä¸€ä½¿ç”¨utf8mb4å­—ç¬¦é›†ï¼Œæ”¯æŒemoji
5. **æ—¶åŒº**ï¼šç»Ÿä¸€ä½¿ç”¨UTCæ—¶åŒºï¼Œé¿å…æ—¶åŒºé—®é¢˜

---

**æ–‡æ¡£ç‰ˆæœ¬å†å²**ï¼š

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | å˜æ›´è¯´æ˜ |
|-----|------|------|---------|
| v1.0 | 2026-01-13 | AIåŠ©æ‰‹ | åˆå§‹ç‰ˆæœ¬ |

---