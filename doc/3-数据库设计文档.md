# 数据库设计文档

## 📋 文档信息

- **项目名称**：企业级AI综合管理平台
- **文档版本**：v1.0
- **创建日期**：2026-01-13
- **最后更新**：2026-01-16
- **文档类型**：数据库设计文档
- **当前状态**：后端业务功能开发完成（100%），准备开始测试和前端开发

---

## 1. 数据库选型说明

### 1.1 主数据库：MySQL

**选型理由**：
- ✅ 成熟稳定，广泛使用
- ✅ 性能优秀，支持高并发
- ✅ 生态完善，工具丰富
- ✅ 支持事务、索引、存储过程
- ✅ 开源免费，成本低

**版本要求**：MySQL 8.0+

### 1.2 可选数据库

| 数据库 | 版本 | 用途 | 选型理由 |
|-------|------|------|---------|
| **PostgreSQL** | 15+ | 多数据源支持 | 功能强大、支持复杂查询、开源 |
| **Oracle** | 19c+ | 多数据源支持 | 企业级、功能强大、适合大型企业 |

---

## 2. ER图设计

```mermaid
erDiagram
    TENANT ||--o{ USER : contains
    TENANT ||--o{ DEPARTMENT : contains
    TENANT ||--o{ ROLE : contains
    TENANT ||--o{ MENU : contains
    TENANT ||--o{ MCP_TOOL : contains
    
    DEPARTMENT ||--o{ USER : belongs_to
    DEPARTMENT ||--o{ DEPARTMENT : parent_of
    
    USER ||--o{ USER_ROLE : has
    ROLE ||--o{ USER_ROLE : assigned_to
    
    ROLE ||--o{ ROLE_PERMISSION : has
    PERMISSION ||--o{ ROLE_PERMISSION : assigned_to
    
    ROLE ||--o{ ROLE_MENU : has
    MENU ||--o{ ROLE_MENU : assigned_to
    
    MCP_TOOL ||--o{ MCP_TOOL_CALL_LOG : generates
    
    USER ||--o{ LOGIN_LOG : generates
    USER ||--o{ OPERATION_LOG : generates
    
    TENANT ||--o{ TENANT_PACKAGE : has
    TENANT_PACKAGE ||--o{ PACKAGE_MENU : contains
    TENANT_PACKAGE ||--o{ PACKAGE_OPERATION : contains
    
    DICT ||--o{ DICT_ITEM : contains
    
    API_ENDPOINT ||--o| MCP_TOOL : registered_as
    
    NOTIFICATION ||--o{ NOTIFICATION_READ : read_by
    
    TENANT {
        string id PK
        string name
        string code
        string status
        datetime created_at
        datetime updated_at
    }
    
    USER {
        string id PK
        string tenant_id FK
        string username
        string password
        string email
        string phone
        string dept_id FK
        string position_id FK
        string status
        datetime created_at
        datetime updated_at
    }
    
    DEPARTMENT {
        string id PK
        string tenant_id FK
        string name
        string code
        string parent_id FK
        int level
        string status
        datetime created_at
        datetime updated_at
    }
    
    ROLE {
        string id PK
        string tenant_id FK
        string name
        string code
        string description
        string status
        datetime created_at
        datetime updated_at
    }
    
    PERMISSION {
        string id PK
        string name
        string code
        string type
        string description
        datetime created_at
        datetime updated_at
    }
    
    MENU {
        string id PK
        string tenant_id FK
        string name
        string path
        string icon
        string parent_id FK
        int sort_order
        string status
        datetime created_at
        datetime updated_at
    }
    
    MCP_TOOL {
        string id PK
        string tenant_id FK
        string name
        string description
        string api_path
        string api_method
        string tool_type
        string auth_type
        int timeout
        int max_retries
        string status
        int call_count
        int success_count
        int failure_count
        int avg_response_time
        datetime created_at
        datetime updated_at
    }
    
    MCP_TOOL_CALL_LOG {
        string id PK
        string tool_id FK
        string caller_id
        string caller_type
        string tenant_id FK
        json request_params
        int response_status
        json response_data
        int response_time
        string error_message
        datetime created_at
    }
    
    LOGIN_LOG {
        string id PK
        string user_id FK
        string tenant_id FK
        string ip_address
        string user_agent
        string login_status
        string error_message
        datetime created_at
    }
    
    OPERATION_LOG {
        string id PK
        string user_id FK
        string tenant_id FK
        string module
        string operation
        string method
        string path
        json request_params
        json response_data
        int response_status
        int response_time
        datetime created_at
    }
    
    TENANT_PACKAGE {
        string id PK
        string tenant_id FK
        string name
        string description
        json features
        string status
        datetime created_at
        datetime updated_at
    }
    
    DICT {
        string id PK
        string tenant_id FK
        string type
        string name
        string description
        string status
        datetime created_at
        datetime updated_at
    }
    
    DICT_ITEM {
        string id PK
        string dict_id FK
        string label
        string value
        int sort_order
        string status
        datetime created_at
        datetime updated_at
    }
    
    API_ENDPOINT {
        string id PK
        string path
        string method
        string module
        string description
        boolean is_mcp_tool
        int mcp_tool_id FK
        json required_scopes
        boolean is_enabled
        datetime created_at
        datetime updated_at
    }
    
    NOTIFICATION {
        string id PK
        string tenant_id FK
        string type
        string title
        string content
        string sender_id
        json receiver_ids
        string status
        datetime created_at
        datetime updated_at
    }
```

---

## 2.5 Mixin类设计

### 2.5.1 Mixin类概述

Mixin类是一种代码复用模式，通过多重继承的方式为模型提供通用的字段和方法。在本项目中，我们定义了5个Mixin类，用于为不同的数据模型提供审计字段、时间戳字段和软删除功能。

### 2.5.2 Mixin类定义

#### 2.5.2.1 TimestampMixin（时间戳混入类）

**功能**：提供创建时间和更新时间字段

**字段**：
- `created_at`: 创建时间（DATETIME，默认当前时间，不允许为空）
- `updated_at`: 更新时间（DATETIME，默认当前时间，更新时自动更新，不允许为空）

**适用场景**：所有需要记录创建和更新时间的实体

**使用示例**：
```python
class Dict(BaseModel, TimestampMixin):
    """字典表"""
    __tablename__ = 'dicts'
    # ... 其他字段
```

**对应的表字段**：
```sql
CREATE TABLE dicts (
    -- ... 其他字段
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间'
);
```

#### 2.5.2.2 SoftDeleteMixin（软删除混入类）

**功能**：提供软删除功能，通过标记删除而不是物理删除数据

**字段**：
- `is_deleted`: 是否删除（BOOLEAN，默认FALSE，不允许为空）
- `deleted_at`: 删除时间（DATETIME，允许为空）

**适用场景**：需要保留历史数据、支持数据恢复的实体

**使用示例**：
```python
class ExampleModel(BaseModel, SoftDeleteMixin):
    """示例模型"""
    __tablename__ = 'example'
    # ... 其他字段
```

**对应的表字段**：
```sql
CREATE TABLE example (
    -- ... 其他字段
    is_deleted BOOLEAN NOT NULL DEFAULT FALSE COMMENT '是否删除',
    deleted_at DATETIME COMMENT '删除时间'
);
```

#### 2.5.2.3 AuditMixin（审计混入类）

**功能**：提供审计字段，记录数据的创建人、更新人和删除人

**字段**：
- `created_by`: 创建人（VARCHAR(50)，允许为空）
- `updated_by`: 更新人（VARCHAR(50)，允许为空）
- `deleted_by`: 删除人（VARCHAR(50)，允许为空）

**适用场景**：需要追踪数据变更历史的实体

**使用示例**：
```python
class ExampleModel(BaseModel, AuditMixin):
    """示例模型"""
    __tablename__ = 'example'
    # ... 其他字段
```

**对应的表字段**：
```sql
CREATE TABLE example (
    -- ... 其他字段
    created_by VARCHAR(50) COMMENT '创建人',
    updated_by VARCHAR(50) COMMENT '更新人',
    deleted_by VARCHAR(50) COMMENT '删除人'
);
```

#### 2.5.2.4 FullModelMixin（完整模型混入类）

**功能**：组合TimestampMixin、SoftDeleteMixin和AuditMixin，提供完整的审计和时间戳功能

**字段**：
- `created_at`: 创建时间（DATETIME，默认当前时间，不允许为空）
- `updated_at`: 更新时间（DATETIME，默认当前时间，更新时自动更新，不允许为空）
- `is_deleted`: 是否删除（BOOLEAN，默认FALSE，不允许为空）
- `deleted_at`: 删除时间（DATETIME，允许为空）
- `created_by`: 创建人（VARCHAR(50)，允许为空）
- `updated_by`: 更新人（VARCHAR(50)，允许为空）
- `deleted_by`: 删除人（VARCHAR(50)，允许为空）

**适用场景**：核心业务实体，需要完整的审计和时间戳功能

**使用示例**：
```python
class User(BaseModel, FullModelMixin):
    """用户表"""
    __tablename__ = 'users'
    # ... 其他字段
```

**对应的表字段**：
```sql
CREATE TABLE users (
    -- ... 其他字段
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    is_deleted BOOLEAN NOT NULL DEFAULT FALSE COMMENT '是否删除',
    deleted_at DATETIME COMMENT '删除时间',
    created_by VARCHAR(50) COMMENT '创建人',
    updated_by VARCHAR(50) COMMENT '更新人',
    deleted_by VARCHAR(50) COMMENT '删除人'
);
```

#### 2.5.2.5 CreatedAtMixin（仅创建时间混入类）

**功能**：仅提供创建时间字段，用于日志类表

**字段**：
- `created_at`: 创建时间（DATETIME，默认当前时间，不允许为空）

**适用场景**：日志类表，只需要记录创建时间，不需要更新时间

**使用示例**：
```python
class LoginLog(BaseModel, CreatedAtMixin):
    """登录日志表"""
    __tablename__ = 'login_logs'
    # ... 其他字段
```

**对应的表字段**：
```sql
CREATE TABLE login_logs (
    -- ... 其他字段
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间'
);
```

### 2.5.3 Mixin类使用规范

#### 2.5.3.1 选择合适的Mixin类

| Mixin类 | 字段数 | 适用场景 | 示例表 |
|---------|--------|---------|--------|
| TimestampMixin | 2 | 需要记录创建和更新时间 | dicts, dict_items, menus |
| SoftDeleteMixin | 2 | 需要软删除功能 | （通常不单独使用） |
| AuditMixin | 3 | 需要审计字段 | （通常不单独使用） |
| FullModelMixin | 7 | 核心业务实体，需要完整审计 | users, roles, departments, tenants |
| CreatedAtMixin | 1 | 日志类表 | login_logs, operation_logs, workflow_logs |

#### 2.5.3.2 Mixin类继承规则

1. **核心业务实体**：继承FullModelMixin
   - 用户、角色、部门、租户等
   - MCP工具、工作流定义、工作流实例等
   - 需要完整的审计和时间戳功能

2. **配置类实体**：继承TimestampMixin
   - 字典、字典项、菜单等
   - 只需要记录创建和更新时间

3. **日志类实体**：继承CreatedAtMixin
   - 登录日志、操作日志、工作流日志等
   - 只需要记录创建时间，不需要更新

4. **特殊场景**：
   - 单独使用SoftDeleteMixin或AuditMixin的情况较少
   - 通常使用组合Mixin类（FullModelMixin）

#### 2.5.3.3 Mixin类实现示例

```python
from sqlalchemy import Column, String, DateTime, Boolean
from sqlalchemy.orm import Mapped, mapped_column
from datetime import datetime
from .base import BaseModel

class TimestampMixin:
    """时间戳混入类"""
    created_at: Mapped[datetime] = mapped_column(DateTime, default=datetime.now, nullable=False, comment='创建时间')
    updated_at: Mapped[datetime] = mapped_column(DateTime, default=datetime.now, onupdate=datetime.now, nullable=False, comment='更新时间')

class SoftDeleteMixin:
    """软删除混入类"""
    is_deleted: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False, comment='是否删除')
    deleted_at: Mapped[datetime] = mapped_column(DateTime, nullable=True, comment='删除时间')

class AuditMixin:
    """审计混入类"""
    created_by: Mapped[str] = mapped_column(String(50), nullable=True, comment='创建人')
    updated_by: Mapped[str] = mapped_column(String(50), nullable=True, comment='更新人')
    deleted_by: Mapped[str] = mapped_column(String(50), nullable=True, comment='删除人')

class FullModelMixin(TimestampMixin, SoftDeleteMixin, AuditMixin):
    """完整模型混入类（组合以上三个Mixin）"""
    pass

class CreatedAtMixin:
    """仅创建时间混入类"""
    created_at: Mapped[datetime] = mapped_column(DateTime, default=datetime.now, nullable=False, comment='创建时间')
```

### 2.5.4 Mixin类在表结构设计中的应用

#### 2.5.4.1 核心业务表（FullModelMixin）

以下表使用FullModelMixin：
- 用户表（users）
- 角色表（roles）
- 部门表（departments）
- 租户表（tenants）
- MCP工具表（mcp_tools）
- 工作流定义表（workflow_definitions）
- 工作流实例表（workflow_instances）
- 工作流模板表（workflow_templates）
- 待办任务表（todo_tasks）

#### 2.5.4.2 配置类表（TimestampMixin）

以下表使用TimestampMixin：
- 字典表（dicts）
- 字典项表（dict_items）
- 菜单表（menus）
- 权限表（permissions）
- 系统通知表（notifications）
- 错误码表（error_codes）
- 工作流节点表（workflow_nodes）
- 工作流任务表（workflow_tasks）
- 每日计划表（daily_plans）
- 任务提醒表（todo_reminders）
- 待办任务标签表（todo_tags）
- 待办任务附件表（todo_attachments）
- 消息表（messages）
- 消息阅读记录表（message_reads）
- 通知公告表（announcements）
- 通知公告阅读记录表（announcement_reads）
- 数据范围类型表（data_scopes）
- 用户数据范围权限表（user_data_scopes）
- 岗位表（positions）
- 地区表（regions）
- 敏感词表（sensitive_words）

#### 2.5.4.3 日志类表（CreatedAtMixin）

以下表使用CreatedAtMixin：
- 登录日志表（login_logs）
- 操作日志表（operation_logs）
- 工作流日志表（workflow_logs）

### 2.5.5 Mixin类优势

1. **代码复用**：避免在每个模型中重复定义相同的字段
2. **一致性**：确保所有模型的审计字段定义一致
3. **可维护性**：修改Mixin类即可影响所有继承它的模型
4. **灵活性**：可以根据需要组合不同的Mixin类
5. **可扩展性**：可以轻松添加新的Mixin类或扩展现有Mixin类

---

## 3. 表结构设计

### 3.1 租户表（tenants）

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 |
|-------|------|------|--------|--------|------|
| id | VARCHAR | 50 | NO | - | 租户ID（主键） |
| name | VARCHAR | 100 | NO | - | 租户名称 |
| code | VARCHAR | 50 | NO | - | 租户编码（唯一） |
| status | VARCHAR | 20 | NO | active | 状态（active/inactive） |
| description | TEXT | - | YES | NULL | 描述 |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引**：
- PRIMARY KEY (id)
- UNIQUE KEY uk_code (code)
- INDEX idx_status (status)

### 3.2 用户表（users）

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 |
|-------|------|------|--------|--------|------|
| id | VARCHAR | 50 | NO | - | 用户ID（主键） |
| tenant_id | VARCHAR | 50 | NO | - | 租户ID（外键） |
| username | VARCHAR | 50 | NO | - | 用户名（唯一） |
| password | VARCHAR | 255 | NO | - | 密码（加密） |
| email | VARCHAR | 100 | YES | NULL | 邮箱 |
| phone | VARCHAR | 20 | YES | NULL | 手机号 |
| dept_id | VARCHAR | 50 | YES | NULL | 部门ID（外键） |
| position_id | VARCHAR | 50 | YES | NULL | 岗位ID（外键） |
| status | VARCHAR | 20 | NO | active | 状态（active/inactive/locked） |
| last_login_at | DATETIME | - | YES | NULL | 最后登录时间 |
| last_login_ip | VARCHAR | 50 | YES | NULL | 最后登录IP |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引**：
- PRIMARY KEY (id)
- UNIQUE KEY uk_tenant_username (tenant_id, username)
- INDEX idx_tenant_id (tenant_id)
- INDEX idx_dept_id (dept_id)
- INDEX idx_status (status)

**外键**：
- FOREIGN KEY (tenant_id) REFERENCES tenants(id)
- FOREIGN KEY (dept_id) REFERENCES departments(id)

### 3.3 部门表（departments）

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 |
|-------|------|------|--------|--------|------|
| id | VARCHAR | 50 | NO | - | 部门ID（主键） |
| tenant_id | VARCHAR | 50 | NO | - | 租户ID（外键） |
| name | VARCHAR | 100 | NO | - | 部门名称 |
| code | VARCHAR | 100 | NO | - | 部门编码（如dept001/child002） |
| parent_id | VARCHAR | 50 | YES | NULL | 父部门ID（外键） |
| level | INT | - | NO | 1 | 层级（1-5） |
| sort_order | INT | - | NO | 0 | 排序 |
| status | VARCHAR | 20 | NO | active | 状态（active/inactive） |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引**：
- PRIMARY KEY (id)
- UNIQUE KEY uk_tenant_code (tenant_id, code)
- INDEX idx_tenant_id (tenant_id)
- INDEX idx_parent_id (parent_id)
- INDEX idx_level (level)

**外键**：
- FOREIGN KEY (tenant_id) REFERENCES tenants(id)
- FOREIGN KEY (parent_id) REFERENCES departments(id)

### 3.4 角色表（roles）

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 |
|-------|------|------|--------|--------|------|
| id | VARCHAR | 50 | NO | - | 角色ID（主键） |
| tenant_id | VARCHAR | 50 | NO | - | 租户ID（外键） |
| name | VARCHAR | 100 | NO | - | 角色名称 |
| code | VARCHAR | 50 | NO | - | 角色编码（唯一） |
| description | TEXT | - | YES | NULL | 描述 |
| is_system | BOOLEAN | - | NO | FALSE | 是否系统角色 |
| status | VARCHAR | 20 | NO | active | 状态（active/inactive） |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引**：
- PRIMARY KEY (id)
- UNIQUE KEY uk_tenant_code (tenant_id, code)
- INDEX idx_tenant_id (tenant_id)
- INDEX idx_is_system (is_system)

**外键**：
- FOREIGN KEY (tenant_id) REFERENCES tenants(id)

### 3.5 权限表（permissions）

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 |
|-------|------|------|--------|--------|------|
| id | VARCHAR | 50 | NO | - | 权限ID（主键） |
| name | VARCHAR | 100 | NO | - | 权限名称 |
| code | VARCHAR | 100 | NO | - | 权限编码（如user:create） |
| type | VARCHAR | 20 | NO | - | 类型（menu/operation/button） |
| description | TEXT | - | YES | NULL | 描述 |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引**：
- PRIMARY KEY (id)
- UNIQUE KEY uk_code (code)
- INDEX idx_type (type)

### 3.6 菜单表（menus）

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 |
|-------|------|------|--------|--------|------|
| id | VARCHAR | 50 | NO | - | 菜单ID（主键） |
| tenant_id | VARCHAR | 50 | NO | - | 租户ID（外键） |
| name | VARCHAR | 100 | NO | - | 菜单名称 |
| path | VARCHAR | 255 | YES | NULL | 菜单路径 |
| icon | VARCHAR | 100 | YES | NULL | 菜单图标 |
| parent_id | VARCHAR | 50 | YES | NULL | 父菜单ID（外键） |
| sort_order | INT | - | NO | 0 | 排序 |
| is_visible | BOOLEAN | - | NO | TRUE | 是否可见 |
| status | VARCHAR | 20 | NO | active | 状态（active/inactive） |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引**：
- PRIMARY KEY (id)
- INDEX idx_tenant_id (tenant_id)
- INDEX idx_parent_id (parent_id)
- INDEX idx_sort_order (sort_order)

**外键**：
- FOREIGN KEY (tenant_id) REFERENCES tenants(id)
- FOREIGN KEY (parent_id) REFERENCES menus(id)

### 3.7 MCP工具表（mcp_tools）

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 |
|-------|------|------|--------|--------|------|
| id | INT | - | NO | AUTO_INCREMENT | 工具ID（主键） |
| tenant_id | VARCHAR | 50 | NO | - | 租户ID（外键） |
| name | VARCHAR | 100 | NO | - | 工具名称 |
| description | TEXT | - | YES | NULL | 工具描述 |
| api_path | VARCHAR | 255 | NO | - | API路径 |
| api_method | VARCHAR | 10 | NO | - | API方法（GET/POST/PUT/DELETE） |
| api_module | VARCHAR | 100 | YES | NULL | API所属模块 |
| tool_type | VARCHAR | 50 | YES | NULL | 工具类型（api/external/script） |
| external_url | VARCHAR | 500 | YES | NULL | 外部URL |
| auth_type | VARCHAR | 50 | YES | NULL | 鉴权方式（none/bearer/api_key/oauth） |
| auth_config | JSON | - | YES | NULL | 鉴权配置 |
| timeout | INT | - | NO | 30 | 超时时间（秒） |
| max_retries | INT | - | NO | 3 | 最大重试次数 |
| is_enabled | BOOLEAN | - | NO | TRUE | 是否启用 |
| is_public | BOOLEAN | - | NO | FALSE | 是否公开 |
| call_count | INT | - | NO | 0 | 调用次数 |
| success_count | INT | - | NO | 0 | 成功次数 |
| failure_count | INT | - | NO | 0 | 失败次数 |
| avg_response_time | INT | - | NO | 0 | 平均响应时间（毫秒） |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引**：
- PRIMARY KEY (id)
- INDEX idx_tenant_id (tenant_id)
- INDEX idx_api_path (api_path, api_method)
- INDEX idx_is_enabled (is_enabled)

**外键**：
- FOREIGN KEY (tenant_id) REFERENCES tenants(id)

### 3.8 MCP工具调用日志表（mcp_tool_call_logs）

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 |
|-------|------|------|--------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 日志ID（主键） |
| tool_id | INT | - | NO | - | 工具ID（外键） |
| caller_id | VARCHAR | 50 | NO | - | 调用者ID |
| caller_type | VARCHAR | 20 | NO | - | 调用者类型（user/api_key） |
| tenant_id | VARCHAR | 50 | NO | - | 租户ID（外键） |
| request_params | JSON | - | YES | NULL | 请求参数 |
| request_headers | JSON | - | YES | NULL | 请求头 |
| response_status | INT | - | YES | NULL | 响应状态码 |
| response_data | JSON | - | YES | NULL | 响应数据 |
| response_time | INT | - | YES | NULL | 响应时间（毫秒） |
| error_message | TEXT | - | YES | NULL | 错误信息 |
| error_stack | TEXT | - | YES | NULL | 错误堆栈 |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 调用时间 |

**索引**：
- PRIMARY KEY (id)
- INDEX idx_tool_id (tool_id)
- INDEX idx_caller_id (caller_id)
- INDEX idx_tenant_id (tenant_id)
- INDEX idx_created_at (created_at)

**外键**：
- FOREIGN KEY (tool_id) REFERENCES mcp_tools(id)

### 3.9 登录日志表（login_logs）

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 |
|-------|------|------|--------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 日志ID（主键） |
| user_id | VARCHAR | 50 | NO | - | 用户ID（外键） |
| tenant_id | VARCHAR | 50 | NO | - | 租户ID（外键） |
| ip_address | VARCHAR | 50 | NO | - | IP地址 |
| user_agent | VARCHAR | 500 | YES | NULL | 用户代理 |
| login_status | VARCHAR | 20 | NO | - | 登录状态（success/failed） |
| error_message | TEXT | - | YES | NULL | 错误信息 |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 登录时间 |

**索引**：
- PRIMARY KEY (id)
- INDEX idx_user_id (user_id)
- INDEX idx_tenant_id (tenant_id)
- INDEX idx_ip_address (ip_address)
- INDEX idx_created_at (created_at)

**外键**：
- FOREIGN KEY (user_id) REFERENCES users(id)
- FOREIGN KEY (tenant_id) REFERENCES tenants(id)

### 3.10 操作日志表（operation_logs）

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 |
|-------|------|------|--------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 日志ID（主键） |
| user_id | VARCHAR | 50 | NO | - | 用户ID（外键） |
| tenant_id | VARCHAR | 50 | NO | - | 租户ID（外键） |
| module | VARCHAR | 50 | NO | - | 模块 |
| operation | VARCHAR | 50 | NO | - | 操作 |
| method | VARCHAR | 10 | NO | - | 请求方法 |
| path | VARCHAR | 255 | NO | - | 请求路径 |
| request_params | JSON | - | YES | NULL | 请求参数 |
| response_data | JSON | - | YES | NULL | 响应数据 |
| response_status | INT | - | NO | - | 响应状态码 |
| response_time | INT | - | YES | NULL | 响应时间（毫秒） |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 操作时间 |

**索引**：
- PRIMARY KEY (id)
- INDEX idx_user_id (user_id)
- INDEX idx_tenant_id (tenant_id)
- INDEX idx_module (module)
- INDEX idx_created_at (created_at)

**外键**：
- FOREIGN KEY (user_id) REFERENCES users(id)
- FOREIGN KEY (tenant_id) REFERENCES tenants(id)

### 3.11 字典表（dicts）

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 |
|-------|------|------|--------|--------|------|
| id | VARCHAR | 50 | NO | - | 字典ID（主键） |
| tenant_id | VARCHAR | 50 | NO | - | 租户ID（外键） |
| type | VARCHAR | 50 | NO | - | 字典类型 |
| name | VARCHAR | 100 | NO | - | 字典名称 |
| description | TEXT | - | YES | NULL | 描述 |
| status | VARCHAR | 20 | NO | active | 状态（active/inactive） |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引**：
- PRIMARY KEY (id)
- UNIQUE KEY uk_tenant_type (tenant_id, type)
- INDEX idx_tenant_id (tenant_id)

**外键**：
- FOREIGN KEY (tenant_id) REFERENCES tenants(id)

### 3.12 字典项表（dict_items）

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 |
|-------|------|------|--------|--------|------|
| id | VARCHAR | 50 | NO | - | 字典项ID（主键） |
| dict_id | VARCHAR | 50 | NO | - | 字典ID（外键） |
| label | VARCHAR | 100 | NO | - | 标签 |
| value | VARCHAR | 100 | NO | - | 值 |
| sort_order | INT | - | NO | 0 | 排序 |
| status | VARCHAR | 20 | NO | active | 状态（active/inactive） |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引**：
- PRIMARY KEY (id)
- INDEX idx_dict_id (dict_id)
- INDEX idx_sort_order (sort_order)

**外键**：
- FOREIGN KEY (dict_id) REFERENCES dicts(id)

### 3.13 API端点表（api_endpoints）

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 |
|-------|------|------|--------|--------|------|
| id | INT | - | NO | AUTO_INCREMENT | 端点ID（主键） |
| path | VARCHAR | 255 | NO | - | API路径 |
| method | VARCHAR | 10 | NO | - | API方法 |
| module | VARCHAR | 100 | YES | NULL | 所属模块 |
| description | TEXT | - | YES | NULL | 接口描述 |
| is_mcp_tool | BOOLEAN | - | NO | FALSE | 是否注册为MCP工具 |
| mcp_tool_id | INT | - | YES | NULL | 关联的MCP工具ID |
| required_scopes | JSON | - | YES | NULL | 所需权限scopes |
| is_enabled | BOOLEAN | - | NO | TRUE | 是否启用 |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引**：
- PRIMARY KEY (id)
- UNIQUE KEY uk_path_method (path, method)
- INDEX idx_module (module)

**外键**：
- FOREIGN KEY (mcp_tool_id) REFERENCES mcp_tools(id)

### 3.14 通知表（notifications）

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 |
|-------|------|------|--------|--------|------|
| id | VARCHAR | 50 | NO | - | 通知ID（主键） |
| tenant_id | VARCHAR | 50 | NO | - | 租户ID（外键） |
| type | VARCHAR | 50 | NO | - | 通知类型 |
| title | VARCHAR | 200 | NO | - | 通知标题 |
| content | TEXT | - | NO | - | 通知内容 |
| sender_id | VARCHAR | 50 | YES | NULL | 发送者ID |
| receiver_ids | JSON | - | NO | - | 接收者ID列表 |
| status | VARCHAR | 20 | NO | active | 状态（active/archived） |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引**：
- PRIMARY KEY (id)
- INDEX idx_tenant_id (tenant_id)
- INDEX idx_type (type)
- INDEX idx_created_at (created_at)

**外键**：
- FOREIGN KEY (tenant_id) REFERENCES tenants(id)

### 3.15 待办任务表（todo_tasks）

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 |
|-------|------|------|--------|--------|------|
| id | VARCHAR | 50 | NO | - | 任务ID（主键） |
| tenant_id | VARCHAR | 50 | NO | - | 租户ID（外键） |
| user_id | VARCHAR | 50 | NO | - | 用户ID（外键） |
| task_type | VARCHAR | 20 | NO | - | 任务类型（personal/daily/workflow） |
| title | VARCHAR | 200 | NO | - | 任务标题 |
| description | TEXT | - | YES | NULL | 任务描述 |
| priority | VARCHAR | 20 | NO | medium | 优先级（high/medium/low） |
| status | VARCHAR | 20 | NO | pending | 状态（pending/in_progress/completed/cancelled） |
| due_date | DATETIME | - | YES | NULL | 截止时间 |
| completed_at | DATETIME | - | YES | NULL | 完成时间 |
| tags | JSON | - | YES | NULL | 标签列表 |
| attachments | JSON | - | YES | NULL | 附件列表 |
| workflow_instance_id | VARCHAR | 50 | YES | NULL | 工作流实例ID（外键，工作流任务时使用） |
| workflow_task_id | VARCHAR | 50 | YES | NULL | 工作流任务ID（外键，工作流任务时使用） |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引**：
- PRIMARY KEY (id)
- INDEX idx_tenant_id (tenant_id)
- INDEX idx_user_id (user_id)
- INDEX idx_task_type (task_type)
- INDEX idx_status (status)
- INDEX idx_due_date (due_date)
- INDEX idx_workflow_instance_id (workflow_instance_id)

**外键**：
- FOREIGN KEY (tenant_id) REFERENCES tenants(id)
- FOREIGN KEY (user_id) REFERENCES users(id)
- FOREIGN KEY (workflow_instance_id) REFERENCES workflow_instances(id)
- FOREIGN KEY (workflow_task_id) REFERENCES workflow_tasks(id)

### 3.16 每日计划表（daily_plans）

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 |
|-------|------|------|--------|--------|------|
| id | VARCHAR | 50 | NO | - | 计划ID（主键） |
| tenant_id | VARCHAR | 50 | NO | - | 租户ID（外键） |
| user_id | VARCHAR | 50 | NO | - | 用户ID（外键） |
| plan_date | DATE | - | NO | - | 计划日期 |
| total_tasks | INT | - | NO | 0 | 总任务数 |
| completed_tasks | INT | - | NO | 0 | 已完成任务数 |
| completion_rate | DECIMAL | 5,2 | NO | 0.00 | 完成率 |
| notes | TEXT | - | YES | NULL | 备注 |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引**：
- PRIMARY KEY (id)
- UNIQUE KEY uk_user_date (user_id, plan_date)
- INDEX idx_tenant_id (tenant_id)
- INDEX idx_user_id (user_id)
- INDEX idx_plan_date (plan_date)

**外键**：
- FOREIGN KEY (tenant_id) REFERENCES tenants(id)
- FOREIGN KEY (user_id) REFERENCES users(id)

### 3.17 每日计划明细表（daily_plan_items）

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 |
|-------|------|------|--------|--------|------|
| id | VARCHAR | 50 | NO | - | 明细ID（主键） |
| plan_id | VARCHAR | 50 | NO | - | 计划ID（外键） |
| todo_task_id | VARCHAR | 50 | NO | - | 待办任务ID（外键） |
| sort_order | INT | - | NO | 0 | 排序 |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |

**索引**：
- PRIMARY KEY (id)
- INDEX idx_plan_id (plan_id)
- INDEX idx_todo_task_id (todo_task_id)

**外键**：
- FOREIGN KEY (plan_id) REFERENCES daily_plans(id)
- FOREIGN KEY (todo_task_id) REFERENCES todo_tasks(id)

### 3.18 任务提醒表（todo_reminders）

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 |
|-------|------|------|--------|--------|------|
| id | VARCHAR | 50 | NO | - | 提醒ID（主键） |
| tenant_id | VARCHAR | 50 | NO | - | 租户ID（外键） |
| user_id | VARCHAR | 50 | NO | - | 用户ID（外键） |
| todo_task_id | VARCHAR | 50 | NO | - | 待办任务ID（外键） |
| reminder_type | VARCHAR | 20 | NO | - | 提醒类型（due/overdue/daily） |
| reminder_time | DATETIME | - | NO | - | 提醒时间 |
| status | VARCHAR | 20 | NO | pending | 状态（pending/sent/failed） |
| sent_at | DATETIME | - | YES | NULL | 发送时间 |
| notification_id | VARCHAR | 50 | YES | NULL | 通知ID（外键） |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |

**索引**：
- PRIMARY KEY (id)
- INDEX idx_tenant_id (tenant_id)
- INDEX idx_user_id (user_id)
- INDEX idx_todo_task_id (todo_task_id)
- INDEX idx_reminder_time (reminder_time)
- INDEX idx_status (status)

**外键**：
- FOREIGN KEY (tenant_id) REFERENCES tenants(id)
- FOREIGN KEY (user_id) REFERENCES users(id)
- FOREIGN KEY (todo_task_id) REFERENCES todo_tasks(id)
- FOREIGN KEY (notification_id) REFERENCES notifications(id)

### 3.19 工作流定义表（workflow_definitions）

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 |
|-------|------|------|--------|--------|------|
| id | VARCHAR | 50 | NO | - | 定义ID（主键） |
| tenant_id | VARCHAR | 50 | NO | - | 租户ID（外键） |
| name | VARCHAR | 100 | NO | - | 工作流名称 |
| code | VARCHAR | 50 | NO | - | 工作流编码（唯一） |
| description | TEXT | - | YES | NULL | 描述 |
| workflow_type | VARCHAR | 50 | NO | - | 工作流类型（hr/permission/finance/it/custom） |
| definition_json | JSON | - | NO | - | 工作流定义JSON |
| version | VARCHAR | 20 | NO | v1.0 | 版本号 |
| status | VARCHAR | 20 | NO | draft | 状态（draft/published/archived） |
| created_by | VARCHAR | 50 | NO | - | 创建人ID（外键） |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引**：
- PRIMARY KEY (id)
- UNIQUE KEY uk_tenant_code (tenant_id, code)
- INDEX idx_tenant_id (tenant_id)
- INDEX idx_workflow_type (workflow_type)
- INDEX idx_status (status)
- INDEX idx_created_by (created_by)

**外键**：
- FOREIGN KEY (tenant_id) REFERENCES tenants(id)
- FOREIGN KEY (created_by) REFERENCES users(id)

### 3.20 工作流实例表（workflow_instances）

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 |
|-------|------|------|--------|--------|------|
| id | VARCHAR | 50 | NO | - | 实例ID（主键） |
| tenant_id | VARCHAR | 50 | NO | - | 租户ID（外键） |
| definition_id | VARCHAR | 50 | NO | - | 定义ID（外键） |
| instance_no | VARCHAR | 50 | NO | - | 实例编号 |
| status | VARCHAR | 20 | NO | running | 状态（running/completed/failed/cancelled） |
| current_node_id | VARCHAR | 50 | YES | NULL | 当前节点ID |
| context_variables | JSON | - | YES | NULL | 上下文变量 |
| started_at | DATETIME | - | NO | - | 开始时间 |
| ended_at | DATETIME | - | YES | NULL | 结束时间 |
| created_by | VARCHAR | 50 | NO | - | 创建人ID（外键） |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引**：
- PRIMARY KEY (id)
- UNIQUE KEY uk_instance_no (instance_no)
- INDEX idx_tenant_id (tenant_id)
- INDEX idx_definition_id (definition_id)
- INDEX idx_status (status)
- INDEX idx_started_at (started_at)
- INDEX idx_created_by (created_by)

**外键**：
- FOREIGN KEY (tenant_id) REFERENCES tenants(id)
- FOREIGN KEY (definition_id) REFERENCES workflow_definitions(id)
- FOREIGN KEY (created_by) REFERENCES users(id)

### 3.21 工作流节点表（workflow_nodes）

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 |
|-------|------|------|--------|--------|------|
| id | VARCHAR | 50 | NO | - | 节点ID（主键） |
| definition_id | VARCHAR | 50 | NO | - | 定义ID（外键） |
| node_id | VARCHAR | 50 | NO | - | 节点ID |
| node_type | VARCHAR | 50 | NO | - | 节点类型（start/end/form/approval/condition/parallel/action/wait/loop/mcp/subflow） |
| node_name | VARCHAR | 100 | NO | - | 节点名称 |
| node_config_json | JSON | - | YES | NULL | 节点配置JSON |
| sort_order | INT | - | NO | 0 | 排序 |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引**：
- PRIMARY KEY (id)
- INDEX idx_definition_id (definition_id)
- INDEX idx_node_id (node_id)
- INDEX idx_node_type (node_type)

**外键**：
- FOREIGN KEY (definition_id) REFERENCES workflow_definitions(id)

### 3.22 工作流任务表（workflow_tasks）

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 |
|-------|------|------|--------|--------|------|
| id | VARCHAR | 50 | NO | - | 任务ID（主键） |
| tenant_id | VARCHAR | 50 | NO | - | 租户ID（外键） |
| instance_id | VARCHAR | 50 | NO | - | 实例ID（外键） |
| node_id | VARCHAR | 50 | NO | - | 节点ID（外键） |
| task_name | VARCHAR | 100 | NO | - | 任务名称 |
| task_type | VARCHAR | 20 | NO | - | 任务类型（approval/notification/action） |
| status | VARCHAR | 20 | NO | pending | 状态（pending/in_progress/completed/rejected/transferred/cancelled） |
| assigned_to | VARCHAR | 50 | YES | NULL | 分配给用户ID（外键） |
| task_data | JSON | - | YES | NULL | 任务数据 |
| approval_action | VARCHAR | 20 | YES | NULL | 审批操作（agree/reject/transfer） |
| approval_comment | TEXT | - | YES | NULL | 审批意见 |
| completed_at | DATETIME | - | YES | NULL | 完成时间 |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引**：
- PRIMARY KEY (id)
- INDEX idx_tenant_id (tenant_id)
- INDEX idx_instance_id (instance_id)
- INDEX idx_node_id (node_id)
- INDEX idx_assigned_to (assigned_to)
- INDEX idx_status (status)
- INDEX idx_created_at (created_at)

**外键**：
- FOREIGN KEY (tenant_id) REFERENCES tenants(id)
- FOREIGN KEY (instance_id) REFERENCES workflow_instances(id)
- FOREIGN KEY (node_id) REFERENCES workflow_nodes(id)
- FOREIGN KEY (assigned_to) REFERENCES users(id)

### 3.23 工作流日志表（workflow_logs）

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 |
|-------|------|------|--------|--------|------|
| id | VARCHAR | 50 | NO | - | 日志ID（主键） |
| tenant_id | VARCHAR | 50 | NO | - | 租户ID（外键） |
| instance_id | VARCHAR | 50 | NO | - | 实例ID（外键） |
| log_type | VARCHAR | 20 | NO | - | 日志类型（info/warning/error） |
| log_message | TEXT | - | NO | - | 日志消息 |
| log_data | JSON | - | YES | NULL | 日志数据 |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |

**索引**：
- PRIMARY KEY (id)
- INDEX idx_tenant_id (tenant_id)
- INDEX idx_instance_id (instance_id)
- INDEX idx_log_type (log_type)
- INDEX idx_created_at (created_at)

**外键**：
- FOREIGN KEY (tenant_id) REFERENCES tenants(id)
- FOREIGN KEY (instance_id) REFERENCES workflow_instances(id)

### 3.24 工作流模板表（workflow_templates）

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 |
|-------|------|------|--------|--------|------|
| id | VARCHAR | 50 | NO | - | 模板ID（主键） |
| tenant_id | VARCHAR | 50 | NO | - | 租户ID（外键，NULL表示系统模板） |
| template_type | VARCHAR | 50 | NO | - | 模板类型（hr/permission/finance/it） |
| template_name | VARCHAR | 100 | NO | - | 模板名称 |
| template_code | VARCHAR | 50 | NO | - | 模板编码 |
| description | TEXT | - | YES | NULL | 描述 |
| definition_json | JSON | - | NO | - | 工作流定义JSON |
| is_system | BOOLEAN | - | NO | FALSE | 是否系统模板 |
| status | VARCHAR | 20 | NO | active | 状态（active/inactive） |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引**：
- PRIMARY KEY (id)
- UNIQUE KEY uk_template_code (template_code)
- INDEX idx_tenant_id (tenant_id)
- INDEX idx_template_type (template_type)
- INDEX idx_is_system (is_system)
- INDEX idx_status (status)

**外键**：
- FOREIGN KEY (tenant_id) REFERENCES tenants(id)

### 3.25 Saga日志表（saga_logs）

**说明**：用于记录Saga分布式事务的执行状态，支持事务追踪和故障恢复。

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 |
|-------|------|------|--------|--------|------|
| id | VARCHAR | 50 | NO | - | Saga事务ID（主键） |
| status | VARCHAR | 20 | NO | running | 状态（running/completed/failed） |
| steps_total | INT | - | NO | 0 | 总步骤数 |
| steps_completed | INT | - | NO | 0 | 已完成步骤数 |
| error | TEXT | - | YES | NULL | 错误信息 |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| completed_at | DATETIME | - | YES | NULL | 完成时间 |

**索引**：
- PRIMARY KEY (id)
- INDEX idx_status (status)
- INDEX idx_created_at (created_at)
- INDEX idx_completed_at (completed_at)

**使用场景**：
- 记录Saga事务的执行状态
- 支持事务追踪和故障诊断
- 支持超时事务的自动清理

---

## 4. 多数据源设计

### 4.1 数据源配置

```python
DATA_SOURCES = {
    "primary": {
        "type": "mysql",
        "host": "localhost",
        "port": 3306,
        "database": "mcp_platform",
        "username": "root",
        "password": "12345678",
        "is_primary": True
    },
    "oracle_db": {
        "type": "oracle",
        "host": "192.168.1.100",
        "port": 1521,
        "database": "ORCL",
        "username": "oracle_user",
        "password": "oracle_password"
    },
    "postgres_db": {
        "type": "postgresql",
        "host": "192.168.1.101",
        "port": 5432,
        "database": "mcp_platform",
        "username": "postgres_user",
        "password": "postgres_password"
    }
}
```

### 4.2 数据源路由

```python
TABLE_ROUTING = {
    # 主数据源表
    "users": "primary",
    "roles": "primary",
    "permissions": "primary",
    "tenants": "primary",
    "departments": "primary",
    "menus": "primary",
    "mcp_tools": "primary",
    
    # Oracle数据源表
    "legacy_orders": "oracle_db",
    "legacy_products": "oracle_db",
    
    # PostgreSQL数据源表
    "analytics_data": "postgres_db",
    "report_data": "postgres_db",
}
```

---

## 5. 索引优化策略

### 5.1 索引设计原则

#### 5.1.1 索引选择原则

**高选择性字段优先**：
- ✅ 选择性 > 10% 的字段适合创建索引
- ✅ 选择性 = 唯一值数量 / 总行数
- ✅ 高选择性字段（如用户名、邮箱）优先索引
- ❌ 低选择性字段（如性别、状态）不适合单独索引

**使用频率高的字段**：
- ✅ 频繁出现在WHERE条件中的字段
- ✅ 频繁出现在JOIN条件中的字段
- ✅ 频繁出现在ORDER BY中的字段
- ✅ 频繁出现在GROUP BY中的字段

**复合索引字段顺序**：
```sql
-- ✅ 正确：高选择性字段在前
CREATE INDEX idx_tenant_status ON users(tenant_id, status);

-- ❌ 错误：低选择性字段在前
CREATE INDEX idx_status_tenant ON users(status, tenant_id);
```

**避免过度索引**：
- ❌ 不要为每个字段都创建索引
- ❌ 不要创建重复的索引
- ❌ 不要创建很少使用的索引
- ✅ 定期清理无用索引

#### 5.1.2 索引类型选择

| 索引类型 | 适用场景 | 优点 | 缺点 |
|---------|---------|------|------|
| **B-Tree索引** | 等值查询、范围查询、排序 | 通用性强、支持范围查询 | 占用空间大 |
| **哈希索引** | 等值查询 | 查询速度快 | 不支持范围查询、不排序 |
| **全文索引** | 文本搜索 | 支持全文检索 | 占用空间大、维护成本高 |
| **空间索引** | 地理位置数据 | 支持空间查询 | 应用场景有限 |

**B-Tree索引（默认）**：
```sql
-- 单列索引
CREATE INDEX idx_username ON users(username);

-- 复合索引
CREATE INDEX idx_tenant_status ON users(tenant_id, status);

-- 唯一索引
CREATE UNIQUE INDEX idx_email ON users(email);
```

**哈希索引**：
```sql
-- 适用于等值查询
CREATE INDEX idx_hash_username ON users USING HASH(username);
```

**全文索引**：
```sql
-- 适用于文本搜索
CREATE FULLTEXT INDEX idx_content ON articles(content);

-- 使用全文索引
SELECT * FROM articles 
WHERE MATCH(content) AGAINST('关键词' IN NATURAL LANGUAGE MODE);
```

**空间索引**：
```sql
-- 适用于地理位置数据
CREATE SPATIAL INDEX idx_location ON locations(location);

-- 使用空间索引
SELECT * FROM locations 
WHERE ST_Distance_Sphere(location, POINT(116.404, 39.915)) < 1000;
```

### 5.2 索引优化建议

#### 5.2.1 核心表索引设计

**用户表（users）**：
```sql
-- 主键索引（自动创建）
PRIMARY KEY (id)

-- 唯一索引
CREATE UNIQUE INDEX idx_username ON users(username);
CREATE UNIQUE INDEX idx_email ON users(email);

-- 复合索引（租户隔离）
CREATE INDEX idx_tenant_id ON users(tenant_id);
CREATE INDEX idx_tenant_status ON users(tenant_id, status);
CREATE INDEX idx_tenant_dept ON users(tenant_id, dept_id);

-- 部门索引
CREATE INDEX idx_dept_id ON users(dept_id);

-- 状态索引
CREATE INDEX idx_status ON users(status);

-- 创建时间索引（用于排序）
CREATE INDEX idx_created_at ON users(created_at);
```

**角色表（roles）**：
```sql
-- 主键索引
PRIMARY KEY (id)

-- 唯一索引
CREATE UNIQUE INDEX idx_role_name ON roles(name, tenant_id);

-- 复合索引
CREATE INDEX idx_tenant_id ON roles(tenant_id);
CREATE INDEX idx_tenant_status ON roles(tenant_id, status);
```

**权限表（permissions）**：
```sql
-- 主键索引
PRIMARY KEY (id)

-- 唯一索引
CREATE UNIQUE INDEX idx_permission_code ON permissions(code, tenant_id);

-- 复合索引
CREATE INDEX idx_tenant_id ON permissions(tenant_id);
CREATE INDEX idx_tenant_type ON permissions(tenant_id, type);
```

**MCP工具表（mcp_tools）**：
```sql
-- 主键索引
PRIMARY KEY (id)

-- 唯一索引
CREATE UNIQUE INDEX idx_tool_name ON mcp_tools(name, tenant_id);

-- 复合索引
CREATE INDEX idx_tenant_id ON mcp_tools(tenant_id);
CREATE INDEX idx_tenant_status ON mcp_tools(tenant_id, status);
CREATE INDEX idx_tenant_type ON mcp_tools(tenant_id, type);

-- API端点索引
CREATE INDEX idx_api_endpoint ON mcp_tools(api_endpoint);
```

**工作流实例表（workflow_instances）**：
```sql
-- 主键索引
PRIMARY KEY (id)

-- 唯一索引
CREATE UNIQUE INDEX uk_instance_no ON workflow_instances(instance_no);

-- 复合索引
CREATE INDEX idx_tenant_id ON workflow_instances(tenant_id);
CREATE INDEX idx_tenant_definition ON workflow_instances(tenant_id, definition_id);
CREATE INDEX idx_tenant_status ON workflow_instances(tenant_id, status);
CREATE INDEX idx_tenant_created_by ON workflow_instances(tenant_id, created_by);

-- 状态索引
CREATE INDEX idx_status ON workflow_instances(status);

-- 开始时间索引（用于排序和查询）
CREATE INDEX idx_started_at ON workflow_instances(started_at);
```

**待办任务表（todo_tasks）**：
```sql
-- 主键索引
PRIMARY KEY (id)

-- 复合索引
CREATE INDEX idx_tenant_id ON todo_tasks(tenant_id);
CREATE INDEX idx_tenant_user ON todo_tasks(tenant_id, user_id);
CREATE INDEX idx_tenant_status ON todo_tasks(tenant_id, status);
CREATE INDEX idx_tenant_priority ON todo_tasks(tenant_id, priority);
CREATE INDEX idx_tenant_type ON todo_tasks(tenant_id, task_type);

-- 用户索引
CREATE INDEX idx_user_id ON todo_tasks(user_id);

-- 状态索引
CREATE INDEX idx_status ON todo_tasks(status);

-- 截止时间索引
CREATE INDEX idx_due_date ON todo_tasks(due_date);

-- 创建时间索引
CREATE INDEX idx_created_at ON todo_tasks(created_at);
```

#### 5.2.2 复合索引设计原则

**最左前缀原则**：
```sql
-- 创建复合索引
CREATE INDEX idx_tenant_status_created ON users(tenant_id, status, created_at);

-- ✅ 可以使用索引
SELECT * FROM users WHERE tenant_id = '1';
SELECT * FROM users WHERE tenant_id = '1' AND status = 'active';
SELECT * FROM users WHERE tenant_id = '1' AND status = 'active' AND created_at > '2024-01-01';

-- ❌ 不能使用索引（跳过了tenant_id）
SELECT * FROM users WHERE status = 'active';
SELECT * FROM users WHERE status = 'active' AND created_at > '2024-01-01';
```

**覆盖索引**：
```sql
-- 创建覆盖索引
CREATE INDEX idx_covering ON users(tenant_id, username, email);

-- ✅ 可以使用覆盖索引，不需要回表
SELECT username, email FROM users WHERE tenant_id = '1';

-- ❌ 需要回表查询
SELECT * FROM users WHERE tenant_id = '1';
```

**索引选择性**：
```sql
-- 查看索引选择性
SELECT 
    COUNT(DISTINCT tenant_id) / COUNT(*) AS tenant_selectivity,
    COUNT(DISTINCT status) / COUNT(*) AS status_selectivity,
    COUNT(DISTINCT dept_id) / COUNT(*) AS dept_selectivity
FROM users;

-- 结果示例：
-- tenant_selectivity: 0.1 (10%，选择性低)
-- status_selectivity: 0.01 (1%，选择性极低)
-- dept_selectivity: 0.5 (50%，选择性高)

-- 根据选择性设计复合索引
CREATE INDEX idx_dept_tenant ON users(dept_id, tenant_id);  -- 高选择性在前
```

#### 5.2.3 索引维护策略

**定期分析索引使用情况**：
```sql
-- 查看索引使用情况
SELECT 
    table_name,
    index_name,
    cardinality,
    index_type
FROM information_schema.statistics
WHERE table_schema = 'mcp_platform'
ORDER BY table_name, index_name;

-- 查看索引统计信息
SELECT 
    object_name AS table_name,
    index_name,
    rows_read,
    rows_indexed
FROM performance_schema.table_io_waits_summary_by_index_usage
WHERE object_schema = 'mcp_platform'
ORDER BY rows_indexed DESC;
```

**删除无用索引**：
```sql
-- 查找未使用的索引
SELECT 
    object_schema AS database_name,
    object_name AS table_name,
    index_name
FROM performance_schema.table_io_waits_summary_by_index_usage
WHERE index_name IS NOT NULL
    AND count_star = 0
    AND object_schema = 'mcp_platform'
ORDER BY object_schema, object_name;

-- 删除未使用的索引（谨慎操作）
DROP INDEX idx_unused_index ON users;
```

**重建索引**：
```sql
-- 重建索引（适用于索引碎片化严重的情况）
ALTER TABLE users ENGINE=InnoDB;

-- 或使用OPTIMIZE TABLE
OPTIMIZE TABLE users;

-- 重建单个索引
ALTER TABLE users DROP INDEX idx_username;
ALTER TABLE users ADD INDEX idx_username(username);
```

#### 5.2.4 索引监控和调优

**慢查询分析**：
```sql
-- 启用慢查询日志
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 1;
SET GLOBAL slow_query_log_file = '/var/log/mysql/slow-query.log';

-- 查看慢查询
SELECT * FROM mysql.slow_log 
ORDER BY query_time DESC 
LIMIT 10;

-- 分析慢查询
EXPLAIN SELECT * FROM users WHERE username = 'admin';
```

**EXPLAIN分析**：
```sql
-- 分析查询执行计划
EXPLAIN SELECT * FROM users WHERE tenant_id = '1' AND status = 'active';

-- 关键指标：
-- type: 访问类型（ALL=全表扫描，index=索引扫描，range=范围扫描，ref=索引查找，const=常量查找）
-- key: 实际使用的索引
-- rows: 预估扫描的行数
-- Extra: 额外信息（Using index=覆盖索引，Using filesort=文件排序，Using temporary=临时表）
```

**索引优化建议**：
```sql
-- 查看索引建议
SELECT * FROM sys.schema_redundant_indexes;

-- 查看未使用的索引
SELECT * FROM sys.schema_unused_indexes;

-- 查看重复的索引
SELECT * FROM sys.schema_redundant_indexes;
```

### 5.3 索引最佳实践

**创建索引的最佳实践**：
- ✅ 在开发阶段就设计好索引
- ✅ 为高频查询创建索引
- ✅ 为外键创建索引
- ✅ 为JOIN条件创建索引
- ✅ 为ORDER BY和GROUP BY创建索引
- ✅ 使用复合索引优化多条件查询
- ✅ 定期分析索引使用情况

**避免索引误区的最佳实践**：
- ❌ 不要为小表创建索引（<1000行）
- ❌ 不要为低选择性字段创建单独索引
- ❌ 不要创建过多的索引（影响写入性能）
- ❌ 不要在经常更新的字段上创建太多索引
- ❌ 不要忽略索引维护成本
- ❌ 不要盲目创建索引，要先分析查询模式

**索引维护的最佳实践**：
- ✅ 定期检查索引使用情况
- ✅ 定期删除无用索引
- ✅ 定期重建碎片化的索引
- ✅ 监控慢查询日志
- ✅ 使用EXPLAIN分析查询计划
- ✅ 定期进行索引优化

---

## 6. 数据库迁移策略

### 5.1 迁移工具

使用 **Alembic** 进行数据库版本管理和迁移。

### 5.2 迁移流程

```mermaid
graph LR
    A[开发人员] --> B[编写迁移脚本]
    B --> C[提交到Git]
    C --> D[CI/CD自动执行]
    D --> E[测试环境验证]
    E --> F[生产环境部署]
```

### 5.3 迁移命令

```bash
# 初始化Alembic
alembic init alembic

# 生成迁移脚本
alembic revision --autogenerate -m "描述"

# 执行迁移
alembic upgrade head

# 回滚迁移
alembic downgrade -1
```

---

## 7. 分库分表方案

### 7.1 分库分表概述

**适用场景**：
- 单表数据量超过1000万
- 单库数据量超过100GB
- 单库QPS超过5000
- 多租户场景，需要数据隔离

**分库分表优势**：
- ✅ 提高查询性能
- ✅ 提高并发能力
- ✅ 提高数据安全性
- ✅ 提高扩展性

**分库分表挑战**：
- ❌ 事务一致性
- ❌ 跨库JOIN
- ❌ 分页查询
- ❌ 数据迁移

### 7.2 分库策略

#### 7.2.1 按租户分库（推荐）

**适用场景**：多租户SaaS平台

**分库规则**：
```python
# 按租户ID分库
def get_database_by_tenant(tenant_id: str) -> str:
    """根据租户ID获取数据库"""
    # 计算分库索引
    db_index = hash(tenant_id) % 10  # 分成10个库
    
    # 返回数据库名
    return f"mcp_platform_{db_index}"

# 示例
# tenant_001 -> mcp_platform_1
# tenant_002 -> mcp_platform_2
# tenant_003 -> mcp_platform_3
```

**数据库配置**：
```python
DATABASE_CONFIG = {
    "mcp_platform_0": {
        "host": "db0.example.com",
        "port": 3306,
        "database": "mcp_platform_0",
        "user": "root",
        "password": "password"
    },
    "mcp_platform_1": {
        "host": "db1.example.com",
        "port": 3306,
        "database": "mcp_platform_1",
        "user": "root",
        "password": "password"
    },
    # ... 更多数据库配置
}
```

**路由实现**：
```python
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

class DatabaseRouter:
    """数据库路由器"""
    
    def __init__(self):
        self.engines = {}
        self.sessions = {}
        
        # 初始化所有数据库连接
        for db_name, config in DATABASE_CONFIG.items():
            engine = create_engine(
                f"mysql://{config['user']}:{config['password']}@{config['host']}:{config['port']}/{config['database']}",
                pool_size=10,
                max_overflow=20
            )
            self.engines[db_name] = engine
            self.sessions[db_name] = sessionmaker(bind=engine)
    
    def get_session(self, tenant_id: str):
        """根据租户ID获取数据库会话"""
        db_name = get_database_by_tenant(tenant_id)
        return self.sessions[db_name]()
    
    def get_engine(self, tenant_id: str):
        """根据租户ID获取数据库引擎"""
        db_name = get_database_by_tenant(tenant_id)
        return self.engines[db_name]

# 全局路由器
db_router = DatabaseRouter()
```

#### 7.2.2 按业务模块分库

**适用场景**：业务模块独立性强

**分库规则**：
```python
# 按业务模块分库
MODULE_DATABASES = {
    "user": "mcp_user",          # 用户域
    "permission": "mcp_permission",  # 权限域
    "system": "mcp_system",      # 系统域
    "support": "mcp_support",    # 支撑域
    "business": "mcp_business",  # 业务域
}

def get_database_by_module(module: str) -> str:
    """根据业务模块获取数据库"""
    return MODULE_DATABASES.get(module, "mcp_platform")

# 示例
# user -> mcp_user
# permission -> mcp_permission
```

**路由实现**：
```python
class ModuleDatabaseRouter:
    """模块路由器"""
    
    def get_session(self, module: str):
        """根据模块获取数据库会话"""
        db_name = get_database_by_module(module)
        return self.sessions[db_name]()
```

### 7.3 分表策略

#### 7.3.1 按时间分表（推荐）

**适用场景**：日志表、记录表等大表

**分表规则**：
```python
# 按月分表
def get_table_by_time(table_name: str, date: datetime) -> str:
    """根据时间获取表名"""
    return f"{table_name}_{date.strftime('%Y%m')}"

# 示例
# operation_logs + 2024-01-15 -> operation_logs_202401
# mcp_tool_call_logs + 2024-02-20 -> mcp_tool_call_logs_202402
```

**创建分表**：
```sql
-- 创建操作日志表（按月分表）
CREATE TABLE operation_logs_202401 (
    id VARCHAR(50) PRIMARY KEY,
    tenant_id VARCHAR(50) NOT NULL,
    user_id VARCHAR(50) NOT NULL,
    operation VARCHAR(100) NOT NULL,
    ip VARCHAR(50),
    user_agent TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_tenant_id (tenant_id),
    INDEX idx_user_id (user_id),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 创建2月份表
CREATE TABLE operation_logs_202402 LIKE operation_logs_202401;

-- 创建3月份表
CREATE TABLE operation_logs_202403 LIKE operation_logs_202401;
```

**自动创建分表**：
```python
import schedule
import time

def create_next_month_table():
    """创建下个月的分表"""
    from datetime import datetime, timedelta
    from app.utils.database import execute_sql
    
    next_month = datetime.now() + timedelta(days=32)
    next_month = next_month.replace(day=1)
    
    table_name = f"operation_logs_{next_month.strftime('%Y%m')}"
    create_sql = f"CREATE TABLE {table_name} LIKE operation_logs_202401"
    
    execute_sql(create_sql)
    print(f"创建表: {table_name}")

# 每月1号执行
schedule.every().month.do(create_next_month_table)

while True:
    schedule.run_pending()
    time.sleep(60)
```

#### 7.3.2 按租户分表

**适用场景**：单租户数据量大

**分表规则**：
```python
# 按租户ID分表
def get_table_by_tenant(table_name: str, tenant_id: str) -> str:
    """根据租户ID获取表名"""
    # 计算分表索引
    table_index = hash(tenant_id) % 10  # 分成10张表
    
    # 返回表名
    return f"{table_name}_{table_index}"

# 示例
# users + tenant_001 -> users_1
# users + tenant_002 -> users_2
```

**创建分表**：
```sql
-- 创建用户表（按租户分表）
CREATE TABLE users_0 (
    id VARCHAR(50) PRIMARY KEY,
    tenant_id VARCHAR(50) NOT NULL,
    username VARCHAR(50) NOT NULL,
    email VARCHAR(100) NOT NULL,
    UNIQUE KEY uk_username (username),
    UNIQUE KEY uk_email (email),
    INDEX idx_tenant_id (tenant_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 创建其他分表
CREATE TABLE users_1 LIKE users_0;
CREATE TABLE users_2 LIKE users_0;
-- ... 更多分表
```

#### 7.3.3 按数据量分表

**适用场景**：数据量持续增长

**分表规则**：
```python
# 按ID范围分表
def get_table_by_id(table_name: str, id: str) -> str:
    """根据ID获取表名"""
    # 计算分表索引
    id_int = int(id, 16)  # 假设ID是16进制
    table_index = id_int % 10  # 分成10张表
    
    # 返回表名
    return f"{table_name}_{table_index}"

# 示例
# operation_logs + 1a2b3c4d -> operation_logs_4
# operation_logs + 5e6f7a8b -> operation_logs_9
```

### 7.4 分库分表实现

#### 7.4.1 ShardingSphere配置

**配置文件（sharding.yml）**：
```yaml
dataSources:
  ds0:
    dataSourceClassName: com.zaxxer.hikari.HikariDataSource
    driverClassName: com.mysql.cj.jdbc.Driver
    jdbcUrl: jdbc:mysql://localhost:3306/mcp_platform_0
    username: root
    password: password
  
  ds1:
    dataSourceClassName: com.zaxxer.hikari.HikariDataSource
    driverClassName: com.mysql.cj.jdbc.Driver
    jdbcUrl: jdbc:mysql://localhost:3306/mcp_platform_1
    username: root
    password: password

rules:
  - !SHARDING
    tables:
      users:
        actualDataNodes: ds${0..1}.users_${0..9}
        tableStrategy:
          standard:
            shardingColumn: tenant_id
            shardingAlgorithmName: tenant_mod
        databaseStrategy:
          standard:
            shardingColumn: tenant_id
            shardingAlgorithmName: tenant_mod
    
    shardingAlgorithms:
      tenant_mod:
        type: MOD
        props:
          sharding-count: 10
```

**Python集成**：
```python
from shardingjdbc import ShardingSphereDataSource

# 创建ShardingSphere数据源
sharding_datasource = ShardingSphereDataSource(
    config_file="sharding.yml"
)

# 使用ShardingSphere数据源
engine = create_engine(
    "mysql+pymysql://",
    creator=lambda: sharding_datasource.getConnection()
)
```

#### 7.4.2 自定义路由实现

**路由器实现**：
```python
from typing import Dict, Any
from sqlalchemy.engine import Engine
from sqlalchemy.orm import Session

class ShardingRouter:
    """分库分表路由器"""
    
    def __init__(self):
        self.engines: Dict[str, Engine] = {}
        self.sessions: Dict[str, Session] = {}
        
        # 初始化数据库连接
        self._init_databases()
    
    def _init_databases(self):
        """初始化数据库连接"""
        for db_name, config in DATABASE_CONFIG.items():
            engine = create_engine(
                f"mysql://{config['user']}:{config['password']}@{config['host']}:{config['port']}/{config['database']}",
                pool_size=10,
                max_overflow=20
            )
            self.engines[db_name] = engine
            self.sessions[db_name] = sessionmaker(bind=engine)
    
    def route(self, table_name: str, **kwargs) -> tuple:
        """路由到具体的库和表"""
        # 获取租户ID
        tenant_id = kwargs.get('tenant_id')
        
        # 计算分库和分表
        db_name = get_database_by_tenant(tenant_id)
        table_name = get_table_by_tenant(table_name, tenant_id)
        
        return db_name, table_name
    
    def get_session(self, table_name: str, **kwargs) -> Session:
        """获取数据库会话"""
        db_name, _ = self.route(table_name, **kwargs)
        return self.sessions[db_name]()
    
    def execute(self, sql: str, table_name: str, **kwargs):
        """执行SQL"""
        db_name, actual_table = self.route(table_name, **kwargs)
        
        # 替换表名
        actual_sql = sql.replace(table_name, actual_table)
        
        # 执行SQL
        session = self.sessions[db_name]()
        session.execute(actual_sql)
        session.commit()
        session.close()

# 全局路由器
sharding_router = ShardingRouter()
```

**使用示例**：
```python
# 查询用户
def get_user(tenant_id: str, user_id: str):
    session = sharding_router.get_session("users", tenant_id=tenant_id)
    
    # 自动路由到正确的库和表
    user = session.query(User).filter(
        User.tenant_id == tenant_id,
        User.id == user_id
    ).first()
    
    session.close()
    return user

# 创建用户
def create_user(user_data: dict):
    session = sharding_router.get_session("users", tenant_id=user_data['tenant_id'])
    
    user = User(**user_data)
    session.add(user)
    session.commit()
    session.close()
    
    return user
```

### 7.5 数据迁移

#### 7.5.1 历史数据迁移

**迁移脚本**：
```python
from datetime import datetime

def migrate_historical_data():
    """迁移历史数据"""
    from app.utils.database import execute_sql
    
    # 查询所有租户
    tenants = execute_sql("SELECT id FROM tenants")
    
    for tenant in tenants:
        tenant_id = tenant['id']
        
        # 查询该租户的所有用户
        users = execute_sql(
            f"SELECT * FROM users WHERE tenant_id = '{tenant_id}'"
        )
        
        # 获取目标表
        target_table = get_table_by_tenant("users", tenant_id)
        
        # 插入数据
        for user in users:
            insert_sql = f"""
                INSERT INTO {target_table} 
                (id, tenant_id, username, email, created_at)
                VALUES ('{user['id']}', '{user['tenant_id']}', 
                        '{user['username']}', '{user['email']}', 
                        '{user['created_at']}')
            """
            execute_sql(insert_sql)
        
        print(f"迁移租户 {tenant_id} 的用户数据完成")

if __name__ == "__main__":
    migrate_historical_data()
```

#### 7.5.2 数据同步

**双写方案**：
```python
def create_user_with_sync(user_data: dict):
    """创建用户（双写）"""
    # 写入旧表
    session_old = get_old_session()
    user_old = User(**user_data)
    session_old.add(user_old)
    session_old.commit()
    session_old.close()
    
    # 写入新表（分库分表）
    session_new = sharding_router.get_session("users", tenant_id=user_data['tenant_id'])
    user_new = User(**user_data)
    session_new.add(user_new)
    session_new.commit()
    session_new.close()
    
    return user_new
```

**数据校验**：
```python
def validate_data_migration():
    """验证数据迁移"""
    # 查询旧表数据量
    old_count = execute_sql("SELECT COUNT(*) as count FROM users")
    
    # 查询新表数据量
    new_count = 0
    for i in range(10):
        table_name = f"users_{i}"
        count = execute_sql(f"SELECT COUNT(*) as count FROM {table_name}")
        new_count += count[0]['count']
    
    # 对比数据量
    if old_count[0]['count'] == new_count:
        print("数据迁移验证通过")
    else:
        print(f"数据迁移验证失败：旧表{old_count[0]['count']}条，新表{new_count}条")

if __name__ == "__main__":
    validate_data_migration()
```

### 7.6 分库分表最佳实践

**分库分表设计原则**：
- ✅ 根据业务场景选择合适的分库分表策略
- ✅ 分库分表键要选择高选择性字段
- ✅ 预留足够的分库分表数量
- ✅ 考虑数据迁移和扩容方案

**分库分表注意事项**：
- ❌ 避免跨库事务（使用分布式事务）
- ❌ 避免跨库JOIN（在应用层处理）
- ❌ 避免全局唯一ID（使用分布式ID生成器）
- ❌ 避免复杂的分页查询（使用游标分页）

**分库分表监控**：
- ✅ 监控各库各表的数据量
- ✅ 监控各库各表的QPS
- ✅ 监控数据迁移进度
- ✅ 监控数据一致性

---

## 8. 性能优化建议

### 8.1 查询优化

- ✅ 使用EXPLAIN分析查询计划
- ✅ 避免SELECT *，只查询需要的字段
- ✅ 使用JOIN代替子查询
- ✅ 使用LIMIT限制返回结果数量
- ✅ 详见第5章索引优化策略

### 8.2 连接池优化

### 8.3 分区策略

```python
# 连接池配置
pool_size = 10          # 连接池大小
max_overflow = 20       # 最大溢出连接数
pool_timeout = 30       # 连接超时时间（秒）
pool_recycle = 3600     # 连接回收时间（秒）
```

### 8.4 读写分离

对于大表（如mcp_tool_call_logs、operation_logs），建议按时间分区：

```sql
-- 按月分区
CREATE TABLE mcp_tool_call_logs (
    id BIGINT,
    created_at DATETIME,
    ...
) PARTITION BY RANGE (YEAR(created_at) * 100 + MONTH(created_at)) (
    PARTITION p202401 VALUES LESS THAN (202402),
    PARTITION p202402 VALUES LESS THAN (202403),
    ...
);
```

对于读多写少的场景，建议使用读写分离：

```python
# 读写分离配置
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

# 主库（写）
master_engine = create_engine('mysql://user:pass@master:3306/db')

# 从库（读）
slave_engine = create_engine('mysql://user:pass@slave1:3306/db')

# 路由器
class MasterSlaveRouter:
    def routing_session(self, session):
        if session.is_modified:
            return master_engine
        else:
            return slave_engine
```

---

## 🔗 相关文档

- [技术架构设计文档](./2-技术架构设计文档.md)
- [API接口设计文档](./4-API接口设计文档.md)
- [环境配置文档](./7-环境配置文档.md)

---

## 💡 注意事项

1. **索引策略**：合理创建索引，避免过多索引影响性能
2. **数据类型**：选择合适的数据类型，避免浪费空间
3. **外键约束**：合理使用外键，保证数据完整性
4. **字符集**：统一使用utf8mb4字符集，支持emoji
5. **时区**：统一使用UTC时区，避免时区问题

---

**文档版本历史**：

| 版本 | 日期 | 作者 | 变更说明 |
|-----|------|------|---------|
| v1.0 | 2026-01-13 | AI助手 | 初始版本 |

---