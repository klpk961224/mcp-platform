# æŠ€æœ¯æ¶æ„è®¾è®¡æ–‡æ¡£

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

- **é¡¹ç›®åç§°**ï¼šä¼ä¸šçº§AIç»¼åˆç®¡ç†å¹³å°
- **æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
- **åˆ›å»ºæ—¥æœŸ**ï¼š2026-01-13
- **æ–‡æ¡£ç±»å‹**ï¼šæŠ€æœ¯æ¶æ„è®¾è®¡æ–‡æ¡£

---

## 1. ç³»ç»Ÿæ¶æ„è®¾è®¡

### 1.1 æ•´ä½“æ¶æ„

æœ¬ç³»ç»Ÿé‡‡ç”¨**å¾®æœåŠ¡æ¶æ„**ï¼Œå°†ç³»ç»Ÿæ‹†åˆ†ä¸ºå¤šä¸ªç‹¬ç«‹çš„æœåŠ¡ï¼Œæ¯ä¸ªæœåŠ¡è´Ÿè´£ç‰¹å®šçš„ä¸šåŠ¡åŠŸèƒ½ã€‚æœåŠ¡ä¹‹é—´é€šè¿‡APIè¿›è¡Œé€šä¿¡ï¼Œæ”¯æŒç‹¬ç«‹éƒ¨ç½²ã€ç‹¬ç«‹æ‰©å±•ã€‚

### 1.2 ç³»ç»Ÿæ¶æ„å›¾

```mermaid
graph TB
    subgraph "å®¢æˆ·ç«¯å±‚"
        Browser[Webæµè§ˆå™¨<br/>http://localhost:3000]
    end
    
    subgraph "å‰ç«¯å±‚"
        VueApp[Vue 3 å‰ç«¯åº”ç”¨<br/>:3000]
    end
    
    subgraph "APIç½‘å…³å±‚"
        APISIX[APISIX APIç½‘å…³<br/>:9080]
    end
    
    subgraph "åç«¯æœåŠ¡å±‚"
        subgraph "è®¤è¯åŸŸ"
            Auth[è®¤è¯åŸŸæœåŠ¡<br/>:8001]
        end
        
        subgraph "ç”¨æˆ·åŸŸ"
            User[ç”¨æˆ·åŸŸæœåŠ¡<br/>:8002]
        end
        
        subgraph "æƒé™åŸŸ"
            Permission[æƒé™åŸŸæœåŠ¡<br/>:8003]
        end
        
        subgraph "ç³»ç»ŸåŸŸ"
            System[ç³»ç»ŸåŸŸæœåŠ¡<br/>:8004]
        end
        
        subgraph "æ”¯æ’‘åŸŸ"
            Support[æ”¯æ’‘åŸŸæœåŠ¡<br/>:8005]
        end
        
        subgraph "ä¸šåŠ¡åŸŸ"
            Business[ä¸šåŠ¡åŸŸæœåŠ¡<br/>:8006<br/>ï¼ˆå·¥ä½œæµç®¡ç†ï¼‰]
        end
    end
    
    subgraph "æ•°æ®å±‚"
        MySQL[(MySQLä¸»æ•°æ®åº“<br/>:3306)]
        PostgreSQL[(PostgreSQL<br/>:5432)]
        Oracle[(Oracle<br/>:1521)]
        Redis[(Redisç¼“å­˜<br/>:6379)]
        RabbitMQ[RabbitMQæ¶ˆæ¯é˜Ÿåˆ—<br/>:5672]
    end
    
    subgraph "åŸºç¡€è®¾æ–½å±‚"
        Nacos[Nacosé…ç½®ä¸­å¿ƒ<br/>:8848]
        Jaeger[Jaegeråˆ†å¸ƒå¼è¿½è¸ª<br/>:6831]
        Prometheus[Prometheusç›‘æ§<br/>:9090]
        Grafana[Grafanaå¯è§†åŒ–<br/>:3001]
    end
    
    Browser --> VueApp
    VueApp --> APISIX
    
    APISIX --> Auth
    APISIX --> User
    APISIX --> Permission
    APISIX --> System
    APISIX --> Support
    APISIX --> Business
    
    Auth --> MySQL
    User --> MySQL
    Permission --> MySQL
    System --> MySQL
    Support --> MySQL
    Business --> MySQL
    
    System --> PostgreSQL
    System --> Oracle
    
    Auth --> Redis
    User --> Redis
    Permission --> Redis
    System --> Redis
    Support --> Redis
    Business --> Redis
    
    Auth --> RabbitMQ
    System --> RabbitMQ
    Support --> RabbitMQ
    
    Auth --> Nacos
    User --> Nacos
    Permission --> Nacos
    System --> Nacos
    Support --> Nacos
    Business --> Nacos
    
    Auth --> Jaeger
    User --> Jaeger
    System --> Jaeger
    
    Auth --> Prometheus
    User --> Prometheus
    System --> Prometheus
    
    Prometheus --> Grafana
```

### 1.3 æ¶æ„åˆ†å±‚

| å±‚çº§ | èŒè´£ | æŠ€æœ¯é€‰å‹ |
|-----|------|---------|
| **å®¢æˆ·ç«¯å±‚** | ç”¨æˆ·äº¤äº’ç•Œé¢ | Vue 3 + TypeScript + Element Plus |
| **ç½‘å…³å±‚** | ç»Ÿä¸€å…¥å£ã€é™æµã€è·¯ç”± | APISIX + Sentinel |
| **åº”ç”¨å±‚** | ä¸šåŠ¡é€»è¾‘å¤„ç† | FastAPI + Python 3.13 |
| **æ•°æ®å±‚** | æ•°æ®å­˜å‚¨ã€ç¼“å­˜ | MySQL + PostgreSQL + Oracle + Redis |
| **åŸºç¡€è®¾æ–½å±‚** | é…ç½®ã€ç›‘æ§ã€è¿½è¸ª | Nacos + Prometheus + Jaeger |

---

## 2. å¾®æœåŠ¡æ¶æ„åˆ’åˆ†

### 2.1 å¾®æœåŠ¡åˆ’åˆ†

æœ¬ç³»ç»Ÿé‡‡ç”¨**å‰åç«¯åˆ†ç¦»æ¶æ„**ï¼Œå°†ç³»ç»Ÿæ‹†åˆ†ä¸ºä»¥ä¸‹æœåŠ¡ï¼š

| ç±»å‹ | æœåŠ¡åç§° | èŒè´£ | ç«¯å£ | æ•°æ®åº“ |
|-----|---------|------|------|--------|
| **å‰ç«¯** | Vue 3å‰ç«¯åº”ç”¨ | ç”¨æˆ·ç•Œé¢ã€äº¤äº’é€»è¾‘ | 3000 | - |
| **åç«¯** | è®¤è¯åŸŸæœåŠ¡ | JWTè®¤è¯ã€API Keyè®¤è¯ã€æƒé™æ ¡éªŒã€Tokenç®¡ç† | 8001 | MySQL |
| **åç«¯** | ç”¨æˆ·åŸŸæœåŠ¡ | ç”¨æˆ·CRUDã€éƒ¨é—¨ç®¡ç†ã€ç§Ÿæˆ·ç®¡ç†ã€ç”¨æˆ·ä¸éƒ¨é—¨/è§’è‰²å…³è” | 8002 | MySQL |
| **åç«¯** | æƒé™åŸŸæœåŠ¡ | è§’è‰²ç®¡ç†ã€æƒé™åˆ†é…ã€èœå•ç®¡ç†ã€åŠ¨æ€èœå•åŠ è½½ | 8003 | MySQL |
| **åç«¯** | ç³»ç»ŸåŸŸæœåŠ¡ | MCPå·¥å…·æ³¨å†Œ/è°ƒç”¨ã€å¤šæ•°æ®æºç®¡ç†ã€å­—å…¸ç®¡ç†ã€ç³»ç»Ÿé…ç½® | 8004 | MySQL + PostgreSQL + Oracle |
| **åç«¯** | æ”¯æ’‘åŸŸæœåŠ¡ | ç™»å½•æ—¥å¿—ã€æ“ä½œæ—¥å¿—ã€ç«™å†…ä¿¡ã€é€šçŸ¥å…¬å‘Š | 8005 | MySQL |
| **åç«¯** | ä¸šåŠ¡åŸŸæœåŠ¡ | å·¥ä½œæµç®¡ç†ï¼ˆé¢„ç½®å®¡æ‰¹æ¨¡æ¿ã€å¯è§†åŒ–è®¾è®¡å™¨ã€å®¡æ‰¹æµç¨‹é…ç½®ã€æµç¨‹ç›‘æ§ï¼‰ | 8006 | MySQL |

### 2.2 åˆå¹¶è¯´æ˜

**åŸå§‹è®¾è®¡**ï¼š11ä¸ªå¾®æœåŠ¡
**ä¼˜åŒ–å**ï¼š6ä¸ªåç«¯æœåŠ¡ + 1ä¸ªå‰ç«¯åº”ç”¨

**åˆå¹¶ç­–ç•¥**ï¼š
- è®¤è¯æˆæƒæœåŠ¡ â†’ è®¤è¯åŸŸæœåŠ¡
- ç”¨æˆ·ç®¡ç† + éƒ¨é—¨ç®¡ç† + å¤šç§Ÿæˆ·æœåŠ¡ â†’ ç”¨æˆ·åŸŸæœåŠ¡
- è§’è‰²æƒé™ + èœå•ç®¡ç†æœåŠ¡ â†’ æƒé™åŸŸæœåŠ¡
- MCPå·¥å…· + å¤šæ•°æ®æº + å­—å…¸ç®¡ç†æœåŠ¡ â†’ ç³»ç»ŸåŸŸæœåŠ¡
- æ—¥å¿—å®¡è®¡ + é€šçŸ¥æœåŠ¡ â†’ æ”¯æ’‘åŸŸæœåŠ¡
- æ–°å¢ï¼šä¸šåŠ¡åŸŸæœåŠ¡ï¼ˆå·¥ä½œæµç®¡ç†ï¼‰

### 2.3 å¾®æœåŠ¡æ¶æ„å›¾

```mermaid
graph TB
    subgraph "å‰ç«¯å±‚"
        VueApp[Vue 3 å‰ç«¯åº”ç”¨<br/>:3000]
    end
    
    subgraph "APIç½‘å…³å±‚"
        APISIX[APISIXç½‘å…³<br/>:9080]
    end
    
    subgraph "è®¤è¯åŸŸ"
        Auth[è®¤è¯åŸŸæœåŠ¡<br/>:8001]
    end
    
    subgraph "ç”¨æˆ·åŸŸ"
        User[ç”¨æˆ·åŸŸæœåŠ¡<br/>:8002]
    end
    
    subgraph "æƒé™åŸŸ"
        Permission[æƒé™åŸŸæœåŠ¡<br/>:8003]
    end
    
    subgraph "ç³»ç»ŸåŸŸ"
        System[ç³»ç»ŸåŸŸæœåŠ¡<br/>:8004]
    end
    
    subgraph "æ”¯æ’‘åŸŸ"
        Support[æ”¯æ’‘åŸŸæœåŠ¡<br/>:8005]
    end
    
    subgraph "ä¸šåŠ¡åŸŸ"
        Business[ä¸šåŠ¡åŸŸæœåŠ¡<br/>:8006<br/>ï¼ˆå·¥ä½œæµç®¡ç†ï¼‰]
    end
    
    VueApp --> APISIX
    
    APISIX --> Auth
    APISIX --> User
    APISIX --> Permission
    APISIX --> System
    APISIX --> Support
    APISIX --> Business
    
    Auth -.ä¾èµ–.-> Permission
    User -.ä¾èµ–.-> Auth
    User -.ä¾èµ–.-> Permission
    Permission -.ä¾èµ–.-> User
    System -.ä¾èµ–.-> Auth
    System -.ä¾èµ–.-> Permission
    Support -.ä¾èµ–.-> Auth
    Business -.ä¾èµ–.-> Auth
    Business -.ä¾èµ–.-> Permission
    Business -.ä¾èµ–.-> User
```
    APISIX --> Tenant
    APISIX --> Dept
    APISIX --> Role
    APISIX --> Menu
    APISIX --> MCP
    APISIX --> MultiDB
    APISIX --> Dict
    APISIX --> Log
    APISIX --> Notify
    
    Auth -.ä¾èµ–.-> Role
    User -.ä¾èµ–.-> Auth
    User -.ä¾èµ–.-> Tenant
    User -.ä¾èµ–.-> Dept
    User -.ä¾èµ–.-> Role
    Tenant -.ä¾èµ–.-> Auth
    Dept -.ä¾èµ–.-> Tenant
    Role -.ä¾èµ–.-> Menu
    Menu -.ä¾èµ–.-> Role
    MCP -.ä¾èµ–.-> Auth
    MCP -.ä¾èµ–.-> Role
    MCP -.ä¾èµ–.-> MultiDB
    MultiDB -.ä¾èµ–.-> Auth
    Log -.ä¾èµ–.-> Auth
    Notify -.ä¾èµ–.-> Auth
```

### 2.3 æœåŠ¡é—´é€šä¿¡

#### 2.3.1 é€šä¿¡æ–¹å¼æ¦‚è¿°

| é€šä¿¡æ–¹å¼ | é€‚ç”¨åœºæ™¯ | æŠ€æœ¯é€‰å‹ | ç‰¹ç‚¹ |
|---------|---------|---------|------|
| **åŒæ­¥è°ƒç”¨** | å®æ—¶æŸ¥è¯¢ã€äº‹åŠ¡æ“ä½œ | HTTP/REST + FastAPI | å®æ—¶æ€§å¼ºã€ç®€å•ç›´æ¥ |
| **å¼‚æ­¥è°ƒç”¨** | å¼‚æ­¥ä»»åŠ¡ã€æ¶ˆæ¯é€šçŸ¥ | RabbitMQ | è§£è€¦ã€å¼‚æ­¥å¤„ç† |
| **äº‹ä»¶é©±åŠ¨** | äº‹ä»¶å‘å¸ƒè®¢é˜… | RabbitMQ | æ¾è€¦åˆã€å¯æ‰©å±• |

#### 2.3.2 åŒæ­¥é€šä¿¡ï¼ˆHTTP/RESTï¼‰

**é€šä¿¡æµç¨‹**ï¼š
```mermaid
sequenceDiagram
    participant ServiceA as æœåŠ¡A
    participant APISIX as APISIXç½‘å…³
    participant ServiceB as æœåŠ¡B
    
    ServiceA->>APISIX: HTTPè¯·æ±‚ï¼ˆå¸¦JWT Tokenï¼‰
    APISIX->>APISIX: éªŒè¯Token
    APISIX->>APISIX: è·¯ç”±è½¬å‘
    APISIX->>ServiceB: è½¬å‘è¯·æ±‚
    ServiceB->>ServiceB: å¤„ç†ä¸šåŠ¡é€»è¾‘
    ServiceB-->>APISIX: è¿”å›å“åº”
    APISIX-->>ServiceA: è¿”å›å“åº”
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- æœåŠ¡Aéœ€è¦å®æ—¶æŸ¥è¯¢æœåŠ¡Bçš„æ•°æ®
- è·¨æœåŠ¡çš„äº‹åŠ¡æ“ä½œ
- éœ€è¦ç«‹å³è¿”å›ç»“æœçš„åœºæ™¯

**å®ç°æ–¹å¼**ï¼š
```python
# æœåŠ¡Aè°ƒç”¨æœåŠ¡Bçš„ç¤ºä¾‹
import httpx

async def call_service_b(user_id: str):
    """è°ƒç”¨æœåŠ¡Bè·å–ç”¨æˆ·ä¿¡æ¯"""
    async with httpx.AsyncClient() as client:
        response = await client.get(
            f"http://apisix:9080/api/v1/users/{user_id}",
            headers={"Authorization": f"Bearer {token}"}
        )
        return response.json()
```

#### 2.3.3 å¼‚æ­¥é€šä¿¡ï¼ˆRabbitMQï¼‰

**é€šä¿¡æµç¨‹**ï¼š
```mermaid
sequenceDiagram
    participant ServiceA as æœåŠ¡A
    participant RabbitMQ as RabbitMQ
    participant ServiceB as æœåŠ¡B
    
    ServiceA->>RabbitMQ: å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—
    RabbitMQ->>RabbitMQ: æ¶ˆæ¯æŒä¹…åŒ–
    ServiceB->>RabbitMQ: æ¶ˆè´¹æ¶ˆæ¯
    RabbitMQ-->>ServiceB: æ¨é€æ¶ˆæ¯
    ServiceB->>ServiceB: å¤„ç†ä¸šåŠ¡é€»è¾‘
    ServiceB->>RabbitMQ: ç¡®è®¤æ¶ˆæ¯
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- å¼‚æ­¥ä»»åŠ¡å¤„ç†ï¼ˆå¦‚å‘é€é‚®ä»¶ã€ç”ŸæˆæŠ¥è¡¨ï¼‰
- æ¶ˆæ¯é€šçŸ¥ï¼ˆå¦‚ç«™å†…ä¿¡ã€çŸ­ä¿¡é€šçŸ¥ï¼‰
- äº‹ä»¶å‘å¸ƒè®¢é˜…ï¼ˆå¦‚ç”¨æˆ·æ³¨å†Œåå‘é€æ¬¢è¿é‚®ä»¶ï¼‰

**å®ç°æ–¹å¼**ï¼š
```python
# æœåŠ¡Aå‘é€æ¶ˆæ¯
import pika

def send_notification_message(user_id: str, message: str):
    """å‘é€é€šçŸ¥æ¶ˆæ¯"""
    connection = pika.BlockingConnection(pika.ConnectionParameters('rabbitmq'))
    channel = connection.channel()
    
    channel.queue_declare(queue='notifications', durable=True)
    
    channel.basic_publish(
        exchange='',
        routing_key='notifications',
        body=json.dumps({'user_id': user_id, 'message': message}),
        properties=pika.BasicProperties(delivery_mode=2)
    )
    
    connection.close()

# æœåŠ¡Bæ¶ˆè´¹æ¶ˆæ¯
def consume_notification_messages():
    """æ¶ˆè´¹é€šçŸ¥æ¶ˆæ¯"""
    connection = pika.BlockingConnection(pika.ConnectionParameters('rabbitmq'))
    channel = connection.channel()
    
    channel.queue_declare(queue='notifications', durable=True)
    
    def callback(ch, method, properties, body):
        message = json.loads(body)
        # å¤„ç†æ¶ˆæ¯
        send_notification(message['user_id'], message['message'])
        ch.basic_ack(delivery_tag=method.delivery_tag)
    
    channel.basic_consume(queue='notifications', on_message_callback=callback)
    channel.start_consuming()
```

#### 2.3.4 æœåŠ¡å‘ç°ï¼ˆNacosï¼‰

**æœåŠ¡æ³¨å†Œæµç¨‹**ï¼š
```mermaid
sequenceDiagram
    participant Service as å¾®æœåŠ¡
    participant Nacos as NacosæœåŠ¡ç«¯
    participant Client as æœåŠ¡æ¶ˆè´¹è€…
    
    Service->>Nacos: æœåŠ¡å¯åŠ¨ï¼Œæ³¨å†ŒæœåŠ¡
    Nacos-->>Service: æ³¨å†ŒæˆåŠŸ
    Client->>Nacos: è®¢é˜…æœåŠ¡åˆ—è¡¨
    Nacos-->>Client: è¿”å›æœåŠ¡å®ä¾‹åˆ—è¡¨
    Client->>Service: è°ƒç”¨æœåŠ¡
    Service->>Nacos: å¿ƒè·³æ£€æµ‹
    Nacos-->>Service: å¿ƒè·³ç¡®è®¤
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- æœåŠ¡å¯åŠ¨æ—¶è‡ªåŠ¨æ³¨å†Œåˆ°Nacos
- æœåŠ¡æ¶ˆè´¹è€…ä»Nacosè·å–æœåŠ¡å®ä¾‹åˆ—è¡¨
- æœåŠ¡å¥åº·æ£€æŸ¥å’Œæ•…éšœè½¬ç§»

**å®ç°æ–¹å¼**ï¼š
```python
# æœåŠ¡æ³¨å†Œ
from nacos import NacosClient

nacos_client = NacosClient('nacos-server:8848')

def register_service(service_name: str, ip: str, port: int):
    """æ³¨å†ŒæœåŠ¡åˆ°Nacos"""
    nacos_client.add_naming_instance(
        service_name=service_name,
        ip=ip,
        port=port,
        cluster_name='DEFAULT',
        weight=1.0,
        ephemeral=True
    )

# æœåŠ¡å‘ç°
def discover_service(service_name: str):
    """ä»Nacosè·å–æœåŠ¡å®ä¾‹"""
    instances = nacos_client.list_naming_instance(service_name)
    if instances['hosts']:
        # è´Ÿè½½å‡è¡¡é€‰æ‹©ä¸€ä¸ªå®ä¾‹
        instance = random.choice(instances['hosts'])
        return f"http://{instance['ip']}:{instance['port']}"
    return None
```

#### 2.3.5 é€šä¿¡æœ€ä½³å®è·µ

**åŒæ­¥é€šä¿¡æœ€ä½³å®è·µ**ï¼š
- âœ… ä½¿ç”¨HTTP/RESTåè®®ï¼Œé€šè¿‡APISIXç½‘å…³è·¯ç”±
- âœ… æ·»åŠ JWT Tokenè¿›è¡Œè®¤è¯
- âœ… è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤30ç§’ï¼‰
- âœ… å®ç°é‡è¯•æœºåˆ¶ï¼ˆæœ€å¤š3æ¬¡ï¼‰
- âœ… æ·»åŠ ç†”æ–­é™çº§ç­–ç•¥

**å¼‚æ­¥é€šä¿¡æœ€ä½³å®è·µ**ï¼š
- âœ… ä½¿ç”¨RabbitMQæ¶ˆæ¯é˜Ÿåˆ—
- âœ… æ¶ˆæ¯æŒä¹…åŒ–ï¼Œé˜²æ­¢ä¸¢å¤±
- âœ… æ‰‹åŠ¨ç¡®è®¤æ¶ˆæ¯ï¼Œç¡®ä¿å¤„ç†æˆåŠŸ
- âœ… å®ç°æ­»ä¿¡é˜Ÿåˆ—ï¼Œå¤„ç†å¤±è´¥æ¶ˆæ¯
- âœ… ç›‘æ§é˜Ÿåˆ—ç§¯å‹æƒ…å†µ

**æœåŠ¡å‘ç°æœ€ä½³å®è·µ**ï¼š
- âœ… æœåŠ¡å¯åŠ¨æ—¶è‡ªåŠ¨æ³¨å†Œåˆ°Nacos
- âœ… å®šæœŸå‘é€å¿ƒè·³ï¼ˆé»˜è®¤5ç§’ï¼‰
- âœ… å®ç°å¥åº·æ£€æŸ¥
- âœ… å®ç°è´Ÿè½½å‡è¡¡ç­–ç•¥
- âœ… å®ç°æ•…éšœè‡ªåŠ¨è½¬ç§»

### 2.4 åˆ†å¸ƒå¼äº‹åŠ¡

#### 2.4.1 åˆ†å¸ƒå¼äº‹åŠ¡æ¦‚è¿°

å¾®æœåŠ¡æ¶æ„ä¸‹ï¼Œè·¨æœåŠ¡çš„äº‹åŠ¡å¤„ç†æ˜¯ä¸€ä¸ªé‡è¦æŒ‘æˆ˜ã€‚æœ¬ç³»ç»Ÿé‡‡ç”¨**Sagaæ¨¡å¼**ä½œä¸ºåˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆã€‚

**ä¸ºä»€ä¹ˆé€‰æ‹©Sagaï¼Ÿ**
- âœ… ä¸éœ€è¦é¢å¤–éƒ¨ç½²ä¸“é—¨çš„SagaæœåŠ¡å™¨
- âœ… åªéœ€è¦Pythonä»£ç å®ç°ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤
- âœ… é¡¹ç›®å·²æœ‰RabbitMQå’ŒMySQLï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨
- âœ… æ”¯æŒé•¿äº‹åŠ¡ï¼Œé€‚åˆå¤æ‚çš„ä¸šåŠ¡æµç¨‹
- âœ… å®ç°çµæ´»ï¼Œå¯ä»¥å®Œå…¨æ§åˆ¶ä¸šåŠ¡é€»è¾‘

#### 2.4.2 Sagaæ¨¡å¼ï¼ˆç¼–æ’å¼ï¼‰

**æ¶æ„å›¾**ï¼š
```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant Saga as Sagaåè°ƒå™¨<br/>(Pythonä»£ç )
    participant ServiceA as æœåŠ¡A
    participant ServiceB as æœåŠ¡B
    participant ServiceC as æœåŠ¡C
    participant DB as MySQLæ•°æ®åº“
    
    Client->>Saga: å‘èµ·äº‹åŠ¡è¯·æ±‚
    Saga->>DB: è®°å½•Sagaå¼€å§‹
    Saga->>ServiceA: æ‰§è¡Œæ­¥éª¤1
    ServiceA->>DB: ä¸šåŠ¡æ“ä½œ
    ServiceA-->>Saga: æˆåŠŸ
    Saga->>DB: æ›´æ–°è¿›åº¦
    Saga->>ServiceB: æ‰§è¡Œæ­¥éª¤2
    ServiceB->>DB: ä¸šåŠ¡æ“ä½œ
    ServiceB-->>Saga: æˆåŠŸ
    Saga->>DB: æ›´æ–°è¿›åº¦
    Saga->>ServiceC: æ‰§è¡Œæ­¥éª¤3
    ServiceC->>DB: ä¸šåŠ¡æ“ä½œ
    ServiceC-->>Saga: å¤±è´¥
    Saga->>ServiceB: è¡¥å¿æ­¥éª¤2
    ServiceB->>DB: è¡¥å¿æ“ä½œ
    ServiceB-->>Saga: è¡¥å¿æˆåŠŸ
    Saga->>ServiceA: è¡¥å¿æ­¥éª¤1
    ServiceA->>DB: è¡¥å¿æ“ä½œ
    ServiceA-->>Saga: è¡¥å¿æˆåŠŸ
    Saga->>DB: è®°å½•å¤±è´¥
    Saga-->>Client: äº‹åŠ¡å¤±è´¥ï¼Œå·²å›æ»š
```

**å®ç°æ–¹å¼**ï¼š

**1. Sagaåè°ƒå™¨ç±»**ï¼š
```python
# app/services/saga.py
from typing import List, Callable, Any
from loguru import logger

class SagaOrchestrator:
    """Sagaåè°ƒå™¨ - ç¼–æ’å¼å®ç°"""
    
    def __init__(self, db_session):
        self.db = db_session
        self.steps: List[Callable] = []
        self.compensations: List[Callable] = []
    
    def add_step(self, action: Callable, compensation: Callable):
        """æ·»åŠ ä¸šåŠ¡æ­¥éª¤å’Œè¡¥å¿æ“ä½œ
        
        Args:
            action: ä¸šåŠ¡æ“ä½œå‡½æ•°
            compensation: è¡¥å¿æ“ä½œå‡½æ•°
        """
        self.steps.append(action)
        self.compensations.append(compensation)
    
    async def execute(self, saga_id: str):
        """æ‰§è¡ŒSagaäº‹åŠ¡
        
        Args:
            saga_id: Sagaäº‹åŠ¡ID
            
        Returns:
            bool: äº‹åŠ¡æ˜¯å¦æˆåŠŸ
            
        Raises:
            Exception: äº‹åŠ¡æ‰§è¡Œå¤±è´¥æ—¶æŠ›å‡ºå¼‚å¸¸
        """
        # è®°å½•Sagaå¼€å§‹
        await self.db.execute(
            "INSERT INTO saga_logs (id, status, steps_total, steps_completed, created_at) VALUES (?, ?, ?, ?, NOW())",
            (saga_id, 'running', len(self.steps), 0)
        )
        
        executed_steps: List[dict] = []
        
        try:
            # æ­£å‘æ‰§è¡Œæ‰€æœ‰æ­¥éª¤
            for i, step in enumerate(self.steps):
                logger.info(f"æ‰§è¡Œæ­¥éª¤ {i + 1}/{len(self.steps)}")
                
                result = await step()
                executed_steps.append({
                    'step_index': i,
                    'result': result
                })
                
                # è®°å½•æ­¥éª¤å®Œæˆ
                await self.db.execute(
                    "UPDATE saga_logs SET steps_completed = ? WHERE id = ?",
                    (i + 1, saga_id)
                )
            
            # æ ‡è®°æˆåŠŸ
            await self.db.execute(
                "UPDATE saga_logs SET status = 'completed', completed_at = NOW() WHERE id = ?",
                (saga_id,)
            )
            
            logger.info(f"Sagaäº‹åŠ¡ {saga_id} æ‰§è¡ŒæˆåŠŸ")
            return True
            
        except Exception as e:
            logger.error(f"Sagaäº‹åŠ¡ {saga_id} æ‰§è¡Œå¤±è´¥: {str(e)}")
            
            # æ‰§è¡Œè¡¥å¿æ“ä½œï¼ˆåå‘æ‰§è¡Œï¼‰
            for i in range(len(executed_steps) - 1, -1, -1):
                try:
                    step_info = executed_steps[i]
                    logger.info(f"æ‰§è¡Œè¡¥å¿æ­¥éª¤ {step_info['step_index'] + 1}")
                    
                    await self.compensations[i](step_info['result'])
                    
                except Exception as comp_error:
                    logger.error(f"è¡¥å¿æ“ä½œå¤±è´¥: {comp_error}")
                    # è¡¥å¿å¤±è´¥ï¼Œè®°å½•ä½†ç»§ç»­æ‰§è¡Œå…¶ä»–è¡¥å¿
                    continue
            
            # æ ‡è®°å¤±è´¥
            await self.db.execute(
                "UPDATE saga_logs SET status = 'failed', error = ?, completed_at = NOW() WHERE id = ?",
                (str(e), saga_id)
            )
            
            raise e
```

**2. ä½¿ç”¨ç¤ºä¾‹**ï¼š
```python
# app/services/user_workflow_service.py
from app.services.saga import SagaOrchestrator

async def create_user_with_workflow(user_data: dict):
    """åˆ›å»ºç”¨æˆ·å¹¶åˆå§‹åŒ–å·¥ä½œæµ
    
    è¿™æ˜¯ä¸€ä¸ªè·¨æœåŠ¡çš„äº‹åŠ¡ï¼Œæ¶‰åŠç”¨æˆ·åŸŸæœåŠ¡å’Œä¸šåŠ¡åŸŸæœåŠ¡
    """
    saga_id = generate_uuid()
    saga = SagaOrchestrator(db_session)
    
    # æ­¥éª¤1ï¼šåˆ›å»ºç”¨æˆ·ï¼ˆç”¨æˆ·åŸŸæœåŠ¡ï¼‰
    def create_user():
        return user_service.create(user_data)
    
    def compensate_create_user(user):
        return user_service.delete(user['id'])
    
    saga.add_step(create_user, compensate_create_user)
    
    # æ­¥éª¤2ï¼šåˆ†é…è§’è‰²ï¼ˆæƒé™åŸŸæœåŠ¡ï¼‰
    def assign_role(user):
        return role_service.assign(user['id'], user['role_id'])
    
    def compensate_assign_role(user):
        return role_service.revoke(user['id'], user['role_id'])
    
    saga.add_step(assign_role, compensate_assign_role)
    
    # æ­¥éª¤3ï¼šåˆå§‹åŒ–å·¥ä½œæµï¼ˆä¸šåŠ¡åŸŸæœåŠ¡ï¼‰
    def init_workflow(user):
        return workflow_service.init_default_workflow(user['id'])
    
    def compensate_init_workflow(user):
        return workflow_service.delete_user_workflows(user['id'])
    
    saga.add_step(init_workflow, compensate_init_workflow)
    
    # æ‰§è¡ŒSaga
    try:
        await saga.execute(saga_id)
        logger.info(f"ç”¨æˆ·åˆ›å»ºå’Œå·¥ä½œæµåˆå§‹åŒ–æˆåŠŸ: {saga_id}")
        return True
    except Exception as e:
        logger.error(f"ç”¨æˆ·åˆ›å»ºå’Œå·¥ä½œæµåˆå§‹åŒ–å¤±è´¥: {e}")
        return False
```

**3. æ•°æ®åº“è¡¨è®¾è®¡**ï¼š
```sql
-- Sagaæ—¥å¿—è¡¨
CREATE TABLE saga_logs (
    id VARCHAR(50) PRIMARY KEY,
    status VARCHAR(20) NOT NULL COMMENT 'çŠ¶æ€ï¼ˆrunning/completed/failedï¼‰',
    steps_total INT NOT NULL COMMENT 'æ€»æ­¥éª¤æ•°',
    steps_completed INT DEFAULT 0 COMMENT 'å·²å®Œæˆæ­¥éª¤æ•°',
    error TEXT COMMENT 'é”™è¯¯ä¿¡æ¯',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    completed_at DATETIME,
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
);
```

#### 2.4.3 å…¶ä»–åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆ

è™½ç„¶æœ¬ç³»ç»Ÿé‡‡ç”¨Sagaæ¨¡å¼ï¼Œä½†ä¹Ÿäº†è§£å…¶ä»–æ–¹æ¡ˆï¼š

**1. TCCæ¨¡å¼ï¼ˆTry-Confirm-Cancelï¼‰**ï¼š
- **ç‰¹ç‚¹**ï¼šä¸‰é˜¶æ®µæäº¤ï¼Œå¼ºä¸€è‡´æ€§
- **ä¼˜ç‚¹**ï¼šä¸€è‡´æ€§é«˜
- **ç¼ºç‚¹**ï¼šå®ç°å¤æ‚ï¼Œæ¯ä¸ªæœåŠ¡éœ€è¦å®ç°ä¸‰ä¸ªæ¥å£
- **é€‚ç”¨åœºæ™¯**ï¼šå¯¹ä¸€è‡´æ€§è¦æ±‚æé«˜çš„åœºæ™¯

**2. æœ¬åœ°æ¶ˆæ¯è¡¨**ï¼š
- **ç‰¹ç‚¹**ï¼šåŸºäºæ¶ˆæ¯é˜Ÿåˆ—çš„æœ€ç»ˆä¸€è‡´æ€§
- **ä¼˜ç‚¹**ï¼šå®ç°ç®€å•
- **ç¼ºç‚¹**ï¼šåªèƒ½ä¿è¯æœ€ç»ˆä¸€è‡´æ€§
- **é€‚ç”¨åœºæ™¯**ï¼šå¼‚æ­¥åœºæ™¯ï¼Œå…è®¸çŸ­æš‚ä¸ä¸€è‡´

#### 2.4.4 åˆ†å¸ƒå¼äº‹åŠ¡æœ€ä½³å®è·µ

**Sagaæ¨¡å¼æœ€ä½³å®è·µ**ï¼š
- âœ… æ¯ä¸ªä¸šåŠ¡æ­¥éª¤éƒ½è¦æœ‰å¯¹åº”çš„è¡¥å¿æ“ä½œ
- âœ… è¡¥å¿æ“ä½œè¦ä¿è¯å¹‚ç­‰æ€§ï¼ˆå¤šæ¬¡æ‰§è¡Œç»“æœç›¸åŒï¼‰
- âœ… è®°å½•Sagaæ‰§è¡Œæ—¥å¿—ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥
- âœ… å®ç°è¶…æ—¶æœºåˆ¶ï¼Œé˜²æ­¢é•¿æ—¶é—´é˜»å¡
- âœ… å®ç°é‡è¯•æœºåˆ¶ï¼Œå¤„ç†ä¸´æ—¶æ€§æ•…éšœ
- âœ… è¡¥å¿å¤±è´¥æ—¶è®°å½•æ—¥å¿—ï¼Œäººå·¥ä»‹å…¥å¤„ç†

**äº‹åŠ¡è®¾è®¡åŸåˆ™**ï¼š
- âœ… å°½é‡å‡å°‘è·¨æœåŠ¡äº‹åŠ¡ï¼Œæé«˜å†…èšæ€§
- âœ… é•¿äº‹åŠ¡æ‹†åˆ†ä¸ºå¤šä¸ªçŸ­äº‹åŠ¡
- âœ… ä¼˜å…ˆä½¿ç”¨æœ€ç»ˆä¸€è‡´æ€§ï¼Œé¿å…å¼ºä¸€è‡´æ€§
- âœ… åˆç†ä½¿ç”¨è¡¥å¿æœºåˆ¶ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§

---

## 2.5 ä¼ä¸šçº§é¡¹ç›®ç»“æ„

### 2.5.1 æ•´ä½“ç›®å½•ç»“æ„

æœ¬ç³»ç»Ÿé‡‡ç”¨**ä¼ä¸šçº§FastAPIå¾®æœåŠ¡æ¡†æ¶**ï¼Œæ¯ä¸ªå¾®æœåŠ¡éƒ½éµå¾ªç»Ÿä¸€çš„åˆ†å±‚æ¶æ„ï¼Œç¡®ä¿ä»£ç çš„å¯ç»´æŠ¤æ€§ã€å¯æ‰©å±•æ€§å’Œå¯æµ‹è¯•æ€§ã€‚

```
backend/
â”œâ”€â”€ common/                          # å…±äº«ä»£ç åº“ï¼ˆæ‰€æœ‰æœåŠ¡å…±ç”¨ï¼‰
â”‚   â”œâ”€â”€ cache/                       # ç¼“å­˜æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ local.py                 # æœ¬åœ°ç¼“å­˜å®ç°
â”‚   â”‚   â””â”€â”€ redis.py                 # Redisç¼“å­˜å®ç°
â”‚   â”œâ”€â”€ config/                      # é…ç½®æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ constants.py             # å¸¸é‡å®šä¹‰
â”‚   â”‚   â””â”€â”€ settings.py              # é…ç½®ç±»
â”‚   â”œâ”€â”€ database/                    # æ•°æ®åº“æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ base.py                  # åŸºç¡€æ¨¡å‹ç±»
â”‚   â”‚   â”œâ”€â”€ connection.py            # å¤šæ•°æ®æºç®¡ç†å™¨
â”‚   â”‚   â”œâ”€â”€ pandas_helper.py         # Pandasæ•°æ®åˆ†æåŠ©æ‰‹
â”‚   â”‚   â”œâ”€â”€ session.py               # æ•°æ®åº“ä¼šè¯ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ transaction.py           # è·¨æ•°æ®æºäº‹åŠ¡ç®¡ç†
â”‚   â”‚   â””â”€â”€ models/                  # å…±äº«æ•°æ®æ¨¡å‹
â”‚   â”‚       â”œâ”€â”€ permission.py        # æƒé™ç›¸å…³æ¨¡å‹
â”‚   â”‚       â”œâ”€â”€ system.py            # ç³»ç»Ÿç›¸å…³æ¨¡å‹
â”‚   â”‚       â”œâ”€â”€ tenant.py            # ç§Ÿæˆ·ç›¸å…³æ¨¡å‹
â”‚   â”‚       â”œâ”€â”€ todo.py              # å¾…åŠä»»åŠ¡æ¨¡å‹
â”‚   â”‚       â”œâ”€â”€ user.py              # ç”¨æˆ·ç›¸å…³æ¨¡å‹
â”‚   â”‚       â””â”€â”€ workflow.py          # å·¥ä½œæµç›¸å…³æ¨¡å‹
â”‚   â”œâ”€â”€ decorators/                  # è£…é¥°å™¨
â”‚   â”‚   â”œâ”€â”€ cache.py                 # ç¼“å­˜è£…é¥°å™¨
â”‚   â”‚   â””â”€â”€ permission.py            # æƒé™è£…é¥°å™¨
â”‚   â”œâ”€â”€ exceptions/                  # å¼‚å¸¸ç±»
â”‚   â”‚   â””â”€â”€ base.py                  # åŸºç¡€å¼‚å¸¸ç±»
â”‚   â”œâ”€â”€ middleware/                  # ä¸­é—´ä»¶
â”‚   â”‚   â”œâ”€â”€ auth.py                  # è®¤è¯ä¸­é—´ä»¶
â”‚   â”‚   â”œâ”€â”€ exception.py             # å¼‚å¸¸å¤„ç†ä¸­é—´ä»¶
â”‚   â”‚   â””â”€â”€ logging.py               # æ—¥å¿—ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ responses/                   # å“åº”æ¨¡å—
â”‚   â”‚   â””â”€â”€ base.py                  # ç»Ÿä¸€å“åº”æ ¼å¼
â”‚   â”œâ”€â”€ security/                    # å®‰å…¨æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ api_key.py               # API Keyç®¡ç†
â”‚   â”‚   â”œâ”€â”€ jwt.py                   # JWTå·¥å…·
â”‚   â”‚   â””â”€â”€ password.py              # å¯†ç åŠ å¯†
â”‚   â””â”€â”€ utils/                       # å·¥å…·æ¨¡å—
â”‚       â”œâ”€â”€ datetime.py              # æ—¥æœŸæ—¶é—´å·¥å…·
â”‚       â”œâ”€â”€ helpers.py               # è¾…åŠ©å‡½æ•°
â”‚       â””â”€â”€ validators.py            # éªŒè¯å™¨
â”‚
â”œâ”€â”€ services/                        # å¾®æœåŠ¡ç›®å½•
â”‚   â”œâ”€â”€ auth-service/                # è®¤è¯åŸŸæœåŠ¡ï¼ˆ8001ï¼‰
â”‚   â”‚   â”œâ”€â”€ app/                     # åº”ç”¨ä¸»ç›®å½•
â”‚   â”‚   â”‚   â”œâ”€â”€ api/                 # APIè·¯ç”±å±‚
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ v1/              # APIç‰ˆæœ¬1
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ auth.py      # è®¤è¯ç›¸å…³API
â”‚   â”‚   â”‚   â”œâ”€â”€ core/                # æ ¸å¿ƒé…ç½®
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ config.py        # æœåŠ¡é…ç½®
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ deps.py          # ä¾èµ–æ³¨å…¥
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ security.py      # å®‰å…¨é…ç½®
â”‚   â”‚   â”‚   â”œâ”€â”€ models/              # æ•°æ®æ¨¡å‹å±‚ï¼ˆSQLAlchemy ORMï¼‰
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ user.py          # ç”¨æˆ·æ¨¡å‹
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ token.py         # Tokenæ¨¡å‹
â”‚   â”‚   â”‚   â”œâ”€â”€ repositories/        # æ•°æ®è®¿é—®å±‚
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ user_repository.py       # ç”¨æˆ·æ•°æ®è®¿é—®
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ token_repository.py      # Tokenæ•°æ®è®¿é—®
â”‚   â”‚   â”‚   â”œâ”€â”€ schemas/             # Pydanticæ¨¡å‹ï¼ˆè¯·æ±‚/å“åº”éªŒè¯ï¼‰
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ auth.py          # è®¤è¯Schema
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ user.py          # ç”¨æˆ·Schema
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ token.py         # Token Schema
â”‚   â”‚   â”‚   â”œâ”€â”€ services/            # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ auth_service.py  # è®¤è¯æœåŠ¡
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ token_service.py # Tokenç®¡ç†æœåŠ¡
â”‚   â”‚   â”‚   â””â”€â”€ main.py              # FastAPIåº”ç”¨å…¥å£
â”‚   â”‚   â”œâ”€â”€ alembic/                 # æ•°æ®åº“è¿ç§»
â”‚   â”‚   â”‚   â”œâ”€â”€ env.py               # è¿ç§»ç¯å¢ƒé…ç½®
â”‚   â”‚   â”‚   â”œâ”€â”€ script.py.mako       # è¿ç§»æ¨¡æ¿
â”‚   â”‚   â”‚   â””â”€â”€ versions/            # è¿ç§»ç‰ˆæœ¬æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ scripts/                 # å·¥å…·è„šæœ¬
â”‚   â”‚   â”œâ”€â”€ tests/                   # æµ‹è¯•ç›®å½•
â”‚   â”‚   â”‚   â”œâ”€â”€ unit/                # å•å…ƒæµ‹è¯•
â”‚   â”‚   â”‚   â””â”€â”€ integration/         # é›†æˆæµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ .env.development         # å¼€å‘ç¯å¢ƒé…ç½®
â”‚   â”‚   â”œâ”€â”€ .env.production          # ç”Ÿäº§ç¯å¢ƒé…ç½®
â”‚   â”‚   â”œâ”€â”€ docker-compose.yml       # Dockerç¼–æ’
â”‚   â”‚   â”œâ”€â”€ Dockerfile               # Dockeré•œåƒæ„å»º
â”‚   â”‚   â”œâ”€â”€ requirements.txt         # Pythonä¾èµ–
â”‚   â”‚   â””â”€â”€ README.md                # æœåŠ¡æ–‡æ¡£
â”‚   â”‚
â”‚   â”œâ”€â”€ user-service/                # ç”¨æˆ·åŸŸæœåŠ¡ï¼ˆ8002ï¼‰
â”‚   â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”‚   â”œâ”€â”€ api/v1/              # APIè·¯ç”±
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ users.py         # ç”¨æˆ·API
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ departments.py   # éƒ¨é—¨API
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ tenants.py       # ç§Ÿæˆ·API
â”‚   â”‚   â”‚   â”œâ”€â”€ core/                # æ ¸å¿ƒé…ç½®
â”‚   â”‚   â”‚   â”œâ”€â”€ models/              # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ user.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ department.py
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ tenant.py
â”‚   â”‚   â”‚   â”œâ”€â”€ repositories/        # æ•°æ®è®¿é—®å±‚
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ user_repository.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ department_repository.py
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ tenant_repository.py
â”‚   â”‚   â”‚   â”œâ”€â”€ schemas/             # Pydanticæ¨¡å‹
â”‚   â”‚   â”‚   â”œâ”€â”€ services/            # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ user_service.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ department_service.py
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ tenant_service.py
â”‚   â”‚   â”‚   â””â”€â”€ main.py
â”‚   â”‚   â”œâ”€â”€ alembic/
â”‚   â”‚   â”œâ”€â”€ tests/
â”‚   â”‚   â””â”€â”€ ...ï¼ˆå…¶ä»–é…ç½®æ–‡ä»¶åŒauth-serviceï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ permission-service/          # æƒé™åŸŸæœåŠ¡ï¼ˆ8003ï¼‰
â”‚   â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”‚   â”œâ”€â”€ api/v1/              # APIè·¯ç”±
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ roles.py         # è§’è‰²API
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ permissions.py   # æƒé™API
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ menus.py         # èœå•API
â”‚   â”‚   â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”‚   â”œâ”€â”€ models/              # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ role.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ permission.py
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ menu.py
â”‚   â”‚   â”‚   â”œâ”€â”€ repositories/        # æ•°æ®è®¿é—®å±‚
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ role_repository.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ permission_repository.py
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ menu_repository.py
â”‚   â”‚   â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â”‚   â”œâ”€â”€ services/            # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ role_service.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ permission_service.py
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ menu_service.py
â”‚   â”‚   â”‚   â””â”€â”€ main.py
â”‚   â”‚   â”œâ”€â”€ alembic/
â”‚   â”‚   â”œâ”€â”€ tests/
â”‚   â”‚   â””â”€â”€ ...ï¼ˆå…¶ä»–é…ç½®æ–‡ä»¶åŒauth-serviceï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ system-service/              # ç³»ç»ŸåŸŸæœåŠ¡ï¼ˆ8004ï¼‰
â”‚   â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”‚   â”œâ”€â”€ api/v1/              # APIè·¯ç”±
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ mcp_tools.py     # MCPå·¥å…·API
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ datasources.py   # æ•°æ®æºAPI
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ dicts.py         # å­—å…¸API
â”‚   â”‚   â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”‚   â”œâ”€â”€ models/              # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ mcp_tool.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ datasource.py
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ dict.py
â”‚   â”‚   â”‚   â”œâ”€â”€ repositories/        # æ•°æ®è®¿é—®å±‚
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ mcp_tool_repository.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ datasource_repository.py
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ dict_repository.py
â”‚   â”‚   â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â”‚   â”œâ”€â”€ services/            # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ mcp_tool_service.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ datasource_service.py
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ dict_service.py
â”‚   â”‚   â”‚   â””â”€â”€ main.py
â”‚   â”‚   â”œâ”€â”€ alembic/
â”‚   â”‚   â”œâ”€â”€ tests/
â”‚   â”‚   â””â”€â”€ ...ï¼ˆå…¶ä»–é…ç½®æ–‡ä»¶åŒauth-serviceï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ support-service/             # æ”¯æ’‘åŸŸæœåŠ¡ï¼ˆ8005ï¼‰
â”‚   â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”‚   â”œâ”€â”€ api/v1/              # APIè·¯ç”±
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ logs.py          # æ—¥å¿—API
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ notifications.py # é€šçŸ¥API
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ todos.py         # å¾…åŠä»»åŠ¡API
â”‚   â”‚   â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”‚   â”œâ”€â”€ models/              # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ log.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ notification.py
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ todo.py
â”‚   â”‚   â”‚   â”œâ”€â”€ repositories/        # æ•°æ®è®¿é—®å±‚
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ log_repository.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ notification_repository.py
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ todo_repository.py
â”‚   â”‚   â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â”‚   â”œâ”€â”€ services/            # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ log_service.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ notification_service.py
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ todo_service.py
â”‚   â”‚   â”‚   â””â”€â”€ main.py
â”‚   â”‚   â”œâ”€â”€ alembic/
â”‚   â”‚   â”œâ”€â”€ tests/
â”‚   â”‚   â””â”€â”€ ...ï¼ˆå…¶ä»–é…ç½®æ–‡ä»¶åŒauth-serviceï¼‰
â”‚   â”‚
â”‚   â””â”€â”€ business-service/            # ä¸šåŠ¡åŸŸæœåŠ¡ï¼ˆ8006ï¼‰
â”‚       â”œâ”€â”€ app/
â”‚       â”‚   â”œâ”€â”€ api/v1/              # APIè·¯ç”±
â”‚       â”‚   â”‚   â”œâ”€â”€ workflows.py             # å·¥ä½œæµAPI
â”‚       â”‚   â”‚   â”œâ”€â”€ workflow_templates.py    # å·¥ä½œæµæ¨¡æ¿API
â”‚       â”‚   â”‚   â””â”€â”€ workflow_tasks.py        # å·¥ä½œæµä»»åŠ¡API
â”‚       â”‚   â”œâ”€â”€ core/
â”‚       â”‚   â”œâ”€â”€ models/              # æ•°æ®æ¨¡å‹
â”‚       â”‚   â”‚   â”œâ”€â”€ workflow.py
â”‚       â”‚   â”‚   â”œâ”€â”€ workflow_template.py
â”‚       â”‚   â”‚   â””â”€â”€ workflow_task.py
â”‚       â”‚   â”œâ”€â”€ repositories/        # æ•°æ®è®¿é—®å±‚
â”‚       â”‚   â”‚   â”œâ”€â”€ workflow_repository.py
â”‚       â”‚   â”‚   â”œâ”€â”€ workflow_template_repository.py
â”‚       â”‚   â”‚   â””â”€â”€ workflow_task_repository.py
â”‚       â”‚   â”œâ”€â”€ schemas/
â”‚       â”‚   â”œâ”€â”€ services/            # ä¸šåŠ¡é€»è¾‘å±‚
â”‚       â”‚   â”‚   â”œâ”€â”€ workflow_service.py
â”‚       â”‚   â”‚   â”œâ”€â”€ workflow_template_service.py
â”‚       â”‚   â”‚   â””â”€â”€ workflow_task_service.py
â”‚       â”‚   â””â”€â”€ main.py
â”‚       â”œâ”€â”€ alembic/
â”‚       â”œâ”€â”€ tests/
â”‚       â””â”€â”€ ...ï¼ˆå…¶ä»–é…ç½®æ–‡ä»¶åŒauth-serviceï¼‰
â”‚
â”œâ”€â”€ tests/                           # é›†æˆæµ‹è¯•
â”‚   â”œâ”€â”€ test_backend_apis.py         # åç«¯APIé›†æˆæµ‹è¯•
â”‚   â”œâ”€â”€ æµ‹è¯•è®¡åˆ’.md                  # æµ‹è¯•è®¡åˆ’æ–‡æ¡£
â”‚   â””â”€â”€ æµ‹è¯•æŠ¥å‘Š.json                # æµ‹è¯•æŠ¥å‘Š
â”‚
â”œâ”€â”€ scripts/                         # å·¥å…·è„šæœ¬
â”‚   â”œâ”€â”€ execute_init_db.py           # æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
â”‚   â”œâ”€â”€ drop_tables.py               # åˆ é™¤è¡¨è„šæœ¬
â”‚   â”œâ”€â”€ generate_enterprise_structure.py  # ä¼ä¸šçº§ç»“æ„ç”Ÿæˆè„šæœ¬
â”‚   â””â”€â”€ ...ï¼ˆå…¶ä»–è„šæœ¬ï¼‰
â”‚
â”œâ”€â”€ alembic.ini                      # Alembicå…¨å±€é…ç½®
â”œâ”€â”€ start_services.bat               # å¯åŠ¨æ‰€æœ‰æœåŠ¡
â”œâ”€â”€ stop_services.bat                # åœæ­¢æ‰€æœ‰æœåŠ¡
â”œâ”€â”€ run_tests.bat                    # è¿è¡Œæµ‹è¯•
â””â”€â”€ __init__.py                      # åŒ…åˆå§‹åŒ–æ–‡ä»¶
```

### 2.5.2 åˆ†å±‚æ¶æ„è¯´æ˜

æœ¬ç³»ç»Ÿé‡‡ç”¨**å››å±‚æ¶æ„**ï¼Œæ¯å±‚èŒè´£æ˜ç¡®ï¼Œéµå¾ªå•ä¸€èŒè´£åŸåˆ™ï¼š

```mermaid
graph TB
    subgraph "APIè·¯ç”±å±‚ï¼ˆapi/ï¼‰"
        API[APIè·¯ç”±å±‚<br/>FastAPI Router]
    end
    
    subgraph "ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆservices/ï¼‰"
        Service[ä¸šåŠ¡é€»è¾‘å±‚<br/>Serviceç±»]
    end
    
    subgraph "æ•°æ®è®¿é—®å±‚ï¼ˆrepositories/ï¼‰"
        Repository[æ•°æ®è®¿é—®å±‚<br/>Repositoryç±»]
    end
    
    subgraph "æ•°æ®æ¨¡å‹å±‚ï¼ˆmodels/ï¼‰"
        Model[æ•°æ®æ¨¡å‹å±‚<br/>SQLAlchemy ORM]
    end
    
    subgraph "æ•°æ®åº“"
        DB[(MySQLæ•°æ®åº“)]
    end
    
    API --> Service
    Service --> Repository
    Repository --> Model
    Model --> DB
```

#### 2.5.2.1 APIè·¯ç”±å±‚ï¼ˆapi/ï¼‰

**èŒè´£**ï¼š
- æ¥æ”¶HTTPè¯·æ±‚
- å‚æ•°éªŒè¯ï¼ˆPydantic Schemaï¼‰
- è°ƒç”¨ä¸šåŠ¡é€»è¾‘å±‚
- è¿”å›HTTPå“åº”

**ç‰¹ç‚¹**ï¼š
- ä½¿ç”¨FastAPI Routerç»„ç»‡è·¯ç”±
- ä½¿ç”¨Pydantic Schemaè¿›è¡Œè¯·æ±‚/å“åº”éªŒè¯
- ä½¿ç”¨ä¾èµ–æ³¨å…¥è·å–æ•°æ®åº“ä¼šè¯
- ç»Ÿä¸€çš„å“åº”æ ¼å¼

**ç¤ºä¾‹ä»£ç **ï¼š
```python
# app/api/v1/users.py
from fastapi import APIRouter, Depends, HTTPException
from typing import List
from app.schemas.user import UserCreate, UserResponse
from app.services.user_service import UserService
from app.core.deps import get_db

router = APIRouter(prefix="/users", tags=["ç”¨æˆ·ç®¡ç†"])

@router.post("/", response_model=UserResponse, summary="åˆ›å»ºç”¨æˆ·")
async def create_user(
    user_data: UserCreate,
    db: Session = Depends(get_db)
):
    """åˆ›å»ºæ–°ç”¨æˆ·"""
    user_service = UserService(db)
    user = user_service.create(user_data)
    return user

@router.get("/{user_id}", response_model=UserResponse, summary="è·å–ç”¨æˆ·")
async def get_user(
    user_id: str,
    db: Session = Depends(get_db)
):
    """è·å–ç”¨æˆ·è¯¦æƒ…"""
    user_service = UserService(db)
    user = user_service.get_by_id(user_id)
    if not user:
        raise HTTPException(status_code=404, detail="ç”¨æˆ·ä¸å­˜åœ¨")
    return user
```

#### 2.5.2.2 ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆservices/ï¼‰

**èŒè´£**ï¼š
- å®ç°ä¸šåŠ¡é€»è¾‘
- åè°ƒå¤šä¸ªRepository
- å®ç°äº‹åŠ¡ç®¡ç†
- ä¸šåŠ¡è§„åˆ™éªŒè¯

**ç‰¹ç‚¹**ï¼š
- ä½¿ç”¨Serviceç±»å°è£…ä¸šåŠ¡é€»è¾‘
- é€šè¿‡Repositoryè®¿é—®æ•°æ®
- æ”¯æŒäº‹åŠ¡ç®¡ç†
- å¯å¤ç”¨çš„ä¸šåŠ¡é€»è¾‘

**ç¤ºä¾‹ä»£ç **ï¼š
```python
# app/services/user_service.py
from typing import Optional, List
from app.repositories.user_repository import UserRepository
from app.repositories.department_repository import DepartmentRepository
from app.schemas.user import UserCreate

class UserService:
    """ç”¨æˆ·ä¸šåŠ¡é€»è¾‘æœåŠ¡"""
    
    def __init__(self, db: Session):
        self.db = db
        self.user_repo = UserRepository(db)
        self.dept_repo = DepartmentRepository(db)
    
    def create(self, user_data: UserCreate) -> User:
        """åˆ›å»ºç”¨æˆ·
        
        ä¸šåŠ¡é€»è¾‘ï¼š
        1. éªŒè¯éƒ¨é—¨æ˜¯å¦å­˜åœ¨
        2. åˆ›å»ºç”¨æˆ·
        3. åˆ†é…é»˜è®¤è§’è‰²
        """
        # éªŒè¯éƒ¨é—¨
        if user_data.department_id:
            dept = self.dept_repo.get_by_id(user_data.department_id)
            if not dept:
                raise ValueError("éƒ¨é—¨ä¸å­˜åœ¨")
        
        # åˆ›å»ºç”¨æˆ·
        user = self.user_repo.create(user_data)
        
        # åˆ†é…é»˜è®¤è§’è‰²ï¼ˆå¯é€‰ï¼‰
        # self.role_repo.assign_default_role(user.id)
        
        return user
    
    def get_by_id(self, user_id: str) -> Optional[User]:
        """æ ¹æ®IDè·å–ç”¨æˆ·"""
        return self.user_repo.get_by_id(user_id)
    
    def update(self, user_id: str, user_data: dict) -> Optional[User]:
        """æ›´æ–°ç”¨æˆ·"""
        return self.user_repo.update(user_id, user_data)
    
    def delete(self, user_id: str) -> bool:
        """åˆ é™¤ç”¨æˆ·"""
        return self.user_repo.delete(user_id)
```

#### 2.5.2.3 æ•°æ®è®¿é—®å±‚ï¼ˆrepositories/ï¼‰

**èŒè´£**ï¼š
- å°è£…æ•°æ®åº“æ“ä½œ
- æä¾›CRUDæ–¹æ³•
- å®ç°æŸ¥è¯¢é€»è¾‘
- æ•°æ®ç¼“å­˜ï¼ˆå¯é€‰ï¼‰

**ç‰¹ç‚¹**ï¼š
- ä½¿ç”¨Repositoryæ¨¡å¼
- å°è£…SQLAlchemyæ“ä½œ
- æä¾›ç»Ÿä¸€çš„æŸ¥è¯¢æ¥å£
- æ”¯æŒå¤æ‚æŸ¥è¯¢

**ç¤ºä¾‹ä»£ç **ï¼š
```python
# app/repositories/user_repository.py
from typing import Optional, List
from sqlalchemy.orm import Session
from app.models.user import User

class UserRepository:
    """ç”¨æˆ·æ•°æ®è®¿é—®å±‚"""
    
    def __init__(self, db: Session):
        self.db = db
    
    def get_by_id(self, user_id: str) -> Optional[User]:
        """æ ¹æ®IDè·å–ç”¨æˆ·"""
        return self.db.query(User).filter(User.id == user_id).first()
    
    def get_by_username(self, username: str) -> Optional[User]:
        """æ ¹æ®ç”¨æˆ·åè·å–ç”¨æˆ·"""
        return self.db.query(User).filter(User.username == username).first()
    
    def create(self, user_data: dict) -> User:
        """åˆ›å»ºç”¨æˆ·"""
        user = User(**user_data)
        self.db.add(user)
        self.db.commit()
        self.db.refresh(user)
        return user
    
    def update(self, user_id: str, user_data: dict) -> Optional[User]:
        """æ›´æ–°ç”¨æˆ·"""
        user = self.get_by_id(user_id)
        if not user:
            return None
        
        for key, value in user_data.items():
            if hasattr(user, key):
                setattr(user, key, value)
        
        self.db.commit()
        self.db.refresh(user)
        return user
    
    def delete(self, user_id: str) -> bool:
        """åˆ é™¤ç”¨æˆ·"""
        user = self.get_by_id(user_id)
        if not user:
            return False
        
        self.db.delete(user)
        self.db.commit()
        return True
    
    def list(self, skip: int = 0, limit: int = 100) -> List[User]:
        """è·å–ç”¨æˆ·åˆ—è¡¨"""
        return self.db.query(User).offset(skip).limit(limit).all()
```

#### 2.5.2.4 æ•°æ®æ¨¡å‹å±‚ï¼ˆmodels/ï¼‰

**èŒè´£**ï¼š
- å®šä¹‰æ•°æ®åº“è¡¨ç»“æ„
- å®ç°ORMæ˜ å°„
- å®šä¹‰è¡¨å…³ç³»
- æ•°æ®éªŒè¯

**ç‰¹ç‚¹**ï¼š
- ä½¿ç”¨SQLAlchemy ORM
- ç»§æ‰¿è‡ªBaseModel
- å®šä¹‰è¡¨å…³ç³»ï¼ˆä¸€å¯¹å¤šã€å¤šå¯¹å¤šï¼‰
- æ”¯æŒç´¢å¼•å’Œçº¦æŸ

**ç¤ºä¾‹ä»£ç **ï¼š
```python
# app/models/user.py
from sqlalchemy import Column, String, Boolean, DateTime, Text
from sqlalchemy.orm import relationship
from datetime import datetime
from common.database.base import BaseModel

class User(BaseModel):
    """ç”¨æˆ·æ¨¡å‹"""
    
    __tablename__ = "users"
    
    # åŸºæœ¬ä¿¡æ¯
    tenant_id = Column(String(64), nullable=False, index=True, comment="ç§Ÿæˆ·ID")
    username = Column(String(50), nullable=False, unique=True, index=True, comment="ç”¨æˆ·å")
    email = Column(String(100), nullable=False, index=True, comment="é‚®ç®±")
    password_hash = Column(String(255), nullable=False, comment="å¯†ç å“ˆå¸Œ")
    
    # ç”¨æˆ·ä¿¡æ¯
    full_name = Column(String(100), nullable=True, comment="å…¨å")
    phone = Column(String(20), nullable=True, comment="æ‰‹æœºå·")
    avatar = Column(String(255), nullable=True, comment="å¤´åƒURL")
    
    # çŠ¶æ€ä¿¡æ¯
    status = Column(String(20), nullable=False, default="active", comment="çŠ¶æ€ï¼ˆactive/disabledï¼‰")
    is_superuser = Column(Boolean, default=False, comment="æ˜¯å¦è¶…çº§ç®¡ç†å‘˜")
    
    # éƒ¨é—¨å’Œå²—ä½
    department_id = Column(String(64), nullable=True, comment="éƒ¨é—¨ID")
    position_id = Column(String(64), nullable=True, comment="å²—ä½ID")
    
    # æ‰©å±•ä¿¡æ¯
    bio = Column(Text, nullable=True, comment="ä¸ªäººç®€ä»‹")
    preferences = Column(Text, nullable=True, comment="ç”¨æˆ·åå¥½è®¾ç½®ï¼ˆJSONï¼‰")
    
    # å…³ç³»
    tokens = relationship("Token", back_populates="user", cascade="all, delete-orphan")
    roles = relationship("Role", secondary="user_roles", back_populates="users")
    
    def __repr__(self):
        return f"<User(id={self.id}, username={self.username}, email={self.email})>"
```

### 2.5.3 åˆ†å±‚æ¶æ„çš„ä¼˜åŠ¿

**å¯ç»´æŠ¤æ€§**ï¼š
- âœ… æ¯å±‚èŒè´£æ˜ç¡®ï¼Œä»£ç ç»“æ„æ¸…æ™°
- âœ… ä¿®æ”¹æŸå±‚ä¸å½±å“å…¶ä»–å±‚
- âœ… ä¾¿äºå•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

**å¯æ‰©å±•æ€§**ï¼š
- âœ… æ–°å¢åŠŸèƒ½åªéœ€æ‰©å±•å¯¹åº”å±‚
- âœ… å¯ä»¥è½»æ¾æ›¿æ¢æŸå±‚å®ç°
- âœ… æ”¯æŒæ°´å¹³æ‰©å±•

**å¯å¤ç”¨æ€§**ï¼š
- âœ… Serviceå±‚å¯ä»¥è¢«å¤šä¸ªAPIå¤ç”¨
- âœ… Repositoryå±‚å¯ä»¥è¢«å¤šä¸ªServiceå¤ç”¨
- âœ… Modelå±‚å¯ä»¥è¢«å¤šä¸ªRepositoryå¤ç”¨

**å›¢é˜Ÿåä½œ**ï¼š
- âœ… ä¸åŒå¼€å‘è€…å¯ä»¥ä¸“æ³¨äºä¸åŒå±‚
- âœ… å‡å°‘ä»£ç å†²çª
- âœ… æé«˜å¼€å‘æ•ˆç‡

### 2.5.4 æœ€ä½³å®è·µ

**APIè·¯ç”±å±‚æœ€ä½³å®è·µ**ï¼š
- âœ… åªè´Ÿè´£æ¥æ”¶è¯·æ±‚å’Œè¿”å›å“åº”
- âœ… ä¸åŒ…å«ä¸šåŠ¡é€»è¾‘
- âœ… ä½¿ç”¨Pydantic SchemaéªŒè¯å‚æ•°
- âœ… ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†

**ä¸šåŠ¡é€»è¾‘å±‚æœ€ä½³å®è·µ**ï¼š
- âœ… å°è£…ä¸šåŠ¡é€»è¾‘
- âœ… å®ç°äº‹åŠ¡ç®¡ç†
- âœ… åè°ƒå¤šä¸ªRepository
- âœ… ä¸šåŠ¡è§„åˆ™éªŒè¯

**æ•°æ®è®¿é—®å±‚æœ€ä½³å®è·µ**ï¼š
- âœ… åªè´Ÿè´£æ•°æ®åº“æ“ä½œ
- âœ… ä¸åŒ…å«ä¸šåŠ¡é€»è¾‘
- âœ… æä¾›CRUDæ–¹æ³•
- âœ… æ”¯æŒå¤æ‚æŸ¥è¯¢

**æ•°æ®æ¨¡å‹å±‚æœ€ä½³å®è·µ**ï¼š
- âœ… åªå®šä¹‰è¡¨ç»“æ„
- âœ… å®šä¹‰è¡¨å…³ç³»
- âœ… æ·»åŠ ç´¢å¼•å’Œçº¦æŸ
- âœ… ä¸åŒ…å«ä¸šåŠ¡é€»è¾‘

---

## 3. æŠ€æœ¯æ ˆé€‰å‹è¯´æ˜

### 3.1 åç«¯æŠ€æœ¯æ ˆ

| æŠ€æœ¯ç»„ä»¶ | é€‰å‹ | ç‰ˆæœ¬ | é€‰å‹ç†ç”± |
|---------|------|------|---------|
| **Webæ¡†æ¶** | FastAPI | 0.104+ | é«˜æ€§èƒ½å¼‚æ­¥ã€è‡ªåŠ¨æ–‡æ¡£ã€ç±»å‹æç¤º |
| **ORM** | SQLAlchemy | 2.0+ | åŠŸèƒ½å¼ºå¤§ã€å¤šæ•°æ®åº“æ”¯æŒã€å¼‚æ­¥æ”¯æŒ |
| **é‰´æƒ** | PyJWT + python-jose | 2.8+ | è½»é‡çº§ã€çµæ´»ã€æ”¯æŒå¤šç§ç®—æ³• |
| **é…ç½®ä¸­å¿ƒ** | Nacos | 2.2+ | åŠŸèƒ½å®Œæ•´ã€æ”¯æŒåŠ¨æ€é…ç½®ã€æœåŠ¡å‘ç° |
| **æ¶ˆæ¯é˜Ÿåˆ—** | RabbitMQ | 3.12+ | åŠŸèƒ½å¼ºå¤§ã€å¯é æ€§é«˜ |
| **ç¼“å­˜** | Redis | 7.0+ | åŠŸèƒ½å¼ºå¤§ã€æ€§èƒ½é«˜ |
| **APIç½‘å…³** | APISIX | 3.5+ | é«˜æ€§èƒ½ã€äº‘åŸç”Ÿã€åŠ¨æ€è·¯ç”± |
| **é™æµç†”æ–­** | Sentinel | 1.8+ | åŠŸèƒ½å¼ºå¤§ã€å¯è§†åŒ–ç•Œé¢ |
| **åˆ†å¸ƒå¼è¿½è¸ª** | Jaeger | 1.50+ | åŠŸèƒ½å¼ºå¤§ã€å¯è§†åŒ–ç•Œé¢ |
| **ç›‘æ§** | Prometheus + Grafana | 2.45+ / 10.0+ | åŠŸèƒ½å¼ºå¤§ã€å¯è§†åŒ–å¥½ |
| **æ—¥å¿—** | loguru | 0.7+ | ç®€å•æ˜“ç”¨ã€åŠŸèƒ½å¼ºå¤§ |
| **æ•°æ®åº“è¿ç§»** | Alembic | 1.12+ | SQLAlchemyå®˜æ–¹å·¥å…· |
| **å®¹å™¨åŒ–** | Docker | 24.0+ | è½»é‡çº§ã€æ˜“ç”¨ |
| **CI/CD** | GitHub Actions | - | æ˜“ç”¨ã€å…è´¹ã€é›†æˆåº¦é«˜ |

### 3.2 å‰ç«¯æŠ€æœ¯æ ˆ

| æŠ€æœ¯ç»„ä»¶ | é€‰å‹ | ç‰ˆæœ¬ | é€‰å‹ç†ç”± |
|---------|------|------|---------|
| **æ¡†æ¶** | Vue | 3.3+ | æ¸è¿›å¼æ¡†æ¶ã€ç”Ÿæ€æˆç†Ÿ |
| **è¯­è¨€** | TypeScript | 5.0+ | ç±»å‹å®‰å…¨ã€å¼€å‘ä½“éªŒå¥½ |
| **æ„å»ºå·¥å…·** | Vite | 5.0+ | å¿«é€Ÿã€ç°ä»£åŒ– |
| **è·¯ç”±** | Vue Router | 4.2+ | å®˜æ–¹è·¯ç”±ã€åŠŸèƒ½å®Œå–„ |
| **çŠ¶æ€ç®¡ç†** | Pinia | 2.1+ | å®˜æ–¹çŠ¶æ€ç®¡ç†ã€ç®€å•æ˜“ç”¨ |
| **UIç»„ä»¶åº“** | Element Plus | 2.4+ | åŠŸèƒ½å®Œå–„ã€è®¾è®¡ç¾è§‚ |
| **HTTPå®¢æˆ·ç«¯** | Axios | 1.6+ | åŠŸèƒ½å¼ºå¤§ã€æ˜“ç”¨ |
| **ä»£ç è§„èŒƒ** | ESLint + Prettier | æœ€æ–° | ä»£ç è´¨é‡ä¿è¯ |

### 3.3 æ•°æ®åº“æŠ€æœ¯æ ˆ

| æ•°æ®åº“ | ç‰ˆæœ¬ | ç”¨é€” | é€‰å‹ç†ç”± |
|-------|------|------|---------|
| **MySQL** | 8.0+ | ä¸»æ•°æ®åº“ | æˆç†Ÿç¨³å®šã€æ€§èƒ½å¥½ã€ç”Ÿæ€å®Œå–„ |
| **PostgreSQL** | 15+ | å¯é€‰æ•°æ®åº“ | åŠŸèƒ½å¼ºå¤§ã€æ”¯æŒå¤æ‚æŸ¥è¯¢ |
| **Oracle** | 19c+ | å¯é€‰æ•°æ®åº“ | ä¼ä¸šçº§ã€åŠŸèƒ½å¼ºå¤§ |

---

## 4. æ¨¡å—åˆ’åˆ†ä¸èŒè´£

### 4.1 è®¤è¯åŸŸæœåŠ¡æ¨¡å—

**èŒè´£**ï¼š
- ç”¨æˆ·è®¤è¯ï¼ˆJWTã€API Keyï¼‰
- æƒé™æ ¡éªŒï¼ˆRBAC + ABACï¼‰
- Tokenç®¡ç†ï¼ˆç”Ÿæˆã€åˆ·æ–°ã€åŠé”€ï¼‰
- ä¼šè¯ç®¡ç†
- å•ç‚¹ç™»å½•ï¼ˆå¯é€‰ï¼‰

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- ç”¨æˆ·ç™»å½•/ç™»å‡º
- Tokenç”Ÿæˆä¸éªŒè¯
- æƒé™æ ¡éªŒè£…é¥°å™¨
- API Keyç®¡ç†
- å•ç‚¹ç™»å½•é›†æˆ

### 4.2 ç”¨æˆ·åŸŸæœåŠ¡æ¨¡å—

**èŒè´£**ï¼š
- ç”¨æˆ·CRUDæ“ä½œ
- éƒ¨é—¨ç®¡ç†ï¼ˆ5çº§éƒ¨é—¨æ ‘ï¼‰
- ç§Ÿæˆ·ç®¡ç†ï¼ˆSaaSå¤šç§Ÿæˆ·ï¼‰
- ç”¨æˆ·ä¸éƒ¨é—¨/è§’è‰²å…³è”
- å²—ä½ç®¡ç†

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- ç”¨æˆ·åˆ›å»º/ä¿®æ”¹/åˆ é™¤
- ç”¨æˆ·æŸ¥è¯¢ï¼ˆåˆ†é¡µã€æœç´¢ï¼‰
- ç”¨æˆ·çŠ¶æ€ç®¡ç†ï¼ˆå¯ç”¨/ç¦ç”¨ï¼‰
- éƒ¨é—¨æ ‘ç»“æ„ç®¡ç†
- éƒ¨é—¨ç¼–ç è‡ªåŠ¨ç”Ÿæˆ
- ç§Ÿæˆ·ç®¡ç†
- ç§Ÿæˆ·å¥—é¤é…ç½®
- èµ„æºé…é¢ç®¡ç†
- å²—ä½ç®¡ç†

### 4.3 æƒé™åŸŸæœåŠ¡æ¨¡å—

**èŒè´£**ï¼š
- è§’è‰²ç®¡ç†
- æƒé™ç®¡ç†
- èœå•ç®¡ç†
- æ•°æ®èŒƒå›´æƒé™
- åŠ¨æ€æƒé™æ§åˆ¶
- æƒé™ç¼“å­˜

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- è§’è‰²åˆ›å»º/ä¿®æ”¹/åˆ é™¤
- æƒé™åˆ†é…ï¼ˆèœå•ã€æ“ä½œã€æ•°æ®ï¼‰
- æƒé™ç»§æ‰¿é“¾
- èœå•æ ‘ç»“æ„ç®¡ç†
- èœå•æƒé™ç»‘å®š
- åŠ¨æ€èœå•åŠ è½½
- æ•°æ®èŒƒå›´æƒé™é…ç½®
- æƒé™ç¼“å­˜ç®¡ç†

### 4.4 ç³»ç»ŸåŸŸæœåŠ¡æ¨¡å—

**èŒè´£**ï¼š
- MCPå·¥å…·æ³¨å†Œä¸ç®¡ç†
- MCPå·¥å…·è°ƒç”¨ä¸ç›‘æ§
- å¤šæ•°æ®æºé…ç½®ä¸ç®¡ç†
- è·¨æ•°æ®åº“æŸ¥è¯¢
- å­—å…¸ç®¡ç†
- ç³»ç»Ÿé…ç½®ç®¡ç†
- é”™è¯¯ç ç®¡ç†

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- MCPå·¥å…·æ³¨å†Œï¼ˆAPIç«¯ç‚¹ â†’ MCPå·¥å…·ï¼‰
- MCPå·¥å…·è°ƒç”¨ï¼ˆæƒé™æ ¡éªŒã€è¶…æ—¶æ§åˆ¶ã€é‡è¯•æœºåˆ¶ï¼‰
- MCPå·¥å…·ç›‘æ§ï¼ˆè°ƒç”¨æ—¥å¿—ã€æˆåŠŸç‡ã€å“åº”æ—¶é—´ï¼‰
- MCPå·¥å…·æƒé™æ§åˆ¶
- å¤šæ•°æ®æºé…ç½®ï¼ˆMySQLã€PostgreSQLã€Oracleï¼‰
- è·¨æ•°æ®åº“æŸ¥è¯¢
- æ•°æ®æºå¥åº·æ£€æŸ¥
- å­—å…¸CRUDæ“ä½œ
- å­—å…¸åˆ†ç»„ç®¡ç†
- ç³»ç»Ÿé…ç½®ç®¡ç†
- é”™è¯¯ç ç®¡ç†

### 4.5 æ”¯æ’‘åŸŸæœåŠ¡æ¨¡å—

**èŒè´£**ï¼š
- ç™»å½•æ—¥å¿—è®°å½•
- æ“ä½œæ—¥å¿—è®°å½•
- ç«™å†…ä¿¡ç®¡ç†
- é€šçŸ¥å…¬å‘Šç®¡ç†
- æ•æ„Ÿè¯ç®¡ç†
- åœ°åŒºç®¡ç†
- å¾…åŠä»»åŠ¡ç®¡ç†ï¼ˆä¸ªäººå¾…åŠã€æ¯æ—¥è®¡åˆ’ã€ä»»åŠ¡æé†’ï¼‰

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- ç™»å½•æ—¥å¿—è®°å½•
- æ“ä½œæ—¥å¿—è®°å½•
- æ—¥å¿—æŸ¥è¯¢ï¼ˆåˆ†é¡µã€æœç´¢ï¼‰
- æ—¥å¿—åˆ†åŒ…ï¼ˆæŒ‰æ—¥æœŸ/å¤§å°ï¼‰
- ç«™å†…ä¿¡åˆ›å»º/å‘é€
- é€šçŸ¥å…¬å‘Šå‘å¸ƒ
- æ¶ˆæ¯é˜Ÿåˆ—é›†æˆï¼ˆRabbitMQï¼‰
- å¼‚æ­¥å‘é€
- æ•æ„Ÿè¯ç®¡ç†
- åœ°åŒºç®¡ç†ï¼ˆçœå¸‚åŒºï¼‰
- ä¸ªäººå¾…åŠä»»åŠ¡ï¼ˆåˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤ã€æ ‡è®°å®Œæˆã€ä¼˜å…ˆçº§ã€æˆªæ­¢æ—¶é—´ã€æ ‡ç­¾ã€é™„ä»¶ï¼‰
- æ¯æ—¥è®¡åˆ’ï¼ˆåˆ›å»ºã€æŸ¥è¯¢ã€å®Œæˆã€ç»Ÿè®¡ã€å†å²è®°å½•ï¼‰
- å¾…åŠä»»åŠ¡åˆ—è¡¨ï¼ˆåˆ†é¡µã€æœç´¢ã€ç­›é€‰ã€æ’åºï¼‰
- ä»»åŠ¡æé†’ï¼ˆåˆ°æœŸæé†’ã€è¶…æ—¶æé†’ã€æ¯æ—¥è®¡åˆ’æé†’ã€é€šçŸ¥æ¨é€ï¼‰

### 4.6 ä¸šåŠ¡åŸŸæœåŠ¡æ¨¡å—

**èŒè´£**ï¼š
- ä¸šåŠ¡é€»è¾‘ç®¡ç†
- å·¥ä½œæµç®¡ç†ï¼ˆå®¡æ‰¹æµç¨‹ã€å¯è§†åŒ–è®¾è®¡å™¨ã€å®¡æ‰¹ä»»åŠ¡ç®¡ç†ï¼‰
- é¢„ç•™ä¸šåŠ¡åŠŸèƒ½æ‰©å±•
- æ”¯æŒä¸šåŠ¡æ’ä»¶åŒ–

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- **å·¥ä½œæµç®¡ç†**ï¼š
  - é¢„ç½®å®¡æ‰¹æ¨¡æ¿ï¼ˆäººäº‹å®¡æ‰¹ã€æƒé™å®¡æ‰¹ã€è´¢åŠ¡å®¡æ‰¹ã€ITå®¡æ‰¹ï¼‰
  - å¯è§†åŒ–è®¾è®¡å™¨ï¼ˆæ‹–æ‹½å¼èŠ‚ç‚¹ç¼–è¾‘ã€æµç¨‹å›¾å±•ç¤ºã€èŠ‚ç‚¹é…ç½®ã€è¿æ¥çº¿é…ç½®ï¼‰
  - å®¡æ‰¹æµç¨‹é…ç½®ï¼ˆå•äººå®¡æ‰¹ã€å¤šäººå®¡æ‰¹ã€æ¡ä»¶åˆ†æ”¯ã€å¹¶è¡ŒèŠ‚ç‚¹ã€å®¡æ‰¹æ“ä½œï¼‰
  - å®¡æ‰¹ä»»åŠ¡ç®¡ç†ï¼ˆå¾…åŠã€å·²åŠã€æŠ„é€ã€ä»»åŠ¡è¯¦æƒ…ã€ä»»åŠ¡å¤„ç†ã€å®¡æ‰¹è¯„è®ºï¼‰
  - æµç¨‹ç›‘æ§ï¼ˆå®æ—¶ç›‘æ§ã€èŠ‚ç‚¹è¿›åº¦é«˜äº®ã€æ‰§è¡Œæ—¥å¿—ã€å¼‚å¸¸å¤„ç†ã€å†å²è®°å½•ï¼‰
  - é¦–é¡µçœ‹æ¿é›†æˆï¼ˆå·¥ä½œæµç»Ÿè®¡ã€å¾…åŠå®¡æ‰¹ä»»åŠ¡ï¼‰
- **é¢„ç•™ä¸šåŠ¡åŠŸèƒ½**ï¼š
  - è®¢å•ç®¡ç†ï¼ˆé¢„ç•™ï¼‰
  - å•†å“ç®¡ç†ï¼ˆé¢„ç•™ï¼‰
  - æŠ¥è¡¨ç»Ÿè®¡ï¼ˆé¢„ç•™ï¼‰
  - å…¶ä»–ä¸šåŠ¡åŠŸèƒ½ï¼ˆé¢„ç•™ï¼‰

---

## 5. æ•°æ®æµå‘è®¾è®¡

### 5.1 ç”¨æˆ·ç™»å½•æµç¨‹

```mermaid
sequenceDiagram
    participant Browser as Webæµè§ˆå™¨
    participant Vue as Vue 3å‰ç«¯<br/>:3000
    participant APISIX as APISIXç½‘å…³<br/>:9080
    participant Auth as è®¤è¯åŸŸæœåŠ¡<br/>:8001
    participant User as ç”¨æˆ·åŸŸæœåŠ¡<br/>:8002
    participant Redis as Redisç¼“å­˜<br/>:6379
    participant MySQL as MySQLæ•°æ®åº“<br/>:3306
    
    Browser->>Vue: è®¿é—®åº”ç”¨
    Vue->>Vue: åŠ è½½é¡µé¢
    Vue->>APISIX: POST /api/v1/auth/login
    APISIX->>Auth: è½¬å‘è¯·æ±‚
    Auth->>User: æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
    User->>MySQL: SELECT * FROM users WHERE username=?
    MySQL-->>User: ç”¨æˆ·ä¿¡æ¯
    User-->>Auth: ç”¨æˆ·ä¿¡æ¯
    Auth->>Auth: éªŒè¯å¯†ç 
    Auth->>Auth: ç”ŸæˆJWT Token
    Auth->>Redis: ç¼“å­˜Token
    Auth-->>APISIX: Token + ç”¨æˆ·ä¿¡æ¯
    APISIX-->>Vue: ç™»å½•å“åº”
    Vue->>Vue: å­˜å‚¨Tokenåˆ°localStorage
    Vue-->>Browser: è·³è½¬åˆ°é¦–é¡µ
```

### 5.2 MCPå·¥å…·è°ƒç”¨æµç¨‹

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant APISIX as APISIXç½‘å…³
    participant Auth as è®¤è¯æˆæƒæœåŠ¡
    participant MCP as MCPå·¥å…·ç®¡ç†æœåŠ¡
    participant MultiDB as å¤šæ•°æ®æºæœåŠ¡
    participant MySQL as MySQLæ•°æ®åº“
    participant Log as æ—¥å¿—å®¡è®¡æœåŠ¡
    
    Client->>APISIX: POST /api/v1/mcp/execute
    APISIX->>Auth: é‰´æƒ
    Auth-->>APISIX: ç”¨æˆ·ä¿¡æ¯
    APISIX->>MCP: è½¬å‘è¯·æ±‚
    MCP->>MCP: æƒé™æ ¡éªŒ
    MCP->>MultiDB: æŸ¥è¯¢æ•°æ®
    MultiDB->>MySQL: SELECT * FROM table
    MySQL-->>MultiDB: æ•°æ®
    MultiDB-->>MCP: æ•°æ®
    MCP->>MCP: æ‰§è¡Œå·¥å…·é€»è¾‘
    MCP->>Log: è®°å½•è°ƒç”¨æ—¥å¿—
    MCP-->>APISIX: æ‰§è¡Œç»“æœ
    APISIX-->>Client: å“åº”ç»“æœ
```

### 5.3 è·¨æ•°æ®æºæŸ¥è¯¢æµç¨‹

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant APISIX as APISIXç½‘å…³
    participant MultiDB as å¤šæ•°æ®æºæœåŠ¡
    participant MySQL as MySQLæ•°æ®åº“
    participant PostgreSQL as PostgreSQLæ•°æ®åº“
    participant Oracle as Oracleæ•°æ®åº“
    
    Client->>APISIX: POST /api/v1/multi-db/query
    APISIX->>MultiDB: è½¬å‘è¯·æ±‚
    MultiDB->>MySQL: æŸ¥è¯¢ä¸»è¡¨æ•°æ®
    MySQL-->>MultiDB: ä¸»è¡¨æ•°æ®
    MultiDB->>PostgreSQL: æŸ¥è¯¢å…³è”è¡¨æ•°æ®
    PostgreSQL-->>MultiDB: å…³è”è¡¨æ•°æ®
    MultiDB->>Oracle: æŸ¥è¯¢å…³è”è¡¨æ•°æ®
    Oracle-->>MultiDB: å…³è”è¡¨æ•°æ®
    MultiDB->>MultiDB: åº”ç”¨å±‚æ•°æ®å…³è”
    MultiDB-->>APISIX: æŸ¥è¯¢ç»“æœ
    APISIX-->>Client: å“åº”ç»“æœ
```

### 5.4 å¾…åŠä»»åŠ¡ç®¡ç†æµç¨‹

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Vue as Vue 3å‰ç«¯
    participant APISIX as APISIXç½‘å…³
    participant Support as æ”¯æ’‘åŸŸæœåŠ¡<br/>:8005
    participant MySQL as MySQLæ•°æ®åº“
    participant Notify as é€šçŸ¥æœåŠ¡
    
    User->>Vue: åˆ›å»ºå¾…åŠä»»åŠ¡
    Vue->>APISIX: POST /api/v1/todo/tasks
    APISIX->>Support: è½¬å‘è¯·æ±‚
    Support->>MySQL: INSERT INTO todo_tasks
    MySQL-->>Support: ä»»åŠ¡ID
    Support->>Support: è®¾ç½®ä»»åŠ¡æé†’
    Support->>Notify: å‘é€æé†’é€šçŸ¥
    Support-->>APISIX: ä»»åŠ¡åˆ›å»ºæˆåŠŸ
    APISIX-->>Vue: ä»»åŠ¡ä¿¡æ¯
    Vue-->>User: æ˜¾ç¤ºä»»åŠ¡åˆ—è¡¨
    
    User->>Vue: æ ‡è®°ä»»åŠ¡å®Œæˆ
    Vue->>APISIX: POST /api/v1/todo/tasks/{id}/complete
    APISIX->>Support: è½¬å‘è¯·æ±‚
    Support->>MySQL: UPDATE todo_tasks SET status='completed'
    Support-->>APISIX: æ“ä½œæˆåŠŸ
    APISIX-->>Vue: æ›´æ–°æˆåŠŸ
    Vue-->>User: æ›´æ–°ä»»åŠ¡çŠ¶æ€
```

### 5.5 å·¥ä½œæµå®¡æ‰¹æµç¨‹

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Vue as Vue 3å‰ç«¯
    participant APISIX as APISIXç½‘å…³
    participant Business as ä¸šåŠ¡åŸŸæœåŠ¡<br/>:8006
    participant MySQL as MySQLæ•°æ®åº“
    participant Support as æ”¯æ’‘åŸŸæœåŠ¡<br/>:8005
    participant Notify as é€šçŸ¥æœåŠ¡
    
    User->>Vue: å‘èµ·å®¡æ‰¹ç”³è¯·
    Vue->>APISIX: POST /api/v1/workflow/instances
    APISIX->>Business: è½¬å‘è¯·æ±‚
    Business->>Business: åˆ›å»ºå·¥ä½œæµå®ä¾‹
    Business->>Business: æ‰§è¡Œç¬¬ä¸€ä¸ªèŠ‚ç‚¹
    Business->>MySQL: INSERT INTO workflow_instances
    Business->>MySQL: INSERT INTO workflow_tasks
    Business->>Support: åˆ›å»ºå¾…åŠä»»åŠ¡
    Support->>MySQL: INSERT INTO todo_tasks
    Support->>Notify: å‘é€å®¡æ‰¹é€šçŸ¥
    Business-->>APISIX: å®ä¾‹åˆ›å»ºæˆåŠŸ
    APISIX-->>Vue: å®ä¾‹ä¿¡æ¯
    Vue-->>User: æ˜¾ç¤ºç”³è¯·æˆåŠŸ
    
    User->>Vue: å¤„ç†å®¡æ‰¹ä»»åŠ¡
    Vue->>APISIX: POST /api/v1/workflow/tasks/{id}/approve
    APISIX->>Business: è½¬å‘è¯·æ±‚
    Business->>Business: å®¡æ‰¹é€»è¾‘å¤„ç†
    Business->>MySQL: UPDATE workflow_tasks
    Business->>Support: å®Œæˆå¾…åŠä»»åŠ¡
    Support->>MySQL: UPDATE todo_tasks
    Business->>Business: æ‰§è¡Œä¸‹ä¸€ä¸ªèŠ‚ç‚¹
    Business-->>APISIX: å®¡æ‰¹æˆåŠŸ
    APISIX-->>Vue: æ›´æ–°æˆåŠŸ
    Vue-->>User: æ˜¾ç¤ºå®¡æ‰¹ç»“æœ
```

---

## 6. éƒ¨ç½²æ¶æ„è®¾è®¡

### 6.1 éƒ¨ç½²æ¶æ„å›¾

```mermaid
graph TB
    subgraph "è´Ÿè½½å‡è¡¡å±‚"
        LB[è´Ÿè½½å‡è¡¡å™¨<br/>Nginx/ALB]
    end
    
    subgraph "å‰ç«¯å±‚"
        Vue1[Vue 3å‰ç«¯1<br/>:3000]
        Vue2[Vue 3å‰ç«¯2<br/>:3000]
    end
    
    subgraph "ç½‘å…³å±‚"
        APISIX1[APISIXç½‘å…³1<br/>:9080]
        APISIX2[APISIXç½‘å…³2<br/>:9080]
    end
    
    subgraph "åç«¯æœåŠ¡å±‚"
        subgraph "è®¤è¯åŸŸ"
            Auth1[è®¤è¯åŸŸæœåŠ¡1<br/>:8001]
            Auth2[è®¤è¯åŸŸæœåŠ¡2<br/>:8001]
        end
        
        subgraph "ç”¨æˆ·åŸŸ"
            User1[ç”¨æˆ·åŸŸæœåŠ¡1<br/>:8002]
            User2[ç”¨æˆ·åŸŸæœåŠ¡2<br/>:8002]
        end
        
        subgraph "æƒé™åŸŸ"
            Permission1[æƒé™åŸŸæœåŠ¡1<br/>:8003]
            Permission2[æƒé™åŸŸæœåŠ¡2<br/>:8003]
        end
        
        subgraph "ç³»ç»ŸåŸŸ"
            System1[ç³»ç»ŸåŸŸæœåŠ¡1<br/>:8004]
            System2[ç³»ç»ŸåŸŸæœåŠ¡2<br/>:8004]
        end
        
        subgraph "æ”¯æ’‘åŸŸ"
            Support1[æ”¯æ’‘åŸŸæœåŠ¡1<br/>:8005]
            Support2[æ”¯æ’‘åŸŸæœåŠ¡2<br/>:8005]
        end
        
        subgraph "ä¸šåŠ¡åŸŸ"
            Business1[ä¸šåŠ¡åŸŸæœåŠ¡1<br/>:8006]
            Business2[ä¸šåŠ¡åŸŸæœåŠ¡2<br/>:8006]
        end
    end
    
    subgraph "æ•°æ®å±‚"
        MySQL[(MySQLä¸»ä»<br/>:3306)]
        PostgreSQL[(PostgreSQL<br/>:5432)]
        Oracle[(Oracle<br/>:1521)]
        Redis[(Redisé›†ç¾¤<br/>:6379)]
        RabbitMQ[RabbitMQé›†ç¾¤<br/>:5672]
    end
    
    subgraph "åŸºç¡€è®¾æ–½å±‚"
        Nacos[Nacosé›†ç¾¤<br/>:8848]
        Prometheus[Prometheus<br/>:9090]
        Grafana[Grafana<br/>:3001]
        Jaeger[Jaeger<br/>:6831]
    end
    
    LB --> Vue1
    LB --> Vue2
    
    Vue1 --> APISIX1
    Vue2 --> APISIX2
    
    APISIX1 --> Auth1
    APISIX1 --> Auth2
    APISIX1 --> User1
    APISIX1 --> User2
    APISIX1 --> Permission1
    APISIX1 --> Permission2
    APISIX1 --> System1
    APISIX1 --> System2
    APISIX1 --> Support1
    APISIX1 --> Support2
    APISIX1 --> Business1
    APISIX1 --> Business2
    
    APISIX2 --> Auth1
    APISIX2 --> Auth2
    APISIX2 --> User1
    APISIX2 --> User2
    APISIX2 --> Permission1
    APISIX2 --> Permission2
    APISIX2 --> System1
    APISIX2 --> System2
    APISIX2 --> Support1
    APISIX2 --> Support2
    APISIX2 --> Business1
    APISIX2 --> Business2
    
    Auth1 --> MySQL
    Auth2 --> MySQL
    User1 --> MySQL
    User2 --> MySQL
    Permission1 --> MySQL
    Permission2 --> MySQL
    System1 --> MySQL
    System2 --> MySQL
    Support1 --> MySQL
    Support2 --> MySQL
    Business1 --> MySQL
    Business2 --> MySQL
    
    System1 --> PostgreSQL
    System2 --> PostgreSQL
    System1 --> Oracle
    System2 --> Oracle
    
    Auth1 --> Redis
    Auth2 --> Redis
    User1 --> Redis
    User2 --> Redis
    Permission1 --> Redis
    Permission2 --> Redis
    System1 --> Redis
    System2 --> Redis
    Support1 --> Redis
    Support2 --> Redis
    Business1 --> Redis
    Business2 --> Redis
    
    System1 --> RabbitMQ
    System2 --> RabbitMQ
    Support1 --> RabbitMQ
    Support2 --> RabbitMQ
    
    Auth1 --> Nacos
    Auth2 --> Nacos
    User1 --> Nacos
    User2 --> Nacos
    Permission1 --> Nacos
    Permission2 --> Nacos
    System1 --> Nacos
    System2 --> Nacos
    Support1 --> Nacos
    Support2 --> Nacos
    Business1 --> Nacos
    Business2 --> Nacos
    
    Auth1 --> Prometheus
    User1 --> Prometheus
    System1 --> Prometheus
    
    Prometheus --> Grafana
    
    Auth1 --> Jaeger
    User1 --> Jaeger
    System1 --> Jaeger
```

### 6.2 éƒ¨ç½²æ–¹æ¡ˆ

#### 6.2.1 å¼€å‘ç¯å¢ƒéƒ¨ç½²

**éƒ¨ç½²æ–¹å¼**ï¼šå•æœºéƒ¨ç½²
**éƒ¨ç½²ç»„ä»¶**ï¼š
- MySQLï¼ˆå•å®ä¾‹ï¼‰
- Redisï¼ˆå•å®ä¾‹ï¼‰
- æ‰€æœ‰å¾®æœåŠ¡ï¼ˆå•å®ä¾‹ï¼‰
- æ— è´Ÿè½½å‡è¡¡ã€æ— é›†ç¾¤

#### 6.2.2 æµ‹è¯•ç¯å¢ƒéƒ¨ç½²

**éƒ¨ç½²æ–¹å¼**ï¼šå®¹å™¨åŒ–éƒ¨ç½²
**éƒ¨ç½²ç»„ä»¶**ï¼š
- MySQLï¼ˆä¸»ä»ï¼‰
- Redisï¼ˆå•å®ä¾‹ï¼‰
- RabbitMQï¼ˆå•å®ä¾‹ï¼‰
- Nacosï¼ˆå•å®ä¾‹ï¼‰
- æ‰€æœ‰å¾®æœåŠ¡ï¼ˆå¤šå®ä¾‹ï¼‰
- APISIXï¼ˆå•å®ä¾‹ï¼‰

#### 6.2.3 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

**éƒ¨ç½²æ–¹å¼**ï¼šKubernetesé›†ç¾¤éƒ¨ç½²
**éƒ¨ç½²ç»„ä»¶**ï¼š
- MySQLï¼ˆä¸»ä» + è¯»å†™åˆ†ç¦»ï¼‰
- Redisï¼ˆé›†ç¾¤ï¼‰
- RabbitMQï¼ˆé›†ç¾¤ï¼‰
- Nacosï¼ˆé›†ç¾¤ï¼‰
- æ‰€æœ‰å¾®æœåŠ¡ï¼ˆå¤šå®ä¾‹ + è‡ªåŠ¨æ‰©ç¼©å®¹ï¼‰
- APISIXï¼ˆå¤šå®ä¾‹ + è´Ÿè½½å‡è¡¡ï¼‰
- Prometheus + Grafanaï¼ˆç›‘æ§ï¼‰
- Jaegerï¼ˆåˆ†å¸ƒå¼è¿½è¸ªï¼‰
- Nginx/ALBï¼ˆè´Ÿè½½å‡è¡¡ï¼‰

### 6.3 å®¹å™¨ç¼–æ’å›¾

```mermaid
graph TB
    subgraph "Kubernetesé›†ç¾¤"
        subgraph "Namespace: mcp-platform"
            subgraph "Deployment: apisix"
                APISIX[APISIX Pod]
            end
            
            subgraph "Deployment: auth-service"
                Auth1[Auth Pod 1]
                Auth2[Auth Pod 2]
            end
            
            subgraph "Deployment: user-service"
                User1[User Pod 1]
                User2[User Pod 2]
            end
            
            subgraph "Deployment: mcp-service"
                MCP1[MCP Pod 1]
                MCP2[MCP Pod 2]
            end
            
            subgraph "Service"
                SvcAuth[auth-service]
                SvcUser[user-service]
                SvcMCP[mcp-service]
            end
            
            subgraph "Ingress"
                Ingress[Ingress Controller]
            end
        end
        
        subgraph "Namespace: monitoring"
            Prometheus[Prometheus]
            Grafana[Grafana]
            Jaeger[Jaeger]
        end
        
        subgraph "Namespace: infrastructure"
            MySQL[(MySQL StatefulSet)]
            Redis[(Redis StatefulSet)]
            RabbitMQ[RabbitMQ StatefulSet]
            Nacos[Nacos StatefulSet]
        end
    end
    
    Ingress --> SvcAuth
    Ingress --> SvcUser
    Ingress --> SvcMCP
    
    SvcAuth --> Auth1
    SvcAuth --> Auth2
    
    SvcUser --> User1
    SvcUser --> User2
    
    SvcMCP --> MCP1
    SvcMCP --> MCP2
    
    Auth1 --> MySQL
    Auth2 --> MySQL
    User1 --> MySQL
    User2 --> MySQL
    MCP1 --> MySQL
    MCP2 --> MySQL
    
    Auth1 --> Redis
    Auth2 --> Redis
    User1 --> Redis
    User2 --> Redis
    MCP1 --> Redis
    MCP2 --> Redis
    
    MCP1 --> RabbitMQ
    MCP2 --> RabbitMQ
    
    Auth1 --> Nacos
    Auth2 --> Nacos
    User1 --> Nacos
    User2 --> Nacos
    MCP1 --> Nacos
    MCP2 --> Nacos
```

---

## 7. æŠ€æœ¯æ¶æ„ä¼˜åŠ¿

### 7.1 å¯æ‰©å±•æ€§

- âœ… **æ°´å¹³æ‰©å±•**ï¼šå¾®æœåŠ¡å¯ä»¥ç‹¬ç«‹æ‰©å±•ï¼Œæ ¹æ®è´Ÿè½½åŠ¨æ€è°ƒæ•´å®ä¾‹æ•°é‡
- âœ… **å‚ç›´æ‰©å±•**ï¼šå¯ä»¥å¢åŠ å•ä¸ªå®ä¾‹çš„èµ„æºï¼ˆCPUã€å†…å­˜ï¼‰
- âœ… **åŠŸèƒ½æ‰©å±•**ï¼šæ–°å¢åŠŸèƒ½åªéœ€æ·»åŠ æ–°çš„å¾®æœåŠ¡ï¼Œä¸å½±å“ç°æœ‰æœåŠ¡

### 7.2 å¯ç»´æŠ¤æ€§

- âœ… **æ¨¡å—åŒ–**ï¼šæ¯ä¸ªå¾®æœåŠ¡èŒè´£å•ä¸€ï¼Œä¾¿äºç†è§£å’Œç»´æŠ¤
- âœ… **ç‹¬ç«‹éƒ¨ç½²**ï¼šå¾®æœåŠ¡å¯ä»¥ç‹¬ç«‹éƒ¨ç½²ã€ç‹¬ç«‹å‡çº§
- âœ… **æ•…éšœéš”ç¦»**ï¼šå•ä¸ªå¾®æœåŠ¡æ•…éšœä¸ä¼šå½±å“æ•´ä¸ªç³»ç»Ÿ

### 7.3 é«˜å¯ç”¨æ€§

- âœ… **é›†ç¾¤éƒ¨ç½²**ï¼šå…³é”®æœåŠ¡éƒ¨ç½²å¤šä¸ªå®ä¾‹ï¼Œé¿å…å•ç‚¹æ•…éšœ
- âœ… **è´Ÿè½½å‡è¡¡**ï¼šé€šè¿‡è´Ÿè½½å‡è¡¡åˆ†å‘è¯·æ±‚ï¼Œæé«˜ç³»ç»Ÿå¯ç”¨æ€§
- âœ… **å¥åº·æ£€æŸ¥**ï¼šå®šæœŸæ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€ï¼Œè‡ªåŠ¨å‰”é™¤ä¸å¥åº·å®ä¾‹

### 7.4 æ€§èƒ½ä¼˜åŒ–

- âœ… **ç¼“å­˜**ï¼šä½¿ç”¨Redisç¼“å­˜çƒ­ç‚¹æ•°æ®ï¼Œå‡å°‘æ•°æ®åº“å‹åŠ›
- âœ… **å¼‚æ­¥å¤„ç†**ï¼šä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¤„ç†å¼‚æ­¥ä»»åŠ¡ï¼Œæé«˜å“åº”é€Ÿåº¦
- âœ… **è¿æ¥æ± **ï¼šä½¿ç”¨æ•°æ®åº“è¿æ¥æ± ï¼Œæé«˜æ•°æ®åº“è®¿é—®æ•ˆç‡

### 7.5 å®‰å…¨æ€§

- âœ… **è®¤è¯æˆæƒ**ï¼šç»Ÿä¸€çš„è®¤è¯æˆæƒæœºåˆ¶ï¼Œç»†ç²’åº¦çš„æƒé™æ§åˆ¶
- âœ… **æ•°æ®åŠ å¯†**ï¼šæ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨ï¼Œä¼ è¾“å±‚ä½¿ç”¨HTTPS
- âœ… **å®¡è®¡æ—¥å¿—**ï¼šå®Œæ•´çš„å®¡è®¡æ—¥å¿—ï¼Œä¾¿äºè¿½è¸ªå’Œå®¡è®¡

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [æ•°æ®åº“è®¾è®¡æ–‡æ¡£](./3-æ•°æ®åº“è®¾è®¡æ–‡æ¡£.md)
- [APIæ¥å£è®¾è®¡æ–‡æ¡£](./4-APIæ¥å£è®¾è®¡æ–‡æ¡£.md)
- [å‰ç«¯æ¶æ„è®¾è®¡æ–‡æ¡£](./5-å‰ç«¯æ¶æ„è®¾è®¡æ–‡æ¡£.md)
- [éƒ¨ç½²æ–‡æ¡£](./8-éƒ¨ç½²æ–‡æ¡£.md)
- [å¤–éƒ¨è½¯ä»¶æœåŠ¡éœ€æ±‚æ¸…å•](./0-å¤–éƒ¨è½¯ä»¶æœåŠ¡éœ€æ±‚æ¸…å•.md)

---

## ğŸ’¡ æ³¨æ„äº‹é¡¹

1. **æœåŠ¡æ‹†åˆ†**ï¼šå¾®æœåŠ¡æ‹†åˆ†è¦åˆç†ï¼Œé¿å…è¿‡åº¦æ‹†åˆ†æˆ–æ‹†åˆ†ä¸è¶³
2. **æœåŠ¡é€šä¿¡**ï¼šå°½é‡ä½¿ç”¨åŒæ­¥è°ƒç”¨ï¼Œå¼‚æ­¥è°ƒç”¨ä»…ç”¨äºéå®æ—¶åœºæ™¯
3. **æ•°æ®ä¸€è‡´æ€§**ï¼šè·¨æœåŠ¡äº‹åŠ¡ä½¿ç”¨æœ€ç»ˆä¸€è‡´æ€§ï¼Œé¿å…åˆ†å¸ƒå¼äº‹åŠ¡
4. **ç›‘æ§å‘Šè­¦**ï¼šå®Œå–„çš„ç›‘æ§å‘Šè­¦ä½“ç³»ï¼ŒåŠæ—¶å‘ç°å’Œå¤„ç†é—®é¢˜
5. **æ–‡æ¡£æ›´æ–°**ï¼šæ¶æ„å˜æ›´æ—¶åŠæ—¶æ›´æ–°æ–‡æ¡£ï¼Œä¿æŒæ–‡æ¡£ä¸ä»£ç åŒæ­¥

---

**æ–‡æ¡£ç‰ˆæœ¬å†å²**ï¼š

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | å˜æ›´è¯´æ˜ |
|-----|------|------|---------|
| v1.0 | 2026-01-13 | AIåŠ©æ‰‹ | åˆå§‹ç‰ˆæœ¬ |

---

**ä¸‹ä¸€æ­¥**ï¼šå¼€å§‹ç”Ÿæˆ[æ•°æ®åº“è®¾è®¡æ–‡æ¡£](./3-æ•°æ®åº“è®¾è®¡æ–‡æ¡£.md)