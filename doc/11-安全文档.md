# å®‰å…¨æ–‡æ¡£

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

- **é¡¹ç›®åç§°**ï¼šä¼ä¸šçº§AIç»¼åˆç®¡ç†å¹³å°
- **æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
- **åˆ›å»ºæ—¥æœŸ**ï¼š2026-01-13
- **æ–‡æ¡£ç±»å‹**ï¼šå®‰å…¨æ–‡æ¡£

---

## 1. å®‰å…¨æ¶æ„è®¾è®¡

### 1.1 å®‰å…¨æ¶æ„å›¾

```mermaid
graph TB
    A[å®¢æˆ·ç«¯] --> B[HTTPSåŠ å¯†]
    B --> C[APIç½‘å…³]
    C --> D[é™æµç†”æ–­]
    D --> E[è®¤è¯æˆæƒ]
    E --> F[æƒé™æ ¡éªŒ]
    F --> G[åº”ç”¨æœåŠ¡]
    G --> H[æ•°æ®åŠ å¯†]
    G --> I[SQLæ³¨å…¥é˜²æŠ¤]
    G --> J[XSSé˜²æŠ¤]
```

### 1.2 å®‰å…¨å±‚æ¬¡

| å±‚æ¬¡ | å®‰å…¨æªæ–½ |
|-----|---------|
| **ä¼ è¾“å±‚** | HTTPS/TLS 1.3 |
| **ç½‘å…³å±‚** | é™æµç†”æ–­ã€IPç™½åå• |
| **è®¤è¯å±‚** | JWT + API KeyåŒè®¤è¯ |
| **æˆæƒå±‚** | RBAC + ABACæƒé™æ¨¡å‹ |
| **åº”ç”¨å±‚** | å‚æ•°éªŒè¯ã€æ•°æ®åŠ å¯† |
| **æ•°æ®å±‚** | æ•æ„Ÿæ•°æ®åŠ å¯†ã€SQLæ³¨å…¥é˜²æŠ¤ |

---

## 2. è®¤è¯æˆæƒæœºåˆ¶

### 2.1 JWTè®¤è¯

```python
# auth/jwt_handler.py
from datetime import datetime, timedelta
from jose import JWTError, jwt
from passlib.context import CryptContext

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

SECRET_KEY = "your-secret-key-here"
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 1440

def create_access_token(data: dict):
    """åˆ›å»ºè®¿é—®ä»¤ç‰Œ"""
    to_encode = data.copy()
    expire = datetime.utcnow() + timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)
    to_encode.update({"exp": expire})
    encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)
    return encoded_jwt

def verify_token(token: str):
    """éªŒè¯ä»¤ç‰Œ"""
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        return payload
    except JWTError:
        return None

def get_password_hash(password: str):
    """è·å–å¯†ç å“ˆå¸Œ"""
    return pwd_context.hash(password)

def verify_password(plain_password: str, hashed_password: str):
    """éªŒè¯å¯†ç """
    return pwd_context.verify(plain_password, hashed_password)
```

### 2.2 API Keyè®¤è¯

```python
# auth/api_key_handler.py
import secrets
from typing import Optional
from sqlalchemy.orm import Session
from app.models.api_key import ApiKey

def generate_api_key(prefix: str = "agent") -> str:
    """ç”ŸæˆAPI Key"""
    random_part = secrets.token_urlsafe(32)
    return f"{prefix}_{random_part}"

def verify_api_key(api_key: str, db: Session) -> Optional[dict]:
    """éªŒè¯API Key"""
    key_obj = db.query(ApiKey).filter(
        ApiKey.key == api_key,
        ApiKey.is_active == True
    ).first()
    
    if not key_obj:
        return None
    
    if key_obj.is_expired():
        return None
    
    return {
        "id": key_obj.id,
        "user_id": key_obj.user_id,
        "scopes": key_obj.scopes
    }
```

---

## 3. æ•°æ®åŠ å¯†æ–¹æ¡ˆ

### 3.1 æ•æ„Ÿæ•°æ®åŠ å¯†

```python
# utils/crypto.py
from cryptography.fernet import Fernet
from cryptography.hazmat.primitives import hashes
from cryptography.hazmat.primitives.kdf.pbkdf2 import PBKDF2HMAC
import base64

# åŠ å¯†å¯†é’¥
ENCRYPTION_KEY = b'your-encryption-key-here-32-bytes-long'

# åˆ›å»ºåŠ å¯†å™¨
cipher_suite = Fernet(ENCRYPTION_KEY)

def encrypt_data(data: str) -> str:
    """åŠ å¯†æ•°æ®"""
    encrypted = cipher_suite.encrypt(data.encode())
    return base64.urlsafe_b64encode(encrypted).decode()

def decrypt_data(encrypted_data: str) -> str:
    """è§£å¯†æ•°æ®"""
    encrypted = base64.urlsafe_b64decode(encrypted_data.encode())
    decrypted = cipher_suite.decrypt(encrypted)
    return decrypted.decode()

# å¯†ç åŠ å¯†
def hash_password(password: str) -> str:
    """å¯†ç å“ˆå¸Œ"""
    import bcrypt
    return bcrypt.hashpw(password.encode(), bcrypt.gensalt()).decode()

def verify_password(plain: str, hashed: str) -> bool:
    """éªŒè¯å¯†ç """
    import bcrypt
    return bcrypt.checkpw(plain.encode(), hashed.encode())
```

### 3.2 ä¼ è¾“åŠ å¯†

```python
# é…ç½®HTTPS
from fastapi import FastAPI
from fastapi.middleware.httpsredirect import HTTPSRedirectMiddleware

app = FastAPI()

# å¼ºåˆ¶HTTPS
app.add_middleware(HTTPSRedirectMiddleware)

# é…ç½®SSL/TLS
# åœ¨ç”Ÿäº§ç¯å¢ƒé…ç½®æœ‰æ•ˆçš„SSLè¯ä¹¦
```

---

## 4. SQLæ³¨å…¥é˜²æŠ¤

### 4.1 å‚æ•°åŒ–æŸ¥è¯¢

```python
# é”™è¯¯ç¤ºä¾‹ï¼ˆæ˜“å—SQLæ³¨å…¥ï¼‰
def get_user_by_username(username: str):
    query = f"SELECT * FROM users WHERE username = '{username}'"
    # å¦‚æœusernameåŒ…å«æ¶æ„SQLä»£ç ï¼Œä¼šå¯¼è‡´SQLæ³¨å…¥

# æ­£ç¡®ç¤ºä¾‹ï¼ˆå‚æ•°åŒ–æŸ¥è¯¢ï¼‰
def get_user_by_username(username: str):
    from sqlalchemy import text
    query = text("SELECT * FROM users WHERE username = :username")
    result = db.execute(query, {"username": username})
    return result.fetchall()

# ä½¿ç”¨ORM
def get_user_by_username(username: str):
    user = db.query(User).filter(User.username == username).first()
    return user
```

### 4.2 è¾“å…¥éªŒè¯

```python
from pydantic import validator, BaseModel

class UserCreateRequest(BaseModel):
    username: str
    email: str
    password: str
    
    @validator('username')
    def validate_username(cls, v):
        if not v.isalnum():
            raise ValueError('ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯å’Œæ•°å­—')
        if len(v) < 3 or len(v) > 50:
            raise ValueError('ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-50ä¹‹é—´')
        return v
    
    @validator('email')
    def validate_email(cls, v):
        import re
        email_regex = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
        if not re.match(email_regex, v):
            raise ValueError('é‚®ç®±æ ¼å¼ä¸æ­£ç¡®')
        return v
    
    @validator('password')
    def validate_password(cls, v):
        if len(v) < 8:
            raise ValueError('å¯†ç é•¿åº¦ä¸èƒ½å°‘äº8ä½')
        if not any(c.isupper() for c in v):
            raise ValueError('å¯†ç å¿…é¡»åŒ…å«å¤§å†™å­—æ¯')
        if not any(c.islower() for c in v):
            raise ValueError('å¯†ç å¿…é¡»åŒ…å«å°å†™å­—æ¯')
        if not any(c.isdigit() for c in v):
            raise ValueError('å¯†ç å¿…é¡»åŒ…å«æ•°å­—')
        return v
```

---

## 5. XSSé˜²æŠ¤

### 5.1 è¾“å‡ºç¼–ç 

```python
from html import escape

def render_user_comment(comment: str) -> str:
    """æ¸²æŸ“ç”¨æˆ·è¯„è®ºï¼Œé˜²æ­¢XSSæ”»å‡»"""
    # è½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦
    safe_comment = escape(comment)
    return safe_comment
```

### 5.2 CSPç­–ç•¥

```python
# é…ç½®Content Security Policy
from fastapi.middleware.cors import CORSMiddleware
from fastapi.middleware.trustedhost import TrustedHostMiddleware

app = FastAPI()

# CSPå¤´
@app.middleware("http")
async def add_security_headers(request, call_next):
    response = await call_next(request)
    response.headers["X-Content-Type-Options"] = "nosniff"
    response.headers["X-Frame-Options"] = "DENY"
    response.headers["X-XSS-Protection"] = "1; mode=block"
    response.headers["Content-Security-Policy"] = "default-src 'self'"
    return response
```

---

## 6. CSRFé˜²æŠ¤

### 6.1 CSRF Token

```python
from fastapi import Depends, HTTPException, Request
from starlette.middleware.base import BaseHTTPMiddleware
import secrets

class CSRFMiddleware(BaseHTTPMiddleware):
    async def dispatch(self, request, request.call_next):
        if request.method in ["POST", "PUT", "DELETE", "PATCH"]:
            csrf_token = request.cookies.get("csrf_token")
            if not csrf_token:
                raise HTTPException(status_code=403, detail="CSRF token missing")
            
            # éªŒè¯CSRF token
            if not secrets.compare_digest(
                csrf_token,
                request.headers.get("X-CSRF-Token", "")
            ):
                raise HTTPException(status_code=403, detail="Invalid CSRF token")
        
        response = await request.call_next(request)
        return response

app.add_middleware(CSRFMiddleware)
```

---

## 7. APIå®‰å…¨è§„èŒƒ

### 7.1 é™æµé˜²æŠ¤

```python
from slowapi import Limiter, _rate_for
from fastapi import Request, HTTPException
from fastapi.responses import JSONResponse

limiter = Limiter(key_func=_rate_for)

@app.get("/api/v1/users")
@limiter.limit("100/minute")
async def get_users(request: Request):
    """è·å–ç”¨æˆ·åˆ—è¡¨ï¼Œé™æµï¼šæ¯åˆ†é’Ÿ100æ¬¡"""
    users = user_service.get_users()
    return JSONResponse(content=users)
```

### 7.2 è¯·æ±‚å¤§å°é™åˆ¶

```python
from fastapi import FastAPI, HTTPException

app = FastAPI()

@app.middleware("http")
async def limit_request_size(request: Request, call_next):
    content_length = request.headers.get("content-length")
    if content_length and int(content_length) > 10 * 1024 * 1024:  # 10MB
        raise HTTPException(status_code=413, detail="è¯·æ±‚ä½“è¿‡å¤§")
    return await call_next(request)
```

---

## 8. å®‰å…¨å®¡è®¡æ—¥å¿—

### 8.1 å®¡è®¡æ—¥å¿—è®°å½•

```python
# utils/audit_logger.py
from loguru import logger
from datetime import datetime

class AuditLogger:
    @staticmethod
    def log_operation(
        user_id: str,
        tenant_id: str,
        operation: str,
        resource: str,
        result: str,
        details: dict = None
    ):
        """è®°å½•æ“ä½œæ—¥å¿—"""
        log_data = {
            "timestamp": datetime.now().isoformat(),
            "user_id": user_id,
            "tenant_id": tenant_id,
            "operation": operation,
            "resource": resource,
            "result": result,
            "details": details or {}
        }
        logger.info(f"AUDIT: {log_data}")
        
        # ä¿å­˜åˆ°æ•°æ®åº“
        # audit_log_service.create(log_data)
```

---

## 9. å®‰å…¨å®¡è®¡æµç¨‹

### 9.1 å®‰å…¨å®¡è®¡æ¦‚è¿°

**å®‰å…¨å®¡è®¡ç›®æ ‡**ï¼š
- å‘ç°ç³»ç»Ÿå®‰å…¨æ¼æ´
- è¯„ä¼°å®‰å…¨é£é™©ç­‰çº§
- æä¾›å®‰å…¨æ”¹è¿›å»ºè®®
- ç¡®ä¿åˆè§„æ€§è¦æ±‚

**å®‰å…¨å®¡è®¡åŸåˆ™**ï¼š
- âœ… å®šæœŸå®¡è®¡ï¼ˆæ¯å­£åº¦è‡³å°‘ä¸€æ¬¡ï¼‰
- âœ… å…¨é¢è¦†ç›–ï¼ˆç½‘ç»œã€åº”ç”¨ã€æ•°æ®ã€äººå‘˜ï¼‰
- âœ… ç‹¬ç«‹å®¡è®¡ï¼ˆç”±ç¬¬ä¸‰æ–¹æˆ–å®‰å…¨å›¢é˜Ÿæ‰§è¡Œï¼‰
- âœ… æŒç»­æ”¹è¿›ï¼ˆæ ¹æ®å®¡è®¡ç»“æœä¸æ–­ä¼˜åŒ–ï¼‰

### 9.2 å®‰å…¨å®¡è®¡æµç¨‹

```mermaid
graph TD
    A[åˆ¶å®šå®¡è®¡è®¡åˆ’] --> B[æ”¶é›†å®¡è®¡ä¿¡æ¯]
    B --> C[æ‰§è¡Œå®‰å…¨æ‰«æ]
    C --> D[åˆ†æå®¡è®¡ç»“æœ]
    D --> E[è¯„ä¼°å®‰å…¨é£é™©]
    E --> F[ç”Ÿæˆå®¡è®¡æŠ¥å‘Š]
    F --> G[åˆ¶å®šæ”¹è¿›è®¡åˆ’]
    G --> H[å®æ–½å®‰å…¨æ”¹è¿›]
    H --> I[éªŒè¯æ”¹è¿›æ•ˆæœ]
    I --> A
```

### 9.3 å®‰å…¨å®¡è®¡å†…å®¹

#### 9.3.1 èº«ä»½è®¤è¯å®¡è®¡

**å®¡è®¡å†…å®¹**ï¼š
- âœ… å¯†ç ç­–ç•¥ï¼ˆé•¿åº¦ã€å¤æ‚åº¦ã€è¿‡æœŸæ—¶é—´ï¼‰
- âœ… å¤šå› ç´ è®¤è¯ï¼ˆMFAï¼‰é…ç½®
- âœ… ä¼šè¯ç®¡ç†ï¼ˆè¶…æ—¶æ—¶é—´ã€å¹¶å‘ä¼šè¯ï¼‰
- âœ… å¯†ç é‡ç½®æµç¨‹
- âœ… è´¦æˆ·é”å®šç­–ç•¥

**å®¡è®¡æ£€æŸ¥æ¸…å•**ï¼š
```python
# å®¡è®¡è„šæœ¬ç¤ºä¾‹
def audit_authentication():
    """èº«ä»½è®¤è¯å®¡è®¡"""
    issues = []
    
    # æ£€æŸ¥å¯†ç ç­–ç•¥
    password_policy = get_password_policy()
    if password_policy['min_length'] < 8:
        issues.append("å¯†ç æœ€å°é•¿åº¦ä¸è¶³8ä½")
    if not password_policy['require_uppercase']:
        issues.append("å¯†ç æœªè¦æ±‚åŒ…å«å¤§å†™å­—æ¯")
    if not password_policy['require_lowercase']:
        issues.append("å¯†ç æœªè¦æ±‚åŒ…å«å°å†™å­—æ¯")
    if not password_policy['require_digit']:
        issues.append("å¯†ç æœªè¦æ±‚åŒ…å«æ•°å­—")
    if not password_policy['require_special_char']:
        issues.append("å¯†ç æœªè¦æ±‚åŒ…å«ç‰¹æ®Šå­—ç¬¦")
    
    # æ£€æŸ¥MFAé…ç½®
    mfa_enabled = check_mfa_enabled()
    if not mfa_enabled:
        issues.append("æœªå¯ç”¨å¤šå› ç´ è®¤è¯")
    
    # æ£€æŸ¥ä¼šè¯ç®¡ç†
    session_timeout = get_session_timeout()
    if session_timeout > 3600:  # è¶…è¿‡1å°æ—¶
        issues.append(f"ä¼šè¯è¶…æ—¶æ—¶é—´è¿‡é•¿ï¼ˆ{session_timeout}ç§’ï¼‰")
    
    # æ£€æŸ¥è´¦æˆ·é”å®šç­–ç•¥
    lockout_policy = get_lockout_policy()
    if lockout_policy['max_attempts'] > 5:
        issues.append(f"æœ€å¤§å°è¯•æ¬¡æ•°è¿‡å¤šï¼ˆ{lockout_policy['max_attempts']}æ¬¡ï¼‰")
    
    return issues
```

#### 9.3.2 æƒé™ç®¡ç†å®¡è®¡

**å®¡è®¡å†…å®¹**ï¼š
- âœ… è§’è‰²æƒé™é…ç½®
- âœ… ç”¨æˆ·æƒé™åˆ†é…
- âœ… æƒé™æœ€å°åŒ–åŸåˆ™
- âœ… æƒé™å˜æ›´è®°å½•
- âœ… è¶…çº§ç”¨æˆ·ç®¡ç†

**å®¡è®¡æ£€æŸ¥æ¸…å•**ï¼š
```python
def audit_permissions():
    """æƒé™ç®¡ç†å®¡è®¡"""
    issues = []
    
    # æ£€æŸ¥è§’è‰²æƒé™
    roles = get_all_roles()
    for role in roles:
        if role['is_superuser']:
            issues.append(f"è§’è‰² {role['name']} æ‹¥æœ‰è¶…çº§ç”¨æˆ·æƒé™")
        
        # æ£€æŸ¥æƒé™æ•°é‡
        permission_count = len(role['permissions'])
        if permission_count > 50:
            issues.append(f"è§’è‰² {role['name']} æƒé™è¿‡å¤šï¼ˆ{permission_count}ä¸ªï¼‰")
    
    # æ£€æŸ¥ç”¨æˆ·æƒé™
    users = get_all_users()
    for user in users:
        # æ£€æŸ¥ç”¨æˆ·è§’è‰²æ•°é‡
        role_count = len(user['roles'])
        if role_count > 3:
            issues.append(f"ç”¨æˆ· {user['username']} è§’è‰²è¿‡å¤šï¼ˆ{role_count}ä¸ªï¼‰")
        
        # æ£€æŸ¥ç›´æ¥æƒé™
        direct_permissions = user.get('direct_permissions', [])
        if direct_permissions:
            issues.append(f"ç”¨æˆ· {user['username']} æ‹¥æœ‰ç›´æ¥æƒé™")
    
    # æ£€æŸ¥æƒé™å˜æ›´è®°å½•
    recent_changes = get_recent_permission_changes(days=7)
    if len(recent_changes) > 100:
        issues.append(f"è¿‘æœŸæƒé™å˜æ›´è¿‡å¤šï¼ˆ{len(recent_changes)}æ¬¡ï¼‰")
    
    return issues
```

#### 9.3.3 æ•°æ®è®¿é—®å®¡è®¡

**å®¡è®¡å†…å®¹**ï¼š
- âœ… æ•°æ®è®¿é—®æƒé™
- âœ… æ•æ„Ÿæ•°æ®åŠ å¯†
- âœ… æ•°æ®å¤‡ä»½ç­–ç•¥
- âœ… æ•°æ®ä¼ è¾“åŠ å¯†
- âœ… æ•°æ®è®¿é—®æ—¥å¿—

**å®¡è®¡æ£€æŸ¥æ¸…å•**ï¼š
```python
def audit_data_access():
    """æ•°æ®è®¿é—®å®¡è®¡"""
    issues = []
    
    # æ£€æŸ¥æ•æ„Ÿæ•°æ®åŠ å¯†
    encrypted_fields = [
        'password',
        'email',
        'phone',
        'id_card',
        'bank_account'
    ]
    
    for field in encrypted_fields:
        is_encrypted = check_field_encryption(field)
        if not is_encrypted:
            issues.append(f"å­—æ®µ {field} æœªåŠ å¯†")
    
    # æ£€æŸ¥æ•°æ®ä¼ è¾“åŠ å¯†
    https_enabled = check_https_enabled()
    if not https_enabled:
        issues.append("æœªå¯ç”¨HTTPS")
    
    # æ£€æŸ¥æ•°æ®å¤‡ä»½
    backup_config = get_backup_config()
    if not backup_config['enabled']:
        issues.append("æœªå¯ç”¨æ•°æ®å¤‡ä»½")
    elif backup_config['frequency'] > 24:  # è¶…è¿‡24å°æ—¶
        issues.append(f"å¤‡ä»½é¢‘ç‡è¿‡ä½ï¼ˆ{backup_config['frequency']}å°æ—¶ï¼‰")
    
    # æ£€æŸ¥æ•°æ®è®¿é—®æ—¥å¿—
    audit_logging_enabled = check_audit_logging_enabled()
    if not audit_logging_enabled:
        issues.append("æœªå¯ç”¨æ•°æ®è®¿é—®æ—¥å¿—")
    
    return issues
```

#### 9.3.4 æ“ä½œæ—¥å¿—å®¡è®¡

**å®¡è®¡å†…å®¹**ï¼š
- âœ… ç™»å½•æ—¥å¿—
- âœ… æ“ä½œæ—¥å¿—
- âœ… é”™è¯¯æ—¥å¿—
- âœ… å®¡è®¡æ—¥å¿—
- âœ… æ—¥å¿—ä¿ç•™ç­–ç•¥

**å®¡è®¡æ£€æŸ¥æ¸…å•**ï¼š
```python
def audit_logs():
    """æ“ä½œæ—¥å¿—å®¡è®¡"""
    issues = []
    
    # æ£€æŸ¥ç™»å½•æ—¥å¿—
    login_logs = get_recent_login_logs(days=7)
    failed_logins = [log for log in login_logs if log['status'] == 'failed']
    if len(failed_logins) > 100:
        issues.append(f"è¿‘æœŸç™»å½•å¤±è´¥æ¬¡æ•°è¿‡å¤šï¼ˆ{len(failed_logins)}æ¬¡ï¼‰")
    
    # æ£€æŸ¥æ“ä½œæ—¥å¿—
    operation_logs = get_recent_operation_logs(days=7)
    critical_operations = [log for log in operation_logs if log['level'] == 'critical']
    if len(critical_operations) > 50:
        issues.append(f"è¿‘æœŸå…³é”®æ“ä½œè¿‡å¤šï¼ˆ{len(critical_operations)}æ¬¡ï¼‰")
    
    # æ£€æŸ¥é”™è¯¯æ—¥å¿—
    error_logs = get_recent_error_logs(days=7)
    if len(error_logs) > 1000:
        issues.append(f"è¿‘æœŸé”™è¯¯æ—¥å¿—è¿‡å¤šï¼ˆ{len(error_logs)}æ¡ï¼‰")
    
    # æ£€æŸ¥æ—¥å¿—ä¿ç•™ç­–ç•¥
    log_retention = get_log_retention_policy()
    if log_retention['days'] < 90:
        issues.append(f"æ—¥å¿—ä¿ç•™æ—¶é—´è¿‡çŸ­ï¼ˆ{log_retention['days']}å¤©ï¼‰")
    
    return issues
```

### 9.4 å®‰å…¨å®¡è®¡å·¥å…·

#### 9.4.1 OWASP ZAPï¼ˆWebåº”ç”¨å®‰å…¨æ‰«æï¼‰

**å®‰è£…OWASP ZAP**ï¼š
```bash
# ä¸‹è½½ZAP
wget https://github.com/zaproxy/zaproxy/releases/download/v2.13.0/ZAP_2.13.0_Linux.tar.gz

# è§£å‹
tar -xzf ZAP_2.13.0_Linux.tar.gz

# å¯åŠ¨ZAP
./ZAP_2.13.0/zap.sh
```

**è‡ªåŠ¨åŒ–æ‰«æè„šæœ¬**ï¼š
```python
# security/owasp_zap_scan.py
from zapv2 import ZAPv2
import time

def zap_scan(target_url: str):
    """ä½¿ç”¨ZAPè¿›è¡Œå®‰å…¨æ‰«æ"""
    zap = ZAPv2(proxies={'http': 'http://127.0.0.1:8080', 'https': 'http://127.0.0.1:8080'})
    
    # è®¿é—®ç›®æ ‡URL
    zap.urlopen(target_url)
    
    # çˆ¬å–ç½‘ç«™
    print("å¼€å§‹çˆ¬å–ç½‘ç«™...")
    zap.spider.scan(target_url)
    time.sleep(60)
    
    # ä¸»åŠ¨æ‰«æ
    print("å¼€å§‹ä¸»åŠ¨æ‰«æ...")
    zap.ascan.scan(target_url)
    time.sleep(300)
    
    # ç”ŸæˆæŠ¥å‘Š
    print("ç”ŸæˆæŠ¥å‘Š...")
    alerts = zap.core.alerts()
    
    # åˆ†æç»“æœ
    high_risk = [alert for alert in alerts if alert['risk'] == 'High']
    medium_risk = [alert for alert in alerts if alert['risk'] == 'Medium']
    low_risk = [alert for alert in alerts if alert['risk'] == 'Low']
    
    return {
        'high_risk': high_risk,
        'medium_risk': medium_risk,
        'low_risk': low_risk
    }

# ä½¿ç”¨ç¤ºä¾‹
results = zap_scan('https://example.com')
print(f"é«˜é£é™©æ¼æ´: {len(results['high_risk'])}")
print(f"ä¸­é£é™©æ¼æ´: {len(results['medium_risk'])}")
print(f"ä½é£é™©æ¼æ´: {len(results['low_risk'])}")
```

#### 9.4.2 Nessusï¼ˆæ¼æ´æ‰«æï¼‰

**Nessusæ‰«æé…ç½®**ï¼š
```python
# security/nessus_scan.py
import requests

def nessus_scan(target: str):
    """ä½¿ç”¨Nessusè¿›è¡Œæ¼æ´æ‰«æ"""
    # Nessus APIé…ç½®
    nessus_url = 'https://nessus.example.com:8834'
    access_key = 'your-access-key'
    secret_key = 'your-secret-key'
    
    # åˆ›å»ºæ‰«æ
    scan_data = {
        'uuid': 'scan-template-uuid',
        'settings': {
            'name': f'Security Scan - {target}',
            'text_targets': target,
            'launch_now': True
        }
    }
    
    # æäº¤æ‰«æ
    response = requests.post(
        f'{nessus_url}/scans',
        json=scan_data,
        auth=(access_key, secret_key)
    )
    
    scan_id = response.json()['scan']['id']
    
    # ç­‰å¾…æ‰«æå®Œæˆ
    while True:
        response = requests.get(
            f'{nessus_url}/scans/{scan_id}',
            auth=(access_key, secret_key)
        )
        status = response.json()['info']['status']
        
        if status == 'completed':
            break
        
        time.sleep(60)
    
    # è·å–æ‰«æç»“æœ
    response = requests.get(
        f'{nessus_url}/scans/{scan_id}/results',
        auth=(access_key, secret_key)
    )
    
    vulnerabilities = response.json()['vulnerabilities']
    
    # åˆ†æç»“æœ
    critical = [v for v in vulnerabilities if v['severity'] == 4]
    high = [v for v in vulnerabilities if v['severity'] == 3]
    medium = [v for v in vulnerabilities if v['severity'] == 2]
    low = [v for v in vulnerabilities if v['severity'] == 1]
    
    return {
        'critical': critical,
        'high': high,
        'medium': medium,
        'low': low
    }
```

#### 9.4.3 SonarQubeï¼ˆä»£ç å®‰å…¨å®¡è®¡ï¼‰

**SonarQubeæ‰«æé…ç½®**ï¼š
```yaml
# sonar-project.properties
sonar.projectKey=mcp-platform
sonar.projectName=ä¼ä¸šçº§AIç»¼åˆç®¡ç†å¹³å°
sonar.projectVersion=1.0

# æºä»£ç è·¯å¾„
sonar.sources=app
sonar.tests=tests

# Pythoné…ç½®
sonar.python.coverage.reportPaths=coverage.xml
sonar.python.xunit.reportPath=test-results.xml

# å®‰å…¨è§„åˆ™
sonar.security.hotspots.enabled=true
sonar.security.hotspots.rule.sqadmin_A1=true
sonar.security.hotspots.rule.sqadmin_A2=true
sonar.security.hotspots.rule.sqadmin_A3=true

# è´¨é‡é—¨ç¦
sonar.qualitygate.wait=true
```

**è‡ªåŠ¨åŒ–æ‰«æè„šæœ¬**ï¼š
```bash
#!/bin/bash

# sonar_scan.sh

# è¿è¡Œæµ‹è¯•
pytest tests/ --cov=app --cov-report=xml --cov-report=term

# è¿è¡ŒSonarQubeæ‰«æ
sonar-scanner \
  -Dsonar.host.url=http://sonar.example.com:9000 \
  -Dsonar.login=$SONAR_TOKEN

# æ£€æŸ¥è´¨é‡é—¨ç¦
sonar-qualitygate-check
```

### 9.5 å®‰å…¨å®¡è®¡æŠ¥å‘Š

#### 9.5.1 å®¡è®¡æŠ¥å‘Šæ¨¡æ¿

**æŠ¥å‘Šç»“æ„**ï¼š
```markdown
# å®‰å…¨å®¡è®¡æŠ¥å‘Š

## 1. å®¡è®¡æ¦‚è¿°

- **å®¡è®¡æ—¶é—´**ï¼š2024-01-15
- **å®¡è®¡äººå‘˜**ï¼šå®‰å…¨å›¢é˜Ÿ
- **å®¡è®¡èŒƒå›´**ï¼šç½‘ç»œã€åº”ç”¨ã€æ•°æ®ã€äººå‘˜
- **å®¡è®¡æ–¹æ³•**ï¼šè‡ªåŠ¨åŒ–æ‰«æ + äººå·¥å®¡æŸ¥

## 2. å®¡è®¡å‘ç°

### 2.1 é«˜é£é™©é—®é¢˜

| é—®é¢˜ | æè¿° | å½±å“ | å»ºè®® |
|-----|------|------|------|
| å¯†ç ç­–ç•¥ä¸è¶³ | å¯†ç æœ€å°é•¿åº¦ä»…ä¸º6ä½ | å®¹æ˜“è¢«æš´åŠ›ç ´è§£ | æé«˜åˆ°8ä½ä»¥ä¸Š |

### 2.2 ä¸­é£é™©é—®é¢˜

| é—®é¢˜ | æè¿° | å½±å“ | å»ºè®® |
|-----|------|------|------|
| æœªå¯ç”¨MFA | ç¼ºå°‘å¤šå› ç´ è®¤è¯ | è´¦æˆ·å®¹æ˜“è¢«ç›—ç”¨ | å¯ç”¨MFA |

### 2.3 ä½é£é™©é—®é¢˜

| é—®é¢˜ | æè¿° | å½±å“ | å»ºè®® |
|-----|------|------|------|
| æ—¥å¿—ä¿ç•™æ—¶é—´çŸ­ | æ—¥å¿—ä»…ä¿ç•™30å¤© | æ— æ³•è¿½æº¯å†å²é—®é¢˜ | å»¶é•¿åˆ°90å¤© |

## 3. é£é™©è¯„ä¼°

| é£é™©ç­‰çº§ | æ•°é‡ | å æ¯” |
|---------|------|------|
| é«˜é£é™© | 3 | 10% |
| ä¸­é£é™© | 10 | 33% |
| ä½é£é™© | 17 | 57% |

## 4. æ”¹è¿›å»ºè®®

### 4.1 é«˜ä¼˜å…ˆçº§ï¼ˆ1-2å‘¨å†…å®Œæˆï¼‰
1. æé«˜å¯†ç ç­–ç•¥è¦æ±‚
2. å¯ç”¨å¤šå› ç´ è®¤è¯
3. ä¿®å¤SQLæ³¨å…¥æ¼æ´

### 4.2 ä¸­ä¼˜å…ˆçº§ï¼ˆ1ä¸ªæœˆå†…å®Œæˆï¼‰
1. å®šæœŸæ›´æ–°ä¾èµ–åº“
2. åŠ å¼ºæ—¥å¿—å®¡è®¡
3. å®æ–½æ¸—é€æµ‹è¯•

### 4.3 ä½ä¼˜å…ˆçº§ï¼ˆ3ä¸ªæœˆå†…å®Œæˆï¼‰
1. å»¶é•¿æ—¥å¿—ä¿ç•™æ—¶é—´
2. ä¼˜åŒ–æƒé™ç®¡ç†
3. åŠ å¼ºå®‰å…¨åŸ¹è®­

## 5. å®¡è®¡ç»“è®º

æœ¬æ¬¡å®¡è®¡å…±å‘ç°30ä¸ªå®‰å…¨é—®é¢˜ï¼Œå…¶ä¸­é«˜é£é™©3ä¸ªï¼Œä¸­é£é™©10ä¸ªï¼Œä½é£é™©17ä¸ªã€‚å»ºè®®ä¼˜å…ˆä¿®å¤é«˜é£é™©å’Œä¸­é£é™©é—®é¢˜ï¼Œç¡®ä¿ç³»ç»Ÿå®‰å…¨ã€‚

## 6. é™„å½•

- å®¡è®¡å·¥å…·ï¼šOWASP ZAPã€Nessusã€SonarQube
- å®¡è®¡æ—¶é—´ï¼š2024-01-15
- å®¡è®¡äººå‘˜ï¼šå®‰å…¨å›¢é˜Ÿ
```

#### 9.5.2 å®¡è®¡æŠ¥å‘Šç”Ÿæˆ

**è‡ªåŠ¨ç”ŸæˆæŠ¥å‘Š**ï¼š
```python
# security/generate_audit_report.py
from datetime import datetime
import markdown

def generate_audit_report(audit_results: dict):
    """ç”Ÿæˆå®‰å…¨å®¡è®¡æŠ¥å‘Š"""
    report = f"""# å®‰å…¨å®¡è®¡æŠ¥å‘Š

## 1. å®¡è®¡æ¦‚è¿°

- **å®¡è®¡æ—¶é—´**ï¼š{datetime.now().strftime('%Y-%m-%d')}
- **å®¡è®¡äººå‘˜**ï¼šå®‰å…¨å›¢é˜Ÿ
- **å®¡è®¡èŒƒå›´**ï¼šç½‘ç»œã€åº”ç”¨ã€æ•°æ®ã€äººå‘˜

## 2. å®¡è®¡å‘ç°

### 2.1 é«˜é£é™©é—®é¢˜

| é—®é¢˜ | æè¿° | å½±å“ | å»ºè®® |
|-----|------|------|------|
"""
    
    # æ·»åŠ é«˜é£é™©é—®é¢˜
    for issue in audit_results['high_risk']:
        report += f"| {issue['name']} | {issue['description']} | {issue['impact']} | {issue['recommendation']} |\n"
    
    report += "\n### 2.2 ä¸­é£é™©é—®é¢˜\n\n"
    report += "| é—®é¢˜ | æè¿° | å½±å“ | å»ºè®® |\n"
    report += "|-----|------|------|------|\n"
    
    # æ·»åŠ ä¸­é£é™©é—®é¢˜
    for issue in audit_results['medium_risk']:
        report += f"| {issue['name']} | {issue['description']} | {issue['impact']} | {issue['recommendation']} |\n"
    
    report += "\n### 2.3 ä½é£é™©é—®é¢˜\n\n"
    report += "| é—®é¢˜ | æè¿° | å½±å“ | å»ºè®® |\n"
    report += "|-----|------|------|------|\n"
    
    # æ·»åŠ ä½é£é™©é—®é¢˜
    for issue in audit_results['low_risk']:
        report += f"| {issue['name']} | {issue['description']} | {issue['impact']} | {issue['recommendation']} |\n"
    
    # è½¬æ¢ä¸ºHTML
    html_report = markdown.markdown(report)
    
    return report

# ä½¿ç”¨ç¤ºä¾‹
audit_results = {
    'high_risk': [
        {
            'name': 'å¯†ç ç­–ç•¥ä¸è¶³',
            'description': 'å¯†ç æœ€å°é•¿åº¦ä»…ä¸º6ä½',
            'impact': 'å®¹æ˜“è¢«æš´åŠ›ç ´è§£',
            'recommendation': 'æé«˜åˆ°8ä½ä»¥ä¸Š'
        }
    ],
    'medium_risk': [],
    'low_risk': []
}

report = generate_audit_report(audit_results)
print(report)
```

### 9.6 å®‰å…¨å®¡è®¡æœ€ä½³å®è·µ

**å®¡è®¡æ‰§è¡Œæœ€ä½³å®è·µ**ï¼š
- âœ… å®šæœŸå®¡è®¡ï¼ˆæ¯å­£åº¦è‡³å°‘ä¸€æ¬¡ï¼‰
- âœ… å…¨é¢è¦†ç›–ï¼ˆç½‘ç»œã€åº”ç”¨ã€æ•°æ®ã€äººå‘˜ï¼‰
- âœ… ç‹¬ç«‹å®¡è®¡ï¼ˆç”±ç¬¬ä¸‰æ–¹æˆ–å®‰å…¨å›¢é˜Ÿæ‰§è¡Œï¼‰
- âœ… æŒç»­æ”¹è¿›ï¼ˆæ ¹æ®å®¡è®¡ç»“æœä¸æ–­ä¼˜åŒ–ï¼‰

**å®¡è®¡å·¥å…·ä½¿ç”¨æœ€ä½³å®è·µ**ï¼š
- âœ… ä½¿ç”¨å¤šç§å·¥å…·äº¤å‰éªŒè¯
- âœ… å®šæœŸæ›´æ–°å·¥å…·ç‰ˆæœ¬
- âœ… é…ç½®åˆç†çš„æ‰«æè§„åˆ™
- âœ… åˆ†ææ‰«æç»“æœï¼Œé¿å…è¯¯æŠ¥

**å®¡è®¡æŠ¥å‘Šç®¡ç†æœ€ä½³å®è·µ**ï¼š
- âœ… åŠæ—¶ç”Ÿæˆå®¡è®¡æŠ¥å‘Š
- âœ… åˆ†å‘ç»™ç›¸å…³äººå‘˜
- âœ… è·Ÿè¸ªé—®é¢˜ä¿®å¤è¿›åº¦
- âœ… å®šæœŸå›é¡¾å®¡è®¡ç»“æœ

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [æŠ€æœ¯æ¶æ„è®¾è®¡æ–‡æ¡£](./2-æŠ€æœ¯æ¶æ„è®¾è®¡æ–‡æ¡£.md)
- [è¿ç»´æ–‡æ¡£](./10-è¿ç»´æ–‡æ¡£.md)
- [æ€§èƒ½ä¼˜åŒ–æ–‡æ¡£](./12-æ€§èƒ½ä¼˜åŒ–æ–‡æ¡£.md)

---

## ğŸ’¡ æ³¨æ„äº‹é¡¹

1. **å¯†é’¥ç®¡ç†**ï¼šä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç å¯†é’¥ï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡
2. **å®šæœŸæ›´æ–°**ï¼šå®šæœŸæ›´æ–°ä¾èµ–åº“ï¼Œä¿®å¤å®‰å…¨æ¼æ´
3. **å®‰å…¨å®¡è®¡**ï¼šå®šæœŸè¿›è¡Œå®‰å…¨å®¡è®¡å’Œæ¸—é€æµ‹è¯•
4. **æƒé™æœ€å°åŒ–**ï¼šéµå¾ªæœ€å°æƒé™åŸåˆ™
5. **å®‰å…¨åŸ¹è®­**ï¼šå®šæœŸè¿›è¡Œå®‰å…¨åŸ¹è®­å’Œæ„è¯†æ•™è‚²

---

**æ–‡æ¡£ç‰ˆæœ¬å†å²**ï¼š

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | å˜æ›´è¯´æ˜ |
|-----|------|------|---------|
| v1.0 | 2026-01-13 | AIåŠ©æ‰‹ | åˆå§‹ç‰ˆæœ¬ |
| v1.1 | 2026-01-14 | AIåŠ©æ‰‹ | æ–°å¢å®‰å…¨å®¡è®¡æµç¨‹ç« èŠ‚ |

---