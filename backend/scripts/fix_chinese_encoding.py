#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
批量修复Python文件中的中文乱码
"""

import os
import re
from pathlib import Path
from typing import Dict, List, Tuple


# 中文乱码映射表（根据实际观察到的乱码模式）
GARBLED_MAP = {
    # 用户相关
    '应用配置': '应用配置',
    '用户域服务': '用户域服务',
    '认证服务配置': '认证服务配置',
    '数据库配置': '数据库配置',
    'Redis配置': 'Redis配置',
    '日志配置': '日志配置',
    '用户关系模型': '用户关系模型',
    '用户表': '用户表',
    '部门表': '部门表',
    '角色表': '角色表',
    '用户角色关联表': '用户角色关联表',
    '用户角色关联表': '用户角色关联表',
    '关联ID': '关联ID',
    '用户ID': '用户ID',
    '角色ID': '角色ID',
    '创建时间': '创建时间',
    '租户ID': '租户ID',
    '用户名': '用户名',
    '密码（加密）': '密码（加密）',
    '邮箱': '邮箱',
    '手机号': '手机号',
    '部门ID': '部门ID',
    '岗位ID': '岗位ID',
    '状态': '状态',
    '最后登录时间': '最后登录时间',
    '最后登录IP': '最后登录IP',
    '部门名称': '部门名称',
    '部门编码': '部门编码',
    '涓婁骇部门ID': '上级部门ID',
    '部门负责人ID': '部门负责人ID',
    '排序': '排序',
    '角色名称': '角色名称',
    '角色编码': '角色编码',
    '角色描述': '角色描述',
    # 认证相关
    '认证域服务': '认证域服务',
    'JWT配置': 'JWT配置',
    '认证域服务': '认证域服务',
    '认证域服务': '认证域服务',
    # 权限相关
    '权限域服务': '权限域服务',
    '权限域服务': '权限域服务',
    '权限域服务': '权限域服务',
    # 系统相关
    '系统域服务': '系统域服务',
    '系统域服务': '系统域服务',
    '系统域服务': '系统域服务',
    # 支撑相关
    '支撑域服务': '支撑域服务',
    '支撑域服务': '支撑域服务',
    '支撑域服务': '支撑域服务',
    # 业务相关
    '业务域服务': '业务域服务',
    '业务域服务': '业务域服务',
    '业务域服务': '业务域服务',
    # 其他常见词汇
    '基础模型': '基础模型',
    '时间戳': '时间戳',
    '加载': '加载',
    '保存': '保存',
    '查询': '查询',
    '更新': '更新',
    '删除': '删除',
    '创建': '创建',
    '修改': '修改',
    '显示': '显示',
    '隐藏': '隐藏',
    '是否': '是否',
    '启用': '启用',
    '禁用': '禁用',
    '默认': '默认',
    '必填': '必填',
    '可选': '可选',
    '备注': '备注',
    '描述': '描述',
    '名称': '名称',
    '编码': '编码',
    '类型': '类型',
    '状态': '状态',
    '创建浜篒D': '创建人ID',
    '更新浜篒D': '更新人ID',
    '创建时间': '创建时间',
    '更新鏃堕棿': '更新时间',
    '删除鏃堕棿': '删除时间',
    '是否删除': '是否删除',
    '排序': '排序',
    '级别': '级别',
    '父级ID': '父级ID',
    '子级ID': '子级ID',
    '根据': '根据',
    '地址': '地址',
    '电话': '电话',
    '传真': '传真',
    '网站': '网站',
    '年代': '年代',
    '宽度': '宽度',
    '高度': '高度',
    '长度': '长度',
    '重量': '重量',
    '价格': '价格',
    '数量': '数量',
    '库存': '库存',
    '销量': '销量',
    '权重': '权重',
    '优惠': '优惠',
    '投资': '投资',
    '收藏': '收藏',
    '点赞': '点赞',
    '评论': '评论',
    '分享': '分享',
    '关注': '关注',
    '粉丝': '粉丝',
    '朋友': '朋友',
    '资源': '资源',
    '资源模块': '资源模块',
    '资源类型': '资源类型',
    '资源编码': '资源编码',
    '资源名称': '资源名称',
    '资源描述': '资源描述',
    '资源缁存姢': '资源维护',
    '资源鐩戠': '资源监控',
    '资源缁熶': '资源统计',
    '资源鎶ュ憡': '资源告警',
    '资源閰嶇疆': '资源配置',
    '资源绠＄悊': '资源管理',
    '资源浼樺寲': '资源优化',
    '资源璋冩煡': '资源调度',
    '资源鍒嗛厤': '资源分配',
    '资源浣跨敤': '资源使用',
    '资源鍏戞崲': '资源回收',
    '资源閲婃恫': '资源释放',
    '资源备注': '资源备注',
    '资源状态': '资源状态',
    '资源级别': '资源级别',
    '资源父级ID': '资源父级ID',
    '资源子级ID': '资源子级ID',
    '资源根据': '资源根据',
    '资源地址': '资源地址',
    '资源电话': '资源电话',
    '资源传真': '资源传真',
    '资源网站': '资源网站',
    '资源年代': '资源年代',
    '资源宽度': '资源宽度',
    '资源高度': '资源高度',
    '资源长度': '资源长度',
    '资源重量': '资源重量',
    '资源价格': '资源价格',
    '资源数量': '资源数量',
    '资源库存': '资源库存',
    '资源销量': '资源销量',
    '资源权重': '资源权重',
    '资源优惠': '资源优惠',
    '资源投资': '资源投资',
    '资源收藏': '资源收藏',
    '资源点赞': '资源点赞',
    '资源评论': '资源评论',
    '资源分享': '资源分享',
    '资源关注': '资源关注',
    '资源粉丝': '资源粉丝',
    '资源朋友': '资源朋友',
}


def fix_chinese_in_text(text: str) -> str:
    """
    修复文本中的中文乱码
    
    Args:
        text: 原始文本
        
    Returns:
        修复后的文本
    """
    result = text
    for garbled, correct in GARBLED_MAP.items():
        result = result.replace(garbled, correct)
    return result


def fix_chinese_in_file(file_path: Path) -> bool:
    """
    修复文件中的中文乱码
    
    Args:
        file_path: 文件路径
        
    Returns:
        是否修复成功
    """
    try:
        # 读取文件内容
        with open(file_path, 'r', encoding='utf-8') as f:
            content = f.read()
        
        # 修复中文乱码
        fixed_content = fix_chinese_in_text(content)
        
        # 如果内容有变化，则写入文件
        if fixed_content != content:
            with open(file_path, 'w', encoding='utf-8') as f:
                f.write(fixed_content)
            print(f"✅ 已修复: {file_path}")
            return True
        else:
            print(f"⏭️  跳过: {file_path} (无需修复)")
            return False
    except Exception as e:
        print(f"❌ 错误: {file_path} - {str(e)}")
        return False


def main():
    """
    主函数
    """
    # backend文件夹路径
    backend_path = Path(r'D:\WorkSpace\mcp-platform\backend')
    
    # 查找所有Python文件
    python_files = list(backend_path.rglob('*.py'))
    
    print(f"找到 {len(python_files)} 个Python文件")
    print("=" * 80)
    
    # 修复每个文件
    fixed_count = 0
    for file_path in python_files:
        if fix_chinese_in_file(file_path):
            fixed_count += 1
    
    print("=" * 80)
    print(f"修复完成！共修复 {fixed_count} 个文件")


if __name__ == '__main__':
    main()