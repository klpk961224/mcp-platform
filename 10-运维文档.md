# è¿ç»´æ–‡æ¡£

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

- **é¡¹ç›®åç§°**ï¼šä¼ä¸šçº§AIç»¼åˆç®¡ç†å¹³å°
- **æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
- **åˆ›å»ºæ—¥æœŸ**ï¼š2026-01-13
- **æ–‡æ¡£ç±»å‹**ï¼šè¿ç»´æ–‡æ¡£

---

## 1. ç³»ç»Ÿç›‘æ§æ–¹æ¡ˆ

### 1.1 ç›‘æ§æ¶æ„

```mermaid
graph TB
    A[åº”ç”¨] --> B[Prometheus]
    A --> C[Jaeger]
    A --> D[æ—¥å¿—ç³»ç»Ÿ]
    B --> E[Grafana]
    C --> E
    D --> E
```

### 1.2 ç›‘æ§æŒ‡æ ‡

| æŒ‡æ ‡ç±»å‹ | ç›‘æ§é¡¹ | å‘Šè­¦é˜ˆå€¼ |
|---------|--------|---------|
| **åº”ç”¨æŒ‡æ ‡** | QPSã€å“åº”æ—¶é—´ã€é”™è¯¯ç‡ | QPS<100ã€å“åº”æ—¶é—´>500msã€é”™è¯¯ç‡>1% |
| **ç³»ç»ŸæŒ‡æ ‡** | CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œ | CPU>80%ã€å†…å­˜>85%ã€ç£ç›˜>90% |
| **æ•°æ®åº“æŒ‡æ ‡** | è¿æ¥æ•°ã€æ…¢æŸ¥è¯¢ã€ä¸»ä»å»¶è¿Ÿ | è¿æ¥æ•°>80%ã€æ…¢æŸ¥è¯¢>1sã€ä¸»ä»å»¶è¿Ÿ>100ms |
| **ç¼“å­˜æŒ‡æ ‡** | å‘½ä¸­ç‡ã€å†…å­˜ä½¿ç”¨ã€è¿æ¥æ•° | å‘½ä¸­ç‡<80%ã€å†…å­˜ä½¿ç”¨>85% |

---

## 2. æ—¥å¿—ç®¡ç†æ–¹æ¡ˆ

### 2.1 æ—¥å¿—åˆ†ç±»

| æ—¥å¿—ç±»å‹ | å­˜å‚¨ä½ç½® | ä¿ç•™æ—¶é—´ | æ—¥å¿—çº§åˆ« |
|---------|---------|---------|---------|
| **åº”ç”¨æ—¥å¿—** | /var/log/app/ | 30å¤© | DEBUG/INFO/WARNING/ERROR |
| **è®¿é—®æ—¥å¿—** | /var/log/nginx/ | 30å¤© | INFO |
| **é”™è¯¯æ—¥å¿—** | /var/log/error/ | 90å¤© | ERROR |
| **å®¡è®¡æ—¥å¿—** | /var/log/audit/ | 180å¤© | INFO |

### 2.2 æ—¥å¿—é…ç½®

```python
# utils/logger.py
import sys
from loguru import logger
from pathlib import Path

# é…ç½®æ—¥å¿—
logger.remove()
logger.add(
    sys.stderr,
    level="DEBUG",
    format="<green>{time:YYYY-MM-DD HH:mm:ss}</green> | <level>{level: <8}</level> | <cyan>{name}</cyan>:<cyan>{function}</cyan>:<cyan>{line}</cyan> - <level>{message}</level>"
)

# æ–‡ä»¶æ—¥å¿—
logger.add(
    "logs/app.log",
    rotation="100 MB",
    retention="30 days",
    level="INFO",
    format="{time:YYYY-MM-DD HH:mm:ss} | {level: <8} | {name}:{function}:{line} - {message}"
)

# é”™è¯¯æ—¥å¿—
logger.add(
    "logs/error.log",
    rotation="50 MB",
    retention="90 days",
    level="ERROR",
    format="{time:YYYY-MM-DD HH:mm:ss} | {level: <8} | {name}:{function}:{line} - {message}"
)
```

---

## 3. å‘Šè­¦é…ç½®

### 3.1 å‘Šè­¦è§„åˆ™

| å‘Šè­¦çº§åˆ« | è§¦å‘æ¡ä»¶ | é€šçŸ¥æ–¹å¼ |
|---------|---------|---------|
| **ç´§æ€¥** | åº”ç”¨å®•æœºã€æ•°æ®åº“ä¸å¯ç”¨ | ç”µè¯+çŸ­ä¿¡+é‚®ä»¶ |
| **é‡è¦** | å“åº”æ—¶é—´>1sã€é”™è¯¯ç‡>5% | çŸ­ä¿¡+é‚®ä»¶ |
| **ä¸€èˆ¬** | CPU>80%ã€å†…å­˜>85% | é‚®ä»¶ |

### 3.2 å‘Šè­¦é€šçŸ¥

```yaml
# prometheus/alerts.yml
groups:
  - name: åº”ç”¨å‘Šè­¦
    rules:
      - alert: åº”ç”¨é”™è¯¯ç‡è¿‡é«˜
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.05
        for: 2m
        labels:
          severity: é‡è¦
        annotations:
          summary: "åº”ç”¨é”™è¯¯ç‡è¿‡é«˜"
          description: "åº”ç”¨{{ $labels.instance }} é”™è¯¯ç‡è¶…è¿‡5%"

      - alert: åº”ç”¨å“åº”æ—¶é—´è¿‡é•¿
        expr: histogram_quantile(0.95, http_request_duration_seconds_bucket) > 1
        for: 5m
        labels:
          severity: ä¸€èˆ¬
        annotations:
          summary: "åº”ç”¨å“åº”æ—¶é—´è¿‡é•¿"
          description: "åº”ç”¨{{ $labels.instance }} 95%åˆ†ä½å“åº”æ—¶é—´è¶…è¿‡1ç§’"
```

---

## 4. æ•…éšœå¤„ç†æµç¨‹

### 4.1 æ•…éšœå¤„ç†æµç¨‹å›¾

```mermaid
graph TD
    A[å‘ç°æ•…éšœ] --> B[å‘Šè­¦é€šçŸ¥]
    B --> C[æ•…éšœç¡®è®¤]
    C --> D{æ•…éšœç±»å‹}
    D --> E[åº”ç”¨æ•…éšœ]
    D --> F[æ•°æ®åº“æ•…éšœ]
    D --> G[ç½‘ç»œæ•…éšœ]
    E --> H[é‡å¯æœåŠ¡]
    F --> I[æ£€æŸ¥æ•°æ®åº“]
    G --> J[æ£€æŸ¥ç½‘ç»œ]
    H --> K[éªŒè¯ä¿®å¤]
    I --> K
    J --> K
    K --> L[æ•…éšœæ¢å¤]
    L --> M[æ•…éšœæ€»ç»“]
```

### 4.2 æ•…éšœå¤„ç†æ¸…å•

- [ ] ç¡®è®¤æ•…éšœç°è±¡
- [ ] æ£€æŸ¥æ—¥å¿—
- [ ] æ£€æŸ¥ç›‘æ§æŒ‡æ ‡
- [ ] å®šä½æ•…éšœåŸå› 
- [ ] åˆ¶å®šä¿®å¤æ–¹æ¡ˆ
- [ ] æ‰§è¡Œä¿®å¤æ“ä½œ
- [ ] éªŒè¯ä¿®å¤ç»“æœ
- [ ] ç¼–å†™æ•…éšœæŠ¥å‘Š

---

## 5. å¤‡ä»½æ¢å¤ç­–ç•¥

### 5.1 å¤‡ä»½ç­–ç•¥

| å¤‡ä»½ç±»å‹ | å¤‡ä»½å†…å®¹ | å¤‡ä»½é¢‘ç‡ | ä¿ç•™æ—¶é—´ |
|---------|---------|---------|---------|
| **æ•°æ®åº“å¤‡ä»½** | MySQLæ•°æ® | æ¯å¤© | 30å¤© |
| **é…ç½®å¤‡ä»½** | é…ç½®æ–‡ä»¶ | æ¯å‘¨ | 90å¤© |
| **æ—¥å¿—å¤‡ä»½** | æ—¥å¿—æ–‡ä»¶ | æ¯å¤© | 30å¤© |

### 5.2 å¤‡ä»½è„šæœ¬

```bash
#!/bin/bash

# backup.sh

# æ•°æ®åº“å¤‡ä»½
mysqldump -h localhost -u root -p12345678 mcp_platform > backup/mcp_platform_$(date +%Y%m%d).sql

# é…ç½®æ–‡ä»¶å¤‡ä»½
tar -czf backup/config_$(date +%Y%m%d).tar.gz config/

# æ—¥å¿—å¤‡ä»½
tar -czf backup/logs_$(date +%Y%m%d).tar.gz logs/

# æ¸…ç†30å¤©å‰çš„å¤‡ä»½
find backup -name "*.sql" -mtime +30 -delete
find backup -name "*.tar.gz" -mtime +30 -delete
```

### 5.3 æ¢å¤æµç¨‹

```bash
# æ•°æ®åº“æ¢å¤
mysql -h localhost -u root -p12345678 mcp_platform < backup/mcp_platform_20260113.sql

# é…ç½®æ–‡ä»¶æ¢å¤
tar -xzf backup/config_20260113.tar.gz -C /

# æ—¥å¿—æ¢å¤
tar -xzf backup/logs_20260113.tar.gz -C /
```

---

## 6. æ€§èƒ½è°ƒä¼˜æŒ‡å—

### 6.1 æ•°æ®åº“ä¼˜åŒ–

```sql
-- æ…¢æŸ¥è¯¢åˆ†æ
SELECT * FROM slow_query_log ORDER BY query_time DESC LIMIT 10;

-- ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_username ON users(username);
CREATE INDEX idx_email ON users(email);

-- æŸ¥è¯¢ä¼˜åŒ–
EXPLAIN SELECT * FROM users WHERE username = 'admin';
```

### 6.2 åº”ç”¨ä¼˜åŒ–

```python
# ä½¿ç”¨è¿æ¥æ± 
from sqlalchemy.pool import QueuePool

engine = create_engine(
    DATABASE_URL,
    poolclass=QueuePool,
    pool_size=10,
    max_overflow=20,
    pool_timeout=30,
    pool_recycle=3600
)

# ä½¿ç”¨ç¼“å­˜
from functools import lru_cache

@lru_cache(maxsize=128)
def get_user_info(user_id: str):
    # ç¼“å­˜ç”¨æˆ·ä¿¡æ¯
    pass
```

---

## 7. æ—¥å¸¸å·¡æ£€æ¸…å•

### 7.1 æ¯æ—¥å·¡æ£€

- [ ] æ£€æŸ¥æœåŠ¡çŠ¶æ€
- [ ] æ£€æŸ¥é”™è¯¯æ—¥å¿—
- [ ] æ£€æŸ¥ç›‘æ§æŒ‡æ ‡
- [ ] æ£€æŸ¥ç£ç›˜ç©ºé—´
- [ ] æ£€æŸ¥å¤‡ä»½çŠ¶æ€

### 7.2 æ¯å‘¨å·¡æ£€

- [ ] æ£€æŸ¥ç³»ç»Ÿæ›´æ–°
- [ ] æ£€æŸ¥å®‰å…¨æ¼æ´
- [ ] æ£€æŸ¥æ€§èƒ½è¶‹åŠ¿
- [ ] æ£€æŸ¥æ—¥å¿—å½’æ¡£
- [ ] æ£€æŸ¥å¤‡ä»½å®Œæ•´æ€§

### 7.3 æ¯æœˆå·¡æ£€

- [ ] å®¹é‡è§„åˆ’è¯„ä¼°
- [ ] æ€§èƒ½æµ‹è¯•
- [ ] ç¾å¤‡æ¢å¤æ¼”ç»ƒ
- [ ] å®‰å…¨å®¡è®¡
- [ ] è¿ç»´æ–‡æ¡£æ›´æ–°

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [éƒ¨ç½²æ–‡æ¡£](./8-éƒ¨ç½²æ–‡æ¡£.md)
- [å®‰å…¨æ–‡æ¡£](./11-å®‰å…¨æ–‡æ¡£.md)
- [æ€§èƒ½ä¼˜åŒ–æ–‡æ¡£](./12-æ€§èƒ½ä¼˜åŒ–æ–‡æ¡£.md)

---

## ğŸ’¡ æ³¨æ„äº‹é¡¹

1. **ç›‘æ§å‘Šè­¦**ï¼šåŠæ—¶å“åº”å‘Šè­¦ï¼Œé¿å…é—®é¢˜æ‰©å¤§
2. **æ—¥å¿—ç®¡ç†**ï¼šå®šæœŸæ¸…ç†æ—¥å¿—ï¼Œé¿å…ç£ç›˜å æ»¡
3. **å¤‡ä»½éªŒè¯**ï¼šå®šæœŸéªŒè¯å¤‡ä»½çš„å¯ç”¨æ€§
4. **æ•…éšœæ€»ç»“**ï¼šæ¯æ¬¡æ•…éšœåç¼–å†™æ•…éšœæŠ¥å‘Š
5. **æ–‡æ¡£æ›´æ–°**ï¼šåŠæ—¶æ›´æ–°è¿ç»´æ–‡æ¡£

---

**æ–‡æ¡£ç‰ˆæœ¬å†å²**ï¼š

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | å˜æ›´è¯´æ˜ |
|-----|------|------|---------|
| v1.0 | 2026-01-13 | AIåŠ©æ‰‹ | åˆå§‹ç‰ˆæœ¬ |

---