# æ€§èƒ½ä¼˜åŒ–æ–‡æ¡£

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

- **é¡¹ç›®åç§°**ï¼šä¼ä¸šçº§AIç»¼åˆç®¡ç†å¹³å°
- **æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
- **åˆ›å»ºæ—¥æœŸ**ï¼š2026-01-13
- **æ–‡æ¡£ç±»å‹**ï¼šæ€§èƒ½ä¼˜åŒ–æ–‡æ¡£

---

## 1. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1.1 æ€§èƒ½ä¼˜åŒ–å±‚æ¬¡

```mermaid
graph TB
    A[åº”ç”¨å±‚ä¼˜åŒ–] --> B[æ•°æ®åº“å±‚ä¼˜åŒ–]
    B --> C[ç¼“å­˜å±‚ä¼˜åŒ–]
    C --> D[ç½‘ç»œå±‚ä¼˜åŒ–]
    D --> E[ç¡¬ä»¶å±‚ä¼˜åŒ–]
```

### 1.2 ä¼˜åŒ–ç›®æ ‡

| æŒ‡æ ‡ | å½“å‰å€¼ | ç›®æ ‡å€¼ | ä¼˜åŒ–æ–¹æ³• |
|-----|--------|--------|---------|
| **å“åº”æ—¶é—´** | 500ms | <200ms | ç¼“å­˜ã€å¼‚æ­¥ã€ä¼˜åŒ–æŸ¥è¯¢ |
| **ååé‡** | 500 TPS | >1000 TPS | è¿æ¥æ± ã€å¼‚æ­¥å¤„ç† |
| **å¹¶å‘ç”¨æˆ·** | 500 | >1000 | æ°´å¹³æ‰©å±•ã€è´Ÿè½½å‡è¡¡ |

---

## 2. æ•°æ®åº“ä¼˜åŒ–æ–¹æ¡ˆ

### 2.1 ç´¢å¼•ä¼˜åŒ–

```sql
-- æŸ¥è¯¢æ…¢æŸ¥è¯¢
SELECT * FROM slow_query_log ORDER BY query_time DESC LIMIT 10;

-- æ·»åŠ ç´¢å¼•
CREATE INDEX idx_username ON users(username);
CREATE INDEX idx_email ON users(email);
CREATE INDEX idx_tenant_id ON users(tenant_id);
CREATE INDEX idx_status ON users(status);

-- å¤åˆç´¢å¼•
CREATE INDEX idx_tenant_status ON users(tenant_id, status);

-- åˆ é™¤æ— ç”¨ç´¢å¼•
DROP INDEX idx_unused_index;
```

### 2.2 æŸ¥è¯¢ä¼˜åŒ–

```python
# é”™è¯¯ç¤ºä¾‹ï¼šN+1æŸ¥è¯¢
def get_users_with_roles():
    users = db.query(User).all()
    result = []
    for user in users:
        roles = db.query(Role).filter(Role.user_id == user.id).all()
        result.append({
            "user": user,
            "roles": roles
        })
    return result

# æ­£ç¡®ç¤ºä¾‹ï¼šä½¿ç”¨JOIN
def get_users_with_roles():
    result = db.query(User).join(UserRole).join(Role).all()
    return result

# ä½¿ç”¨æ‰¹é‡æ’å…¥
def batch_create_users(users: List[dict]):
    db.bulk_insert_mappings(User, users)
    db.commit()
```

### 2.3 è¿æ¥æ± ä¼˜åŒ–

```python
# é…ç½®è¿æ¥æ± 
from sqlalchemy.pool import QueuePool

engine = create_engine(
    DATABASE_URL,
    poolclass=QueuePool,
    pool_size=10,          # è¿æ¥æ± å¤§å°
    max_overflow=20,       # æœ€å¤§æº¢å‡ºè¿æ¥æ•°
    pool_timeout=30,       # è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
    pool_recycle=3600,     # è¿æ¥å›æ”¶æ—¶é—´ï¼ˆç§’ï¼‰
    pool_pre_ping=True,     # è¿æ¥å‰æ£€æŸ¥
    echo=False             # ç”Ÿäº§ç¯å¢ƒå…³é—­SQLæ—¥å¿—
)
```

---

## 3. ç¼“å­˜ä¼˜åŒ–æ–¹æ¡ˆ

### 3.1 å¤šçº§ç¼“å­˜

```python
# utils/cache.py
from functools import lru_cache
from typing import Any, Optional

class CacheManager:
    def __init__(self):
        self.local_cache = {}  # L1ç¼“å­˜
        self.redis_client = None  # L2ç¼“å­˜
    
    async def get(self, key: str) -> Optional[Any]:
        # L1ç¼“å­˜
        if key in self.local_cache:
            return self.local_cache[key]
        
        # L2ç¼“å­˜
        if self.redis_client:
            value = await self.redis_client.get(key)
            if value:
                self.local_cache[key] = value
                return value
        
        return None
    
    async def set(self, key: str, value: Any, ttl: int = 3600):
        # L1ç¼“å­˜
        self.local_cache[key] = value
        
        # L2ç¼“å­˜
        if self.redis_client:
            await self.redis_client.setex(key, ttl, value)
    
    async def delete(self, key: str):
        # åˆ é™¤L1ç¼“å­˜
        if key in self.local_cache:
            del self.local_cache[key]
        
        # åˆ é™¤L2ç¼“å­˜
        if self.redis_client:
            await self.redis_client.delete(key)
    
    async def clear(self):
        # æ¸…ç©ºL1ç¼“å­˜
        self.local_cache.clear()
        
        # æ¸…ç©ºL2ç¼“å­˜
        if self.redis_client:
            await self.redis_client.flushdb()

# ä½¿ç”¨ç¼“å­˜è£…é¥°å™¨
def cache_result(ttl: int = 3600):
    def decorator(func):
        async def wrapper(*args, **kwargs):
            cache_key = f"{func.__name__}:{str(args)}:{str(kwargs)}"
            cached = await cache_manager.get(cache_key)
            if cached:
                return cached
            
            result = await func(*args, **kwargs)
            await cache_manager.set(cache_key, result, ttl)
            return result
        return wrapper
    return decorator
```

### 3.2 ç¼“å­˜ç­–ç•¥

| æ•°æ®ç±»å‹ | ç¼“å­˜æ—¶é—´ | æ›´æ–°ç­–ç•¥ |
|---------|---------|---------|
| **ç”¨æˆ·ä¿¡æ¯** | 30åˆ†é’Ÿ | ç”¨æˆ·æ›´æ–°æ—¶æ¸…ç©º |
| **æƒé™æ•°æ®** | 1å°æ—¶ | æƒé™å˜æ›´æ—¶æ¸…ç©º |
| **å­—å…¸æ•°æ®** | 24å°æ—¶ | å­—å…¸æ›´æ–°æ—¶æ¸…ç©º |
| **èœå•æ•°æ®** | 1å°æ—¶ | èœå•å˜æ›´æ—¶æ¸…ç©º |
| **ç»Ÿè®¡æ•°æ®** | 5åˆ†é’Ÿ | å®šæ—¶åˆ·æ–° |

---

## 4. æ¥å£ä¼˜åŒ–æ–¹æ¡ˆ

### 4.1 å¼‚æ­¥å¤„ç†

```python
from fastapi import FastAPI
import asyncio

app = FastAPI()

@app.post("/api/v1/users/batch")
async def batch_create_users(users: List[dict]):
    """æ‰¹é‡åˆ›å»ºç”¨æˆ·ï¼ˆå¼‚æ­¥ï¼‰"""
    tasks = []
    for user_data in users:
        task = asyncio.create_task(create_user_async(user_data))
        tasks.append(task)
    
    results = await asyncio.gather(*tasks)
    return {"success": True, "data": results}

async def create_user_async(user_data: dict):
    """å¼‚æ­¥åˆ›å»ºç”¨æˆ·"""
    # æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œ
    await asyncio.sleep(0.1)
    return {"id": "1", **user_data}
```

### 4.2 åˆ†é¡µä¼˜åŒ–

```python
@app.get("/api/v1/users")
async def get_users(page: int = 1, size: int = 10):
    """è·å–ç”¨æˆ·åˆ—è¡¨ï¼ˆä¼˜åŒ–åˆ†é¡µï¼‰"""
    # ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µï¼Œé¿å…OFFSET
    if page > 1:
        last_id = get_last_id(page, size)
        users = db.query(User).filter(
            User.id > last_id
        ).limit(size).all()
    else:
        users = db.query(User).limit(size).all()
    
    return {
        "items": users,
        "page": page,
        "size": size
    }
```

---

## 5. å‰ç«¯æ€§èƒ½ä¼˜åŒ–

### 5.1 è·¯ç”±æ‡’åŠ è½½

```typescript
// router/index.ts
const routes = [
  {
    path: '/dashboard',
    component: () => import('@/views/dashboard/Index.vue')
  },
  {
    path: '/system/user',
    component: () => import('@/views/system/User.vue')
  }
]
```

### 5.2 ç»„ä»¶æ‡’åŠ è½½

```vue
<script setup lang="ts">
import { defineAsyncComponent } from 'vue'

const HeavyComponent = defineAsyncComponent(() =>
  import('./HeavyComponent.vue')
)
</script>
```

### 5.3 æ‰“åŒ…ä¼˜åŒ–

```typescript
// vite.config.ts
export default defineConfig({
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          'vue-vendor': ['vue', 'vue-router', 'pinia'],
          'element-plus': ['element-plus'],
          'axios': ['axios']
        }
      }
    },
    chunkSizeWarningLimit: 1000
  }
})
```

---

## 6. æ€§èƒ½æµ‹è¯•æ–¹æ¡ˆ

### 6.1 æ€§èƒ½æµ‹è¯•å·¥å…·

| å·¥å…· | ç”¨é€” |
|-----|------|
| **JMeter** | å‹åŠ›æµ‹è¯•ã€æ€§èƒ½æµ‹è¯• |
| **Locust** | åˆ†å¸ƒå¼è´Ÿè½½æµ‹è¯• |
| **Pytest-benchmark** | Pythonä»£ç æ€§èƒ½æµ‹è¯• |
| **Lighthouse** | å‰ç«¯æ€§èƒ½æµ‹è¯• |

### 6.2 æ€§èƒ½æµ‹è¯•è„šæœ¬

```python
# tests/benchmark/test_user_query.py
import pytest
import time
from app.services.user_service import UserService

def benchmark_get_user(benchmark):
    """æ€§èƒ½æµ‹è¯•ï¼šæŸ¥è¯¢ç”¨æˆ·"""
    user_service = UserService()
    
    # é¢„çƒ­
    user_service.get_user("1")
    
    # æµ‹è¯•
    start_time = time.time()
    for _ in range(1000):
        user_service.get_user("1")
    end_time = time.time()
    
    return end_time - start_time
```

---

## 7. æ€§èƒ½ç›‘æ§æŒ‡æ ‡

### 7.1 å…³é”®æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | ç›‘æ§å·¥å…· |
|-----|--------|---------|
| **P95å“åº”æ—¶é—´** | <200ms | Prometheus |
| **P99å“åº”æ—¶é—´** | <500ms | Prometheus |
| **é”™è¯¯ç‡** | <1% | Prometheus |
| **ååé‡** | >1000 TPS | Prometheus |
| **CPUä½¿ç”¨ç‡** | <70% | Prometheus |
| **å†…å­˜ä½¿ç”¨ç‡** | <80% | Prometheus |

### 7.2 Grafanaä»ªè¡¨æ¿

```json
{
  "dashboard": {
    "title": "åº”ç”¨æ€§èƒ½ç›‘æ§",
    "panels": [
      {
        "title": "QPS",
        "targets": [
          {
            "expr": "rate(http_requests_total[1m])"
          }
        ]
      },
      {
        "title": "å“åº”æ—¶é—´",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, http_request_duration_seconds_bucket)"
          }
        ]
      },
      {
        "title": "é”™è¯¯ç‡",
        "targets": [
          {
            "expr": "rate(http_requests_total{status=~\"5..\"}[1m]) / rate(http_requests_total[1m])"
          }
        ]
      }
    ]
  }
}
```

---

## 8. æ€§èƒ½ä¼˜åŒ–æ¡ˆä¾‹

### 8.1 æ¡ˆä¾‹1ï¼šç”¨æˆ·æŸ¥è¯¢ä¼˜åŒ–

**é—®é¢˜**ï¼šç”¨æˆ·æŸ¥è¯¢å“åº”æ—¶é—´500ms

**åˆ†æ**ï¼šN+1æŸ¥è¯¢é—®é¢˜

**ä¼˜åŒ–**ï¼š
1. ä½¿ç”¨JOINæ›¿ä»£å¤šæ¬¡æŸ¥è¯¢
2. æ·»åŠ ç´¢å¼•
3. ä½¿ç”¨ç¼“å­˜

**ç»“æœ**ï¼šå“åº”æ—¶é—´é™ä½åˆ°50ms

### 8.2 æ¡ˆä¾‹2ï¼šæƒé™æ ¡éªŒä¼˜åŒ–

**é—®é¢˜**ï¼šæƒé™æ ¡éªŒæ¯æ¬¡éƒ½æŸ¥è¯¢æ•°æ®åº“

**ä¼˜åŒ–**ï¼š
1. ä½¿ç”¨å¤šçº§ç¼“å­˜
2. æƒé™å˜æ›´æ—¶æ¸…ç©ºç¼“å­˜
3. ä½¿ç”¨æœ¬åœ°ç¼“å­˜+Redisç¼“å­˜

**ç»“æœ**ï¼šå“åº”æ—¶é—´é™ä½åˆ°10ms

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [æŠ€æœ¯æ¶æ„è®¾è®¡æ–‡æ¡£](./2-æŠ€æœ¯æ¶æ„è®¾è®¡æ–‡æ¡£.md)
- [è¿ç»´æ–‡æ¡£](./10-è¿ç»´æ–‡æ¡£.md)
- [å®‰å…¨æ–‡æ¡£](./11-å®‰å…¨æ–‡æ¡£.md)

---

## ğŸ’¡ æ³¨æ„äº‹é¡¹

1. **æ€§èƒ½æµ‹è¯•**ï¼šå®šæœŸè¿›è¡Œæ€§èƒ½æµ‹è¯•ï¼ŒåŠæ—¶å‘ç°æ€§èƒ½é—®é¢˜
2. **ç›‘æ§å‘Šè­¦**ï¼šé…ç½®æ€§èƒ½ç›‘æ§å‘Šè­¦ï¼ŒåŠæ—¶å‘ç°é—®é¢˜
3. **ä¼˜åŒ–éªŒè¯**ï¼šä¼˜åŒ–åè¿›è¡Œæ€§èƒ½æµ‹è¯•ï¼ŒéªŒè¯ä¼˜åŒ–æ•ˆæœ
4. **æŒç»­ä¼˜åŒ–**ï¼šæ€§èƒ½ä¼˜åŒ–æ˜¯æŒç»­çš„è¿‡ç¨‹ï¼Œéœ€è¦æŒç»­æ”¹è¿›
5. **æ–‡æ¡£æ›´æ–°**ï¼šä¼˜åŒ–ååŠæ—¶æ›´æ–°æ€§èƒ½æ–‡æ¡£

---

**æ–‡æ¡£ç‰ˆæœ¬å†å²**ï¼š

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | å˜æ›´è¯´æ˜ |
|-----|------|------|---------|
| v1.0 | 2026-01-13 | AIåŠ©æ‰‹ | åˆå§‹ç‰ˆæœ¬ |

---