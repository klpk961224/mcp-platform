# iFlow CLI 上下文配置

## 项目概览

**项目名称**: 企业级AI综合管理平台 (mcp-platform)

**项目类型**: 企业级全栈应用（后端开发完成，准备开始前端开发）

**项目目标**:
构建一个安全、灵活、可扩展的综合管理平台，整合MCP（Model Context Protocol）工具调用网关及多MCP工具管理能力，实现细粒度权限控制、多租户隔离、动态配置管理，并提供完整的RBAC权限管理体系。

**当前状态**: 后端开发完成（100%），后端单元测试完成（100%，154/154通过），后端集成测试完成（100%，23/23通过），环境配置文件完善完成（100%），准备开始前端开发

---

## 目录结构

```
mcp-platform/
├── doc/                              # 所有核心文档
│   ├── 0-外部软件服务需求清单.md          # 外部服务配置清单
│   ├── 1-项目启动文档.md                  # 项目背景、目标、需求分析
│   ├── 2-技术架构设计文档.md              # 系统架构、微服务设计、服务间通信、分布式事务
│   ├── 3-数据库设计文档.md                # 数据库设计、ER图、索引优化、分库分表
│   ├── 4-API接口设计文档.md               # API规范、接口列表、API版本管理
│   ├── 5-前端架构设计文档.md              # Vue 3前端架构、状态管理
│   ├── 6-开发规范文档.md                  # 代码规范、Git规范、注释规范
│   ├── 7-环境配置文档.md                  # 开发/测试/生产环境配置、外部服务配置
│   ├── 8-部署文档.md                      # Docker/K8s部署方案、部署流程、回滚策略
│   ├── 9-测试文档.md                      # 测试策略、测试规范、自动化测试流程
│   ├── 10-运维文档.md                     # 监控方案、日志管理、故障处理、灾备方案、容量规划
│   ├── 11-安全文档.md                     # 安全架构、认证授权、数据加密、安全审计流程
│   ├── 12-性能优化文档.md                 # 性能优化策略、前端性能优化、性能测试基准
│   ├── 项目全流程文档生成提示词.md        # 文档生成提示词
│   ├── frontend-design.md                 # 前端UI/UX设计方案
│   └── 其他文档/
│       └── RabbitMQ安装配置指南.md
├── backend/                           # 后端代码
│   ├── common/                         # 共享代码库
│   │   ├── database/                   # 数据库模块
│   │   ├── config/                     # 配置模块
│   │   ├── security/                   # 安全模块
│   │   ├── cache/                      # 缓存模块
│   │   ├── middleware/                 # 中间件
│   │   ├── utils/                      # 工具模块
│   │   ├── decorators/                 # 装饰器
│   │   ├── exceptions/                 # 异常类
│   │   └── responses/                  # 响应模块
│   ├── services/                       # 微服务
│   │   ├── auth-service/               # 认证域服务（8001）
│   │   ├── user-service/               # 用户域服务（8002）
│   │   ├── permission-service/         # 权限域服务（8003）
│   │   ├── system-service/             # 系统域服务（8004）
│   │   ├── support-service/            # 支撑域服务（8005）
│   │   └── business-service/           # 业务域服务（8006）
│   ├── tests/                          # 后端测试
│   └── scripts/                        # 工具脚本
├── IFLOW.md                             # 项目上下文配置（本文件）
├── README.md                            # 项目简介
├── 开发进度确认单.md                     # 开发进度跟踪
└── LICENSE                              # 开源许可证
```

---

## 技术栈

### 后端技术栈
- **Web框架**: FastAPI 0.104+
- **ORM**: SQLAlchemy 2.0+
- **鉴权**: PyJWT + python-jose 2.8+
- **配置中心**: Nacos 2.2+（可选，默认本地配置）
- **消息队列**: RabbitMQ 3.12+（可选，默认同步执行）
- **缓存**: Redis 7.0+（可选，默认本地缓存）
- **API网关**: APISIX 3.5+（可选）
- **限流熔断**: Sentinel 1.8+（可选）
- **分布式追踪**: Jaeger 1.50+（可选）
- **监控**: Prometheus + Grafana（可选）
- **日志**: loguru 0.7+
- **数据库迁移**: Alembic 1.12+（可选）
- **容器化**: Docker 24.0+（可选）
- **CI/CD**: GitHub Actions（可选）

### 前端技术栈
- **框架**: Vue 3.3+
- **语言**: TypeScript 5.0+
- **构建工具**: Vite 5.0+
- **路由**: Vue Router 4.2+
- **状态管理**: Pinia 2.1+
- **UI组件库**: Element Plus 2.4+
- **HTTP客户端**: Axios 1.6+
- **代码规范**: ESLint + Prettier

### 数据库技术栈
- **主数据库**: MySQL 8.0+
- **可选数据库**: PostgreSQL 15+, Oracle 19c+

---

## 微服务架构

本系统采用**微服务架构**，优化后包含以下服务：

| 服务名称 | 端口 | 职责 |
|---------|------|------|
| Vue 3前端应用 | 3000 | 用户界面、交互逻辑 |
| 认证域服务 | 8001 | JWT认证、API Key认证、权限校验、Token管理 |
| 用户域服务 | 8002 | 用户CRUD、部门管理、租户管理、用户与部门/角色关联 |
| 权限域服务 | 8003 | 角色管理、权限分配、菜单管理、动态菜单加载 |
| 系统域服务 | 8004 | MCP工具注册/调用、多数据源管理、字典管理、系统配置 |
| 支撑域服务 | 8005 | 登录日志、操作日志、站内信、通知公告、**待办任务管理** |
| 业务域服务 | 8006 | 业务逻辑模块、**工作流管理** |

**服务依赖关系**:
- 认证域服务 → 被所有其他服务依赖
- 用户域服务 → 依赖认证域服务、权限域服务
- 权限域服务 → 依赖用户域服务
- 系统域服务 → 依赖认证域服务、权限域服务
- 支撑域服务 → 依赖认证域服务
- 业务域服务 → 依赖认证域服务、权限域服务、用户域服务

---

## 核心功能模块

### P0（必须实现）
1. 认证授权（JWT + API Key）
2. 用户管理
3. 基础权限（RBAC）
4. MCP工具注册与调用
5. 多租户隔离
6. 多数据源管理

### P1（重要）
1. 部门管理
2. 角色管理
3. 菜单管理
4. 数据范围权限
5. 日志审计
6. 权限缓存
7. **待办任务管理**（2026-01-14新增，属于支撑域服务8005）
   - 个人待办任务（创建、编辑、删除、标记完成、优先级、截止时间、标签、附件）
   - 每日计划（创建、查询、完成、统计、历史记录）
   - 待办任务列表（分页、搜索、筛选、排序）
   - 任务提醒（到期提醒、超时提醒、每日计划提醒、通知推送）
   - 首页看板集成（待办任务列表排第一）
8. **工作流管理**（2026-01-14新增，属于业务域服务8006）
   - 传统审批流程（请假、加班、离职、权限开放、报销等）
   - 可视化设计器（拖拽式节点编辑、流程图展示）
   - 审批流程配置（单人审批、多人审批、条件分支、并行节点）
   - 审批任务管理（待办、已办、抄送、转交、审批评论）
   - 流程监控（实时监控、节点进度高亮、执行日志、流程图高亮）
   - 预置审批模板（人事、权限、财务、IT审批）
   - 首页看板集成（工作流统计卡片排第二）

### P2（可选）
1. 岗位管理
2. 字典管理
3. 错误码管理
4. 敏感词管理
5. 地区管理
6. 站内信
7. 通知公告

---

## 外部服务配置

### 核心必须服务（必须部署）
1. **MySQL** - 主数据库（localhost:3306）
2. **Git** - 版本控制（git@github.com:klpk961224/mcp-platform.git）
3. **Docker** - 容器化

### 核心可选服务（有降级方案）
1. **Nacos** - 配置中心（降级：使用本地`.env`配置文件）
2. **RabbitMQ** - 消息队列（降级：同步执行）
3. **APISIX** - API网关（降级：直连后端服务）
4. **Sentinel** - 限流熔断（降级：无限流保护）
5. **Jaeger** - 分布式追踪（降级：使用本地日志）
6. **Prometheus** - 监控（降级：无监控数据）
7. **Grafana** - 可视化（降级：无可视化）
8. **Redis** - 缓存（降级：本地内存缓存）
9. **GitHub Actions** - CI/CD（降级：手动部署）

### 完全可选服务（不影响核心功能）
1. **PostgreSQL** - 多数据源支持
2. **Oracle** - 多数据源支持
3. **SQLite** - 开发环境备用
4. **Kubernetes** - 生产环境容器编排

---

## 文档说明

### 已完成文档列表
所有12个核心文档已于2026-01-13完成生成，2026-01-14更新待办任务管理和工作流功能相关内容，2026-01-14完成文档优化和补充：

**主要文档更新（2026-01-14）**：
1. **1-项目启动文档.md** - 添加待办任务管理和工作流管理功能需求
2. **2-技术架构设计文档.md** - 更新服务职责、添加服务间通信机制、添加分布式事务方案（Saga模式）
3. **3-数据库设计文档.md** - 添加待办任务和工作流相关表、添加索引优化策略、添加分库分表方案
4. **4-API接口设计文档.md** - 添加待办任务和工作流API、添加API版本管理
5. **5-前端架构设计文档.md** - 更新状态管理，添加TodoStore和WorkflowStore
6. **7-环境配置文档.md** - 更新服务端口配置
7. **8-部署文档.md** - 更新部署配置
8. **9-测试文档.md** - 添加自动化测试流程
9. **10-运维文档.md** - 添加灾备方案、添加容量规划
10. **11-安全文档.md** - 添加安全审计流程
11. **12-性能优化文档.md** - 添加前端性能优化、添加性能测试基准
12. **frontend-design.md** - 添加待办任务管理和工作流管理UI/UX设计

**文档优化内容（2026-01-14）**：
- ✅ 更新业务域服务标记（从"空壳"改为"工作流管理"）
- ✅ 补充服务间通信机制（同步通信、异步通信、服务发现）
- ✅ 补充分布式事务方案（Saga模式，无需额外部署）
- ✅ 补充灾备方案（数据库备份、高可用、数据恢复）
- ✅ 补充API版本管理（URL版本、Header版本、版本兼容）
- ✅ 补充前端性能优化策略（代码优化、资源优化、缓存优化、渲染优化、网络优化）
- ✅ 补充索引优化策略（索引设计原则、索引类型选择、索引维护）
- ✅ 补充分库分表方案（按租户分库、按时间分表、按数据量分表）
- ✅ 补充自动化测试流程（CI/CD集成、测试报告生成、测试趋势分析）
- ✅ 补充容量规划（服务器配置、扩容策略、成本估算）
- ✅ 补充安全审计流程（身份认证审计、权限管理审计、数据访问审计、操作日志审计）
- ✅ 补充性能测试基准（测试场景、测试数据、测试工具、测试报告）

### 文档特点
- 所有文档使用标准Markdown格式
- 所有文档包含Mermaid图表（架构图、流程图、ER图等）
- 所有文档包含相关链接和注意事项
- 所有文档包含代码示例和配置说明
- 所有文档已移动到doc文件夹，结构更加清晰

---

## 前端设计说明

### 设计理念
- **风格定位**: 现代科技感 + 专业精致
- **核心特征**: 深色主题、玻璃态设计（Glassmorphism）、精致的渐变和光效、流畅的动画过渡、不对称的现代布局

### 色彩系统
- **主色调**: 深蓝黑背景（#0a0e17）、霓虹蓝强调（#00d4ff）、霓虹青强调（#00ff9d）
- **渐变系统**: 使用多种渐变效果增强视觉层次

### 字体系统
- **标题字体**: Orbitron（科技感显示字体）
- **正文字体**: Plus Jakarta Sans（现代几何字体）
- **等宽字体**: JetBrains Mono（代码显示）

### 布局结构
- **侧边栏**: 固定宽度260px，玻璃态效果
- **主内容区**: 不对称布局，卡片式设计
- **顶部导航**: 简洁的面包屑、搜索栏、用户操作菜单

详细的前端UI/UX设计方案请参考 `doc/frontend-design.md`

---

## 开发规范

### 代码规范
- **Python**: 遵循PEP 8规范
- **TypeScript**: 遵循ESLint + Prettier规范
- **命名规范**:
  - 变量/函数: snake_case（Python）、camelCase（TypeScript）
  - 类: PascalCase
  - 常量: UPPER_CASE
  - 文件: kebab-case

### Git规范
- **分支策略**: Git Flow（master/develop/feature/hotfix）
- **提交规范**: Conventional Commits（feat/fix/docs/style/refactor/test/chore）
- **代码审查**: 所有PR必须经过至少1人审查

### 注释规范
- **Python**: 使用docstring（Google风格）
- **TypeScript**: 使用JSDoc风格
- **注释原则**: 解释"为什么"而不是"是什么"

---

## 部署架构

### 开发环境
- **部署方式**: 单机部署
- **组件**: MySQL（单实例）、所有微服务（单实例）
- **配置**: 最小化配置，仅核心必须服务

### 测试环境
- **部署方式**: 容器化部署
- **组件**: MySQL（主从）、Redis、RabbitMQ、Nacos、所有微服务（多实例）
- **配置**: 标准配置，包含核心可选服务

### 生产环境
- **部署方式**: Kubernetes集群部署
- **组件**: MySQL（主从+读写分离）、Redis（集群）、RabbitMQ（集群）、Nacos（集群）、所有微服务（多实例+自动扩缩容）
- **配置**: 完整配置，包含所有监控和服务

---

## 待办任务管理功能（2026-01-14新增）

### 功能定位
- **所属服务**: 支撑域服务（8005）
- **功能类型**: P1重要功能
- **核心目标**: 提供个人待办任务和每日计划管理，提升工作效率

### 核心功能
1. **个人待办任务**：
   - 创建、编辑、删除待办任务
   - 标记完成、取消完成
   - 设置优先级（高/中/低）
   - 设置截止时间
   - 添加标签、附件
   - 任务搜索、筛选、排序

2. **每日计划**：
   - 创建每日计划
   - 查看今日计划
   - 完成每日计划任务
   - 每日计划统计（完成率）
   - 每日计划历史记录

3. **任务提醒**：
   - 任务到期提醒
   - 任务超时提醒
   - 每日计划提醒
   - 通知推送（站内信、邮件）

4. **首页看板集成**：
   - 待办任务列表（排第一，最显眼位置）
   - 显示当前用户的待办任务（前5条）
   - 包含任务名称、任务类型、优先级、截止时间
   - 支持点击快速处理任务

### 待办任务类型
- **个人待办**: 用户自己创建的个人任务
- **每日计划**: 用户制定的每日计划任务
- **工作流待办**: 工作流审批任务（由工作流系统生成）

---

## 工作流管理功能（2026-01-14新增）

### 功能定位
- **所属服务**: 业务域服务（8006）
- **功能类型**: P1重要功能
- **核心目标**: 提供传统审批流程管理，支持可视化设计和流程监控

### 核心功能
1. **预置审批模板**：
   - 人事审批（请假、加班、离职）
   - 权限审批（权限开放、数据访问、API调用）
   - 财务审批（报销、预算、采购）
   - IT审批（资源、账号、网络）

2. **可视化设计器**：
   - 拖拽式节点编辑
   - 流程图展示
   - 节点配置（开始、结束、表单、审批、条件、并行、动作、等待、循环、MCP工具、子流程）
   - 节点连接线配置
   - 流程图保存和加载

3. **审批流程配置**：
   - 支持单人审批
   - 支持多人审批（会签/或签）
   - 支持条件分支
   - 支持并行节点
   - 支持审批操作（同意、驳回、转交）

4. **审批任务管理**：
   - 待办审批任务列表
   - 已办审批任务列表
   - 抄送任务列表
   - 审批任务详情查看
   - 审批任务处理（同意、驳回、转交）
   - 审批评论

5. **流程监控**：
   - 实时监控工作流状态
   - 节点进度展示（流程图高亮）
   - 执行日志记录
   - 异常处理和重试
   - 工作流历史记录

6. **首页看板集成**：
   - 工作流统计卡片（排第二）
   - 运行中工作流数量
   - 已完成工作流（今日）
   - 待处理审批任务数量
   - 异常工作流数量

### 设计特点
- **美观的页面设计**: 玻璃态、渐变、流畅动画
- **美观的图标系统**: Iconify + Element Plus Icons
- **展示当前节点**: 流程图高亮、进度条、脉冲动画
- **传统审批优先**: 支持常见的审批场景（请假、权限开放等）

---

## 配置降级方案

所有核心可选服务都有降级方案，未配置时系统仍可正常运行：

| 功能模块 | 配置参数 | 默认值 | 降级方案 |
|---------|---------|-------|---------|
| 配置中心 | USE_NACOS | False | 使用本地`.env`配置文件 |
| 消息队列 | USE_RABBITMQ | False | 同步执行，无异步 |
| API网关 | USE_APISIX | False | 直连后端服务 |
| 限流熔断 | USE_SENTINEL | False | 无限流保护 |
| 分布式追踪 | USE_JAEGER | False | 使用本地日志 |
| 监控系统 | USE_MONITORING | False | 无监控数据 |
| 缓存服务 | CACHE_ENABLED | False | 无缓存 |
| 缓存类型 | CACHE_TYPE | local | 本地缓存（`redis`时需配置Redis） |

---

## 项目里程碑

### 已完成
- ✅ 需求分析（2026-01-13）
- ✅ 技术架构设计（2026-01-13）
- ✅ 数据库设计（2026-01-13）
- ✅ API接口设计（2026-01-13）
- ✅ 前端架构设计（2026-01-13）
- ✅ 所有文档生成（2026-01-13）
- ✅ 文档优化补充（2026-01-14）
- ✅ 文档结构整理（2026-01-14）
- ✅ 共享代码库开发（2026-01-15）
- ✅ 认证域服务开发（auth-service, 8001）（2026-01-15）
- ✅ 用户域服务开发（user-service, 8002）（2026-01-15）
- ✅ 权限域服务开发（permission-service, 8003）（2026-01-15）
- ✅ 系统域服务开发（system-service, 8004）（2026-01-15）
- ✅ 支撑域服务开发（support-service, 8005）（2026-01-15）
- ✅ 业务域服务开发（business-service, 8006）（2026-01-15）
- ✅ 数据库迁移脚本创建（2026-01-15）
- ✅ 后端单元测试开发（2026-01-15）
- ✅ 后端单元测试修复（2026-01-16）
- ✅ API接口完善（system-service, support-service, business-service）（2026-01-16）
- ✅ 后端单元测试全部通过（100%）（2026-01-16）
- ✅ 模型架构优化（删除重复模型定义，统一使用common.database.models）（2026-01-18）
- ✅ SQLAlchemy表重定义问题修复（2026-01-18）
- ✅ 数据库重新初始化（30个表创建成功）（2026-01-18）
- ✅ 测试数据重新初始化（默认租户、管理员用户、角色、权限、菜单）（2026-01-18）
- ✅ 后端集成测试全部通过（100%，23/23）（2026-01-18）
- ✅ 所有服务正常运行（auth:28001, user:28002, permission:28003, system:28004, support:28005, business:28006）（2026-01-18）

### 待完成
- ⏳ 前端开发
- ⏳ 部署上线

---

## Git仓库信息

- **远程仓库**: https://github.com/klpk961224/mcp-platform.git
- **当前分支**: M IFLOW.md
- **Git版本**: 2.52.0.windows.1

---

## 环境信息

- **操作系统**: Windows 10 (10.0.26200)
- **Python版本**: 3.13.5
- **Node.js版本**: 未安装
- **Docker版本**: 4.55.0
- **Git版本**: 2.52.0.windows.1

---

## 开发指南

### 开始开发前
1. 阅读 `doc/1-项目启动文档.md` 了解项目背景和目标
2. 阅读 `doc/2-技术架构设计文档.md` 了解系统架构
3. 阅读 `doc/6-开发规范文档.md` 了解开发规范
4. 阅读 `doc/7-环境配置文档.md` 了解环境配置

### 后端开发
1. 阅读 `doc/3-数据库设计文档.md` 了解数据库设计
2. 阅读 `doc/4-API接口设计文档.md` 了解API规范
3. 阅读 `doc/11-安全文档.md` 了解安全要求
4. 按照 `doc/6-开发规范文档.md` 进行开发

### 前端开发
1. 阅读 `doc/5-前端架构设计文档.md` 了解前端架构
2. 阅读 `doc/frontend-design.md` 了解UI/UX设计
3. 阅读 `doc/12-性能优化文档.md` 了解性能优化
4. 按照 `doc/6-开发规范文档.md` 进行开发

### 部署运维
1. 阅读 `doc/8-部署文档.md` 了解部署方案
2. 阅读 `doc/10-运维文档.md` 了解运维方案
3. 阅读 `doc/11-安全文档.md` 了解安全配置
4. 阅读 `doc/12-性能优化文档.md` 了解性能优化

### 测试
1. 阅读 `doc/9-测试文档.md` 了解测试策略
2. 按照 `doc/9-测试文档.md` 进行测试

---

## 常见操作

### 查看项目文档
```bash
# 查看项目启动文档
cat doc/1-项目启动文档.md

# 查看技术架构设计文档
cat doc/2-技术架构设计文档.md

# 查看其他文档...
```

### 查看外部服务配置
```bash
# 查看外部服务需求清单
cat doc/0-外部软件服务需求清单.md
```

---

## 注意事项

1. **文档已整理**: 所有核心文档已移动到doc文件夹，结构更加清晰
2. **文档已完善**: 所有文档已于2026-01-14完成优化和补充，2026-01-18完成文档优化
3. **后端开发完成**: 所有后端微服务已完成开发并通过单元测试和集成测试（100%通过率）
4. **环境配置完善**: 所有Docker配置文件已完善，支持完整的6个微服务部署
5. **技术栈已确定**: 后端使用FastAPI，前端使用Vue 3，不要随意更改
6. **微服务架构已设计**: 6个后端服务 + 1个前端应用
7. **外部服务有降级方案**: 所有核心可选服务都有降级方案，未配置时系统仍可正常运行
- **Saga模式无需额外部署**: 分布式事务使用Saga模式，只需Python代码实现
- **灾备方案完善**: 包含数据库备份、高可用、数据恢复方案
8. **遵循开发规范**: 开发时必须遵循 `doc/6-开发规范文档.md` 中的规范
9. **使用Mermaid图表**: 文档中的图表使用Mermaid语法，需要支持Mermaid的Markdown查看器
10. **性能优化全面**: 包含前端性能优化、性能测试基准、容量规划等
11. **文档索引**: 使用 `文档索引.md` 快速查找需要更新的文档

---

## 相关链接

- [GitHub仓库](https://github.com/klpk961224/mcp-platform.git)
- [开发进度确认单](./开发进度确认单.md)
- [文档索引](./文档索引.md)
- [项目启动文档](./doc/1-项目启动文档.md)
- [技术架构设计文档](./doc/2-技术架构设计文档.md)
- [数据库设计文档](./doc/3-数据库设计文档.md)
- [API接口设计文档](./doc/4-API接口设计文档.md)
- [前端架构设计文档](./doc/5-前端架构设计文档.md)
- [开发规范文档](./doc/6-开发规范文档.md)
- [环境配置文档](./doc/7-环境配置文档.md)
- [部署文档](./doc/8-部署文档.md)
- [测试文档](./doc/9-测试文档.md)
- [运维文档](./doc/10-运维文档.md)
- [安全文档](./doc/11-安全文档.md)
- [性能优化文档](./doc/12-性能优化文档.md)
- [任务清单](./doc/任务清单.md)
- [外部软件服务需求清单](./doc/0-外部软件服务需求清单.md)
- [前端UI/UX设计方案](./doc/frontend-design.md)

---

**最后更新**: 2026-01-18
**文档版本**: v1.4
**项目状态**: 后端开发和测试完成（100%），环境配置完善完成（100%），准备开始前端开发