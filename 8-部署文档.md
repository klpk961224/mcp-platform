# éƒ¨ç½²æ–‡æ¡£

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

- **é¡¹ç›®åç§°**ï¼šä¼ä¸šçº§AIç»¼åˆç®¡ç†å¹³å°
- **æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
- **åˆ›å»ºæ—¥æœŸ**ï¼š2026-01-13
- **æ–‡æ¡£ç±»å‹**ï¼šéƒ¨ç½²æ–‡æ¡£

---

## 1. Dockeréƒ¨ç½²æ–¹æ¡ˆ

### 1.1 åç«¯Dockerfile

```dockerfile
# åç«¯Dockerfile
FROM python:3.13-slim

WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY requirements.txt .

# å®‰è£…Pythonä¾èµ–
RUN pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY . .

# æš´éœ²ç«¯å£
EXPOSE 8000

# å¯åŠ¨å‘½ä»¤
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

### 1.2 å‰ç«¯Dockerfile

```dockerfile
# å‰ç«¯Dockerfileï¼ˆå¤šé˜¶æ®µæ„å»ºï¼‰
FROM node:18-alpine AS builder

WORKDIR /app

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY package*.json ./

# å®‰è£…ä¾èµ–
RUN npm ci

# å¤åˆ¶æºä»£ç 
COPY . .

# æ„å»º
RUN npm run build

# ç”Ÿäº§é•œåƒ
FROM nginx:alpine

# å¤åˆ¶æ„å»ºäº§ç‰©
COPY --from=builder /app/dist /usr/share/nginx/html

# å¤åˆ¶nginxé…ç½®
COPY nginx.conf /etc/nginx/conf.d/default.conf

# æš´éœ²ç«¯å£
EXPOSE 80

# å¯åŠ¨nginx
CMD ["nginx", "-g", "daemon off;"]
```

### 1.3 docker-compose.yml

```yaml
version: '3.8'

services:
  # MySQLæ•°æ®åº“
  mysql:
    image: mysql:8.0
    container_name: mcp-mysql
    environment:
      MYSQL_ROOT_PASSWORD: 12345678
      MYSQL_DATABASE: mcp_platform
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - mcp-network

  # Redisç¼“å­˜
  redis:
    image: redis:7.0
    container_name: mcp-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - mcp-network

  # Nacosé…ç½®ä¸­å¿ƒ
  nacos:
    image: nacos/nacos-server:v2.2.0
    container_name: mcp-nacos
    environment:
      MODE: standalone
    ports:
      - "8848:8848"
      - "9848:9848"
    networks:
      - mcp-network

  # RabbitMQæ¶ˆæ¯é˜Ÿåˆ—
  rabbitmq:
    image: rabbitmq:3.12-management
    container_name: mcp-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin123
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - mcp-network

  # å‰ç«¯æœåŠ¡
  frontend:
    build: ./frontend
    container_name: mcp-frontend
    ports:
      - "3000:80"
    depends_on:
      - apisix
    networks:
      - mcp-network

  # APISIXç½‘å…³
  apisix:
    image: apache/apisix:3.5.0-debian
    container_name: mcp-apisix
    ports:
      - "9080:9080"
      - "9443:9443"
      - "9180:9180"
    volumes:
      - ./apisix/config.yaml:/usr/local/apisix/conf/config.yaml:ro
    depends_on:
      - etcd
    networks:
      - mcp-network

  # etcdï¼ˆAPISIXä¾èµ–ï¼‰
  etcd:
    image: bitnami/etcd:3.5
    container_name: mcp-etcd
    environment:
      - ALLOW_NONE_AUTHENTICATION=yes
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd:2379
    ports:
      - "2379:2379"
    networks:
      - mcp-network

  # è®¤è¯åŸŸæœåŠ¡
  auth-service:
    build: ./services/auth-service
    container_name: mcp-auth-service
    ports:
      - "8001:8001"
    environment:
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_NAME=mcp_platform
      - DB_USER=root
      - DB_PASSWORD=12345678
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - NACOS_HOST=nacos
      - NACOS_PORT=8848
      - USE_NACOS=False
    depends_on:
      - mysql
      - redis
      - nacos
    networks:
      - mcp-network

  # ç”¨æˆ·åŸŸæœåŠ¡
  user-service:
    build: ./services/user-service
    container_name: mcp-user-service
    ports:
      - "8002:8002"
    environment:
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_NAME=mcp_platform
      - DB_USER=root
      - DB_PASSWORD=12345678
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - NACOS_HOST=nacos
      - NACOS_PORT=8848
      - USE_NACOS=False
    depends_on:
      - mysql
      - redis
      - nacos
    networks:
      - mcp-network

  # æƒé™åŸŸæœåŠ¡
  permission-service:
    build: ./services/permission-service
    container_name: mcp-permission-service
    ports:
      - "8003:8003"
    environment:
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_NAME=mcp_platform
      - DB_USER=root
      - DB_PASSWORD=12345678
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - NACOS_HOST=nacos
      - NACOS_PORT=8848
      - USE_NACOS=False
    depends_on:
      - mysql
      - redis
      - nacos
    networks:
      - mcp-network

  # ç³»ç»ŸåŸŸæœåŠ¡
  system-service:
    build: ./services/system-service
    container_name: mcp-system-service
    ports:
      - "8004:8004"
    environment:
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_NAME=mcp_platform
      - DB_USER=root
      - DB_PASSWORD=12345678
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - NACOS_HOST=nacos
      - NACOS_PORT=8848
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USERNAME=admin
      - RABBITMQ_PASSWORD=admin123
      - USE_NACOS=False
      - USE_RABBITMQ=False
    depends_on:
      - mysql
      - redis
      - nacos
      - rabbitmq
    networks:
      - mcp-network

  # æ”¯æ’‘åŸŸæœåŠ¡
  support-service:
    build: ./services/support-service
    container_name: mcp-support-service
    ports:
      - "8005:8005"
    environment:
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_NAME=mcp_platform
      - DB_USER=root
      - DB_PASSWORD=12345678
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - NACOS_HOST=nacos
      - NACOS_PORT=8848
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USERNAME=admin
      - RABBITMQ_PASSWORD=admin123
      - USE_NACOS=False
      - USE_RABBITMQ=False
    depends_on:
      - mysql
      - redis
      - nacos
      - rabbitmq
    networks:
      - mcp-network

  # ä¸šåŠ¡åŸŸæœåŠ¡ï¼ˆç©ºå£³ï¼‰
  business-service:
    build: ./services/business-service
    container_name: mcp-business-service
    ports:
      - "8006:8006"
    environment:
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_NAME=mcp_platform
      - DB_USER=root
      - DB_PASSWORD=12345678
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - NACOS_HOST=nacos
      - NACOS_PORT=8848
      - USE_NACOS=False
    depends_on:
      - mysql
      - redis
      - nacos
    networks:
      - mcp-network

volumes:
  mysql-data:
  redis-data:

networks:
  mcp-network:
    driver: bridge
```
      - NACOS_PORT=8848
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
    depends_on:
      - mysql
      - redis
      - nacos
      - rabbitmq
    networks:
      - mcp-network

  # å‰ç«¯æœåŠ¡
  frontend:
    build: ./frontend
    container_name: mcp-frontend
    ports:
      - "80:80"
    depends_on:
      - backend
    networks:
      - mcp-network

volumes:
  mysql-data:
  redis-data:

networks:
  mcp-network:
    driver: bridge
```

### 1.4 éƒ¨ç½²æµç¨‹å›¾

```mermaid
graph LR
    A[ç¼–å†™Dockerfile] --> B[ç¼–å†™docker-compose.yml]
    B --> C[æ„å»ºé•œåƒ]
    C --> D[å¯åŠ¨å®¹å™¨]
    D --> E[éªŒè¯éƒ¨ç½²]
    E --> F[é…ç½®è´Ÿè½½å‡è¡¡]
```

---

## 2. Kuberneteséƒ¨ç½²æ–¹æ¡ˆ

### 2.1 åç«¯éƒ¨ç½²é…ç½®

```yaml
# backend-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
  namespace: mcp-platform
spec:
  replicas: 3
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      containers:
      - name: backend
        image: mcp-platform/backend:latest
        ports:
        - containerPort: 8000
        env:
        - name: DB_HOST
          valueFrom:
            configMapKeyRef:
              name: backend-config
              key: DB_HOST
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: backend-secret
              key: DB_PASSWORD
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 8000
          initialDelaySeconds: 10
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: backend-service
  namespace: mcp-platform
spec:
  selector:
    app: backend
  ports:
  - port: 80
    targetPort: 8000
  type: ClusterIP
```

### 2.2 å‰ç«¯éƒ¨ç½²é…ç½®

```yaml
# frontend-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
  namespace: mcp-platform
spec:
  replicas: 2
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      containers:
      - name: frontend
        image: mcp-platform/frontend:latest
        ports:
        - containerPort: 80
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
---
apiVersion: v1
kind: Service
metadata:
  name: frontend-service
  namespace: mcp-platform
spec:
  selector:
    app: frontend
  ports:
  - port: 80
    targetPort: 80
  type: ClusterIP
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: mcp-ingress
  namespace: mcp-platform
spec:
  rules:
  - host: mcp.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: frontend-service
            port:
              number: 80
```

---

## 3. éƒ¨ç½²æµç¨‹è¯´æ˜

### 3.1 Dockeréƒ¨ç½²æµç¨‹

```bash
# 1. æ„å»ºé•œåƒ
docker-compose build

# 2. å¯åŠ¨æœåŠ¡
docker-compose up -d

# 3. æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f

# 4. åœæ­¢æœåŠ¡
docker-compose down
```

### 3.2 Kuberneteséƒ¨ç½²æµç¨‹

```bash
# 1. åˆ›å»ºå‘½åç©ºé—´
kubectl create namespace mcp-platform

# 2. åˆ›å»ºConfigMap
kubectl apply -f k8s/configmap.yaml

# 3. åˆ›å»ºSecret
kubectl apply -f k8s/secret.yaml

# 4. éƒ¨ç½²åº”ç”¨
kubectl apply -f k8s/

# 5. æŸ¥çœ‹çŠ¶æ€
kubectl get pods -n mcp-platform

# 6. æŸ¥çœ‹æœåŠ¡
kubectl get svc -n mcp-platform

# 7. æŸ¥çœ‹æ—¥å¿—
kubectl logs -f deployment/backend -n mcp-platform
```

---

## 4. éƒ¨ç½²è„šæœ¬ç¤ºä¾‹

### 4.1 ä¸€é”®éƒ¨ç½²è„šæœ¬

```bash
#!/bin/bash

# deploy.sh

echo "å¼€å§‹éƒ¨ç½²ä¼ä¸šçº§AIç»¼åˆç®¡ç†å¹³å°..."

# æ£€æŸ¥Dockeræ˜¯å¦å®‰è£…
if ! command -v docker &> /dev/null; then
    echo "Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker"
    exit 1
fi

# æ£€æŸ¥docker-composeæ˜¯å¦å®‰è£…
if ! command -v docker-compose &> /dev/null; then
    echo "docker-composeæœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…docker-compose"
    exit 1
fi

# æ„å»ºé•œåƒ
echo "æ„å»ºDockeré•œåƒ..."
docker-compose build

# å¯åŠ¨æœåŠ¡
echo "å¯åŠ¨æœåŠ¡..."
docker-compose up -d

# ç­‰å¾…æœåŠ¡å¯åŠ¨
echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
sleep 10

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
echo "æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
docker-compose ps

echo "éƒ¨ç½²å®Œæˆï¼"
echo "è®¿é—®åœ°å€ï¼š"
echo "  å‰ç«¯ï¼šhttp://localhost"
echo "  åç«¯ï¼šhttp://localhost:8000"
```

---

## 5. å¥åº·æ£€æŸ¥é…ç½®

### 5.1 åç«¯å¥åº·æ£€æŸ¥

```python
# main.py
from fastapi import FastAPI

app = FastAPI()

@app.get("/health")
async def health_check():
    """å¥åº·æ£€æŸ¥æ¥å£"""
    return {
        "status": "healthy",
        "service": "mcp-platform-backend",
        "version": "1.0.0"
    }

@app.get("/ready")
async def readiness_check():
    """å°±ç»ªæ£€æŸ¥æ¥å£"""
    # æ£€æŸ¥æ•°æ®åº“è¿æ¥
    # æ£€æŸ¥Redisè¿æ¥
    # æ£€æŸ¥RabbitMQè¿æ¥
    return {
        "status": "ready",
        "checks": {
            "database": "ok",
            "redis": "ok",
            "rabbitmq": "ok"
        }
    }
```

---

## 6. å›æ»šç­–ç•¥

### 6.1 Dockerå›æ»š

```bash
# æŸ¥çœ‹é•œåƒç‰ˆæœ¬
docker images | grep mcp-platform

# å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
docker-compose down
docker-compose up -d --scale backend=2 --scale frontend=2

# ä½¿ç”¨æŒ‡å®šç‰ˆæœ¬
docker tag mcp-platform/backend:v1.0.1 mcp-platform/backend:latest
docker-compose up -d
```

### 6.2 Kuberneteså›æ»š

```bash
# æŸ¥çœ‹éƒ¨ç½²å†å²
kubectl rollout history deployment/backend -n mcp-platform

# å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
kubectl rollout undo deployment/backend -n mcp-platform

# å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
kubectl rollout undo deployment/backend --to-revision=2 -n mcp-platform
```

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [ç¯å¢ƒé…ç½®æ–‡æ¡£](./7-ç¯å¢ƒé…ç½®æ–‡æ¡£.md)
- [è¿ç»´æ–‡æ¡£](./10-è¿ç»´æ–‡æ¡£.md)
- [å¤–éƒ¨è½¯ä»¶æœåŠ¡éœ€æ±‚æ¸…å•](./0-å¤–éƒ¨è½¯ä»¶æœåŠ¡éœ€æ±‚æ¸…å•.md)

---

## ğŸ’¡ æ³¨æ„äº‹é¡¹

1. **é•œåƒç®¡ç†**ï¼šä½¿ç”¨é•œåƒç‰ˆæœ¬æ ‡ç­¾ï¼Œé¿å…ä½¿ç”¨latestæ ‡ç­¾
2. **èµ„æºé™åˆ¶**ï¼šåˆç†è®¾ç½®èµ„æºé™åˆ¶ï¼Œé¿å…èµ„æºè€—å°½
3. **å¥åº·æ£€æŸ¥**ï¼šé…ç½®å¥åº·æ£€æŸ¥ï¼Œè‡ªåŠ¨é‡å¯å¼‚å¸¸å®¹å™¨
4. **æ—¥å¿—æ”¶é›†**ï¼šé…ç½®æ—¥å¿—æ”¶é›†ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥
5. **å¤‡ä»½ç­–ç•¥**ï¼šå®šæœŸå¤‡ä»½æ•°æ®å’Œé…ç½®

---

**æ–‡æ¡£ç‰ˆæœ¬å†å²**ï¼š

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | å˜æ›´è¯´æ˜ |
|-----|------|------|---------|
| v1.0 | 2026-01-13 | AIåŠ©æ‰‹ | åˆå§‹ç‰ˆæœ¬ |

---